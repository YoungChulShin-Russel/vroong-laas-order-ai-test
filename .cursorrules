---
alwaysApply: true
---
## ğŸ“‹ ì‘ì—… íë¦„

### 1ë‹¨ê³„: ìš”êµ¬ì‚¬í•­ ë¶„ì„ ë° ê³„íš ìˆ˜ë¦½

ì‚¬ìš©ìì˜ ìš”ì²­ì„ ë°›ìœ¼ë©´:

1. **ìš”êµ¬ì‚¬í•­ íŒŒì•…**
   - ë¬´ì—‡ì„ ë§Œë“¤ì–´ì•¼ í•˜ëŠ”ê°€?
   - ì–´ë–¤ íŒŒì¼ë“¤ì´ í•„ìš”í•œê°€?
   - ê¸°ì¡´ ì½”ë“œì— ì˜í–¥ì€?

2. **ì‘ì—… ê³„íš ê³µìœ **
   ```
   ë‹¤ìŒê³¼ ê°™ì´ ì‘ì—…í•˜ê² ìŠµë‹ˆë‹¤:
   
   ğŸ“ ìƒì„±í•  íŒŒì¼:
   - core/domain/{aggregate}/{Aggregate}.java
   - core/application/{aggregate}/{Aggregate}Facade.java
   
   ğŸ“ ìˆ˜ì •í•  íŒŒì¼:
   - infrastructure/storage/db/{aggregate}/{Aggregate}Entity.java (ë§¤í•‘ ì¶”ê°€)
   
   ğŸ”§ ì‘ì—… ë‚´ìš©:
   - {Aggregate} Domain Entity ìƒì„± (í•µì‹¬ í•„ë“œ í¬í•¨)
   - {Aggregate} Facade êµ¬í˜„
   - JPA Entity ë§¤í•‘
   
   ì§„í–‰í• ê¹Œìš”?
   ```
   
   **ì˜ˆì‹œ (Order):**
   ```
   ğŸ“ ìƒì„±í•  íŒŒì¼:
   - core/domain/order/Order.java
   - core/application/order/OrderFacade.java
   
   ğŸ”§ ì‘ì—… ë‚´ìš©:
   - Order Domain Entity ìƒì„± (ìƒíƒœ, ê¸ˆì•¡, ë°°ì†¡ì§€ í¬í•¨)
   ```

3. **ì‚¬ìš©ì í™•ì¸ ëŒ€ê¸°**
   - ì‚¬ìš©ìê°€ "ì¢‹ì•„ìš”", "ë„¤", "ì§„í–‰í•´ì£¼ì„¸ìš”" ë“±ìœ¼ë¡œ ì‘ë‹µí•˜ë©´ ì‹œì‘
   - ì‚¬ìš©ìê°€ ìˆ˜ì • ìš”ì²­í•˜ë©´ ê³„íš ì¡°ì •

---

### 2ë‹¨ê³„: ì½”ë“œ ì‘ì„±/ìˆ˜ì •

1. **íŒŒì¼ ë‹¨ìœ„ë¡œ ì‘ì—…**
   - í•œ ë²ˆì— í•˜ë‚˜ì”© ë˜ëŠ” ê´€ë ¨ëœ íŒŒì¼ë“¤ì„ ë¬¶ì–´ì„œ
   - ë„ˆë¬´ ë§ì€ íŒŒì¼ì„ ë™ì‹œì— ìˆ˜ì •í•˜ì§€ ë§ ê²ƒ (ìµœëŒ€ 5ê°œ ì •ë„)

2. **ì‘ì—… ìˆœì„œ**
   - Domain â†’ Application â†’ Infrastructure â†’ Interface ìˆœì„œ ê¶Œì¥
   - ì˜ì¡´ì„± ë°©í–¥ì„ ê³ ë ¤

3. **ì§„í–‰ ìƒí™© ì•Œë¦¼**
   ```
   1/3 {Aggregate} Domain Entity ìƒì„± ì¤‘...
   2/3 {Aggregate}Facade êµ¬í˜„ ì¤‘...
   3/3 {Aggregate}Controller ì¶”ê°€ ì¤‘...
   ```
   
   **ì˜ˆì‹œ (Order):**
   ```
   1/3 Order Domain Entity ìƒì„± ì¤‘...
   2/3 OrderFacade êµ¬í˜„ ì¤‘...
   3/3 OrderController ì¶”ê°€ ì¤‘...
   ```

---

### 3ë‹¨ê³„: ê²°ê³¼ í™•ì¸ ë° ë³´ê³ 

1. **ìˆ˜ì • ë‚´ìš© ìš”ì•½**
   ```
   âœ… ì‘ì—… ì™„ë£Œ:
   
   ğŸ“„ ìƒì„±ëœ íŒŒì¼:
   - {Aggregate}.java (ë„ë©”ì¸ ì—”í‹°í‹°)
   - {Aggregate}Facade.java (Facade)
   
   ğŸ”§ ì£¼ìš” ê¸°ëŠ¥:
   - {Aggregate} ìƒì„±, ì·¨ì†Œ ê¸°ëŠ¥
   - ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
   - ìƒíƒœ ê´€ë¦¬
   ```
   
   **ì˜ˆì‹œ (Order):**
   ```
   ğŸ“„ ìƒì„±ëœ íŒŒì¼:
   - Order.java (ì£¼ë¬¸ ë„ë©”ì¸ ì—”í‹°í‹°)
   - OrderFacade.java (ì£¼ë¬¸ Facade)
   
   ğŸ”§ ì£¼ìš” ê¸°ëŠ¥:
   - ì£¼ë¬¸ ìƒì„±, ì·¨ì†Œ ê¸°ëŠ¥
   - ê¸ˆì•¡ ê³„ì‚° ë¡œì§
   - ìƒíƒœ ê´€ë¦¬ (PENDING, CONFIRMED, CANCELLED)
   ```

2. **ì—ëŸ¬ í™•ì¸**
   - ë¦°í„° ì—ëŸ¬ í™•ì¸ (`read_lints`)
   - ì—ëŸ¬ê°€ ìˆìœ¼ë©´ ì¦‰ì‹œ ìˆ˜ì •

3. **ë¬¸ì„œ ì—…ë°ì´íŠ¸** â­
   
   ì‘ì—… ë‚´ìš©ì— ë”°ë¼ ê´€ë ¨ ë¬¸ì„œë¥¼ ì—…ë°ì´íŠ¸í•´ì•¼ í•©ë‹ˆë‹¤:
   
   **ë„ë©”ì¸ ì •ì±… ë³€ê²½ ì‹œ:**
   - `ë„ë©”ì¸ì •ì±….md` ì—…ë°ì´íŠ¸
   - ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™, ìƒíƒœ ì „ì´, í•„ìˆ˜ ê°’ ë“± ë³€ê²½ì‚¬í•­ ë°˜ì˜
   - ì˜ˆì‹œ ì½”ë“œ ì—…ë°ì´íŠ¸
   
   **ìƒˆë¡œìš´ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ ì‹œ:**
   - `README.md`ì˜ "ğŸ› ï¸ ê¸°ìˆ  ìŠ¤íƒ" ì„¹ì…˜ ì—…ë°ì´íŠ¸
   - ë¼ì´ë¸ŒëŸ¬ë¦¬ ì´ë¦„, ìš©ë„, ê³µì‹ ë§í¬ ì¶”ê°€
   - ë²„ì „ ì •ë³´ í¬í•¨ (`gradle.properties` ì°¸ê³ )
   
   **ì²´í¬ë¦¬ìŠ¤íŠ¸:**
   - [ ] ë„ë©”ì¸ ê·œì¹™ì´ ë³€ê²½ë˜ì—ˆë‚˜? â†’ `ë„ë©”ì¸ì •ì±….md`
   - [ ] ìƒˆë¡œìš´ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì¶”ê°€ë˜ì—ˆë‚˜? â†’ `README.md`
   - [ ] ì•„í‚¤í…ì²˜ê°€ ë³€ê²½ë˜ì—ˆë‚˜? â†’ `documents/architecture.md`

4. **ë‹¤ìŒ ë‹¨ê³„ ì œì•ˆ**
   ```
   ë‹¤ìŒ ì‘ì—…:
   - í…ŒìŠ¤íŠ¸ ì½”ë“œ ì‘ì„±
   - API ë¬¸ì„œ ì—…ë°ì´íŠ¸
   
   ì–´ë–»ê²Œ ì§„í–‰í• ê¹Œìš”?
   ```

---

## ğŸ’¬ ì»¤ë®¤ë‹ˆì¼€ì´ì…˜ ì›ì¹™

### 1. ì–¸ì–´
- **í•œêµ­ì–´ë¡œ ëŒ€í™”**
- ê¸°ìˆ  ìš©ì–´ëŠ” ì˜ì–´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
  - âœ… "UseCaseë¥¼ ë§Œë“¤ê² ìŠµë‹ˆë‹¤"
  - âœ… "Domain Entityì— ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ì¶”ê°€í•©ë‹ˆë‹¤"
  - âŒ "ì‚¬ìš© ì‚¬ë¡€ë¥¼ ë§Œë“¤ê² ìŠµë‹ˆë‹¤" (ë²ˆì—­ X)

### 2. ì„¤ëª… ë°©ì‹
- **ê°„ê²°í•˜ê³  ëª…í™•í•˜ê²Œ**
- ë¶ˆí•„ìš”í•œ ì„¤ëª… ìµœì†Œí™”
- ì¤‘ìš”í•œ ê²°ì • ì‚¬í•­ì€ ì´ìœ ì™€ í•¨ê»˜ ì„¤ëª…

### 3. ì§ˆë¬¸í•˜ê¸°
ì˜ì‚¬ê²°ì •ì´ í•„ìš”í•œ ê²½ìš° ì‚¬ìš©ìì—ê²Œ ì§ˆë¬¸:
```
â“ ì„ íƒì´ í•„ìš”í•©ë‹ˆë‹¤:

Option 1: Repository Adapterì— @Transactional (ê°„ë‹¨)
Option 2: TransactionTemplate ì‚¬ìš© (ì„¸ë°€í•œ ì œì–´)

ì–´ë–¤ ë°©ì‹ìœ¼ë¡œ ì§„í–‰í• ê¹Œìš”?
```

---

## ğŸ”„ ë°˜ë³µ ì‘ì—… ì‹œ

ê°™ì€ íŒ¨í„´ì˜ ì‘ì—…ì„ ì—¬ëŸ¬ ë²ˆ í•´ì•¼ í•  ë•Œ:

1. **ì²« ë²ˆì§¸ëŠ” ìƒì„¸íˆ ì„¤ëª…**
   ```
   Customer Domain Entityë¥¼ ë§Œë“¤ê² ìŠµë‹ˆë‹¤:
   - ê³ ê° ID, ì´ë¦„, ì—°ë½ì²˜
   - í™œì„±/ë¹„í™œì„± ìƒíƒœ
   - ë“±ê¸‰ ê´€ë¦¬
   ```

2. **ë‘ ë²ˆì§¸ë¶€í„°ëŠ” ê°„ëµíˆ**
   ```
   ë™ì¼í•œ íŒ¨í„´ìœ¼ë¡œ Product, Coupon Entityë„ ë§Œë“¤ê² ìŠµë‹ˆë‹¤.
   ì§„í–‰í• ê¹Œìš”?
   ```

---

## âš ï¸ ì£¼ì˜ì‚¬í•­

### í•˜ì§€ ë§ì•„ì•¼ í•  ê²ƒ

âŒ **ì½”ë“œë¶€í„° ìˆ˜ì •**
- ê³„íš ì—†ì´ ë°”ë¡œ íŒŒì¼ ìˆ˜ì •

âŒ **ê³¼ë„í•œ ì„¤ëª…**
- ë„ˆë¬´ ì¥í™©í•œ ì„¤ëª…ìœ¼ë¡œ ì‹œê°„ ë‚­ë¹„

âŒ **ë…ë‹¨ì  ê²°ì •**
- ì¤‘ìš”í•œ ì•„í‚¤í…ì²˜ ê²°ì •ì„ í˜¼ì í•˜ê¸°

âŒ **ì—ëŸ¬ ë¬´ì‹œ**
- ë¦°í„° ì—ëŸ¬ë¥¼ í™•ì¸í•˜ì§€ ì•Šê³  ë„˜ì–´ê°€ê¸°

âŒ **ë¬¸ì„œ ì—…ë°ì´íŠ¸ ëˆ„ë½** â­
- ë„ë©”ì¸ ì •ì±…ì´ ë³€ê²½ë˜ì—ˆëŠ”ë° `ë„ë©”ì¸ì •ì±….md`ë¥¼ ì—…ë°ì´íŠ¸í•˜ì§€ ì•ŠìŒ
- ìƒˆ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì¶”ê°€í–ˆëŠ”ë° `README.md`ë¥¼ ì—…ë°ì´íŠ¸í•˜ì§€ ì•ŠìŒ

### í•´ì•¼ í•  ê²ƒ

âœ… **ê³„íš ë¨¼ì €**
- ë¬´ì—‡ì„ í• ì§€ ë¨¼ì € ì„¤ëª…

âœ… **í™•ì¸ ìš”ì²­**
- ì¤‘ìš”í•œ ê²°ì •ì€ ì‚¬ìš©ì í™•ì¸

âœ… **ì—ëŸ¬ ì¦‰ì‹œ ìˆ˜ì •**
- ë¦°í„° ì—ëŸ¬ ë°œìƒ ì‹œ ë°”ë¡œ ê³ ì¹˜ê¸°

âœ… **ë¬¸ì„œ ë™ê¸°í™”** â­
- ë„ë©”ì¸ ì •ì±… ë³€ê²½ ì‹œ `ë„ë©”ì¸ì •ì±….md` ì—…ë°ì´íŠ¸
- ìƒˆ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ ì‹œ `README.md` ì—…ë°ì´íŠ¸

âœ… **ì‘ì—… ë‹¨ìœ„ ì ì ˆíˆ**
- í•œ ë²ˆì— ë„ˆë¬´ ë§ì´ í•˜ì§€ ì•Šê¸°

---

## ğŸ“š ì²´í¬ë¦¬ìŠ¤íŠ¸

ë§¤ ì‘ì—…ë§ˆë‹¤ ë‹¤ìŒì„ í™•ì¸í•˜ì„¸ìš”:

- [ ] ì‘ì—… ê³„íšì„ ë¨¼ì € ê³µìœ í–ˆëŠ”ê°€?
- [ ] ì‚¬ìš©ì í™•ì¸ì„ ë°›ì•˜ëŠ”ê°€?
- [ ] íŒŒì¼ì„ ì ì ˆí•œ ìˆœì„œë¡œ ì‘ì„±í–ˆëŠ”ê°€?
- [ ] ë¦°í„° ì—ëŸ¬ë¥¼ í™•ì¸í–ˆëŠ”ê°€?
- [ ] **ë¬¸ì„œë¥¼ ì—…ë°ì´íŠ¸í–ˆëŠ”ê°€?** â­
  - [ ] ë„ë©”ì¸ ê·œì¹™ ë³€ê²½ â†’ `ë„ë©”ì¸ì •ì±….md`
  - [ ] ìƒˆ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ â†’ `README.md`
  - [ ] ì•„í‚¤í…ì²˜ ë³€ê²½ â†’ `documents/architecture.md`
- [ ] ì‘ì—… ê²°ê³¼ë¥¼ ìš”ì•½í•´ì„œ ë³´ê³ í–ˆëŠ”ê°€?
- [ ] ë‹¤ìŒ ë‹¨ê³„ë¥¼ ì œì•ˆí–ˆëŠ”ê°€?

---

## ì˜ˆì‹œ: ì „ì²´ ì‘ì—… íë¦„

### í…œí”Œë¦¿

```
[ì‚¬ìš©ì ìš”ì²­]
"{ë„ë©”ì¸} ìƒì„± ê¸°ëŠ¥ì„ ë§Œë“¤ì–´ì¤˜"

[AI ì‘ë‹µ - 1ë‹¨ê³„: ê³„íš]
ë‹¤ìŒê³¼ ê°™ì´ ì‘ì—…í•˜ê² ìŠµë‹ˆë‹¤:

ğŸ“ ìƒì„±í•  íŒŒì¼:
1. core/domain/{aggregate}/{Aggregate}.java - ë„ë©”ì¸ Entity
2. core/domain/{aggregate}/{AggregateItem}.java - Value Object (ì„ íƒ)
3. core/application/{aggregate}/{Aggregate}Facade.java - Facade
4. core/domain/{aggregate}/command/Create{Aggregate}Command.java - Command

ì£¼ìš” ê¸°ëŠ¥:
- {Aggregate} ìƒì„±
- ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
- ìƒíƒœ ê´€ë¦¬

ì§„í–‰í• ê¹Œìš”?

[ì‚¬ìš©ì í™•ì¸]
"ë„¤, ì§„í–‰í•´ì£¼ì„¸ìš”"

[AI ì‘ì—… - 2ë‹¨ê³„: ì‹¤í–‰]
1/4 {Aggregate}.java ìƒì„± ì¤‘...
2/4 {AggregateItem}.java ìƒì„± ì¤‘...
3/4 {Aggregate}Facade.java ìƒì„± ì¤‘...
4/4 Create{Aggregate}Command.java ìƒì„± ì¤‘...

[AI ë³´ê³  - 3ë‹¨ê³„: ì™„ë£Œ]
âœ… {ë„ë©”ì¸} ìƒì„± ê¸°ëŠ¥ êµ¬í˜„ ì™„ë£Œ

ğŸ“„ ìƒì„±ëœ íŒŒì¼:
- {Aggregate}.java
- {AggregateItem}.java
- {Aggregate}Facade.java
- Create{Aggregate}Command.java

ğŸ”§ ì£¼ìš” ê¸°ëŠ¥:
- {Aggregate}.create() - ìƒì„± íŒ©í† ë¦¬ ë©”ì„œë“œ
- ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
- ìƒíƒœ ê´€ë¦¬

ë‹¤ìŒ ì‘ì—…:
- Infrastructure Layer (JPA Entity, Repository Adapter)
- API Layer (Controller, Request/Response DTO)

ì–´ë–»ê²Œ ì§„í–‰í• ê¹Œìš”?
```

### ì‹¤ì œ ì˜ˆì‹œ (Order)

```
[ì‚¬ìš©ì ìš”ì²­]
"ì£¼ë¬¸ ìƒì„± ê¸°ëŠ¥ì„ ë§Œë“¤ì–´ì¤˜"

[AI ì‘ë‹µ - 1ë‹¨ê³„: ê³„íš]
ë‹¤ìŒê³¼ ê°™ì´ ì‘ì—…í•˜ê² ìŠµë‹ˆë‹¤:

ğŸ“ ìƒì„±í•  íŒŒì¼:
1. core/domain/order/Order.java - ì£¼ë¬¸ ë„ë©”ì¸ Entity
2. core/domain/order/OrderItem.java - ì£¼ë¬¸ ì•„ì´í…œ VO
3. core/application/order/OrderFacade.java - ì£¼ë¬¸ Facade
4. core/domain/order/command/CreateOrderCommand.java - Command

ì£¼ìš” ê¸°ëŠ¥:
- ì£¼ë¬¸ ìƒì„± (ê³ ê°, ìƒí’ˆ, ìˆ˜ëŸ‰, ë°°ì†¡ì§€)
- ê¸ˆì•¡ ê³„ì‚°
- ìƒíƒœ ê´€ë¦¬

ì§„í–‰í• ê¹Œìš”?

[ì‚¬ìš©ì í™•ì¸]
"ë„¤, ì§„í–‰í•´ì£¼ì„¸ìš”"

[AI ì‘ì—… - 2ë‹¨ê³„: ì‹¤í–‰]
1/4 Order.java ìƒì„± ì¤‘...
2/4 OrderItem.java ìƒì„± ì¤‘...
3/4 OrderFacade.java ìƒì„± ì¤‘...
4/4 CreateOrderCommand.java ìƒì„± ì¤‘...

[AI ë³´ê³  - 3ë‹¨ê³„: ì™„ë£Œ]
âœ… ì£¼ë¬¸ ìƒì„± ê¸°ëŠ¥ êµ¬í˜„ ì™„ë£Œ

ğŸ“„ ìƒì„±ëœ íŒŒì¼:
- Order.java (52 lines)
- OrderItem.java (28 lines)
- OrderFacade.java (20 lines)
- CreateOrderCommand.java (15 lines)

ğŸ”§ ì£¼ìš” ê¸°ëŠ¥:
- Order.create() - ì£¼ë¬¸ ìƒì„± íŒ©í† ë¦¬ ë©”ì„œë“œ
- calculateTotalAmount() - ì´ ê¸ˆì•¡ ê³„ì‚°
- ìƒíƒœ: PENDING, CONFIRMED, CANCELLED

ë‹¤ìŒ ì‘ì—…:
- Infrastructure Layer (JPA Entity, Repository Adapter)
- API Layer (Controller, Request/Response DTO)

ì–´ë–»ê²Œ ì§„í–‰í• ê¹Œìš”?
```

---

## ğŸ¨ ê³µí†µ ì½”ë“œ ìŠ¤íƒ€ì¼

### FQCN ëŒ€ì‹  import ì‚¬ìš©

**ëª¨ë“  ë ˆì´ì–´(Domain, Application, Infrastructure, Interface)ì—ì„œ ì ìš©**

#### âŒ ë‚˜ìœ ì˜ˆ - FQCN(Fully Qualified Class Name) ì‚¬ìš©
```java
public {Aggregate} toDomain(
    java.util.List<com.company.service.core.domain.{aggregate}.{AggregateItem}> items,
    com.company.service.core.domain.{aggregate}.{Property1} property1,
    com.company.service.core.domain.{aggregate}.{Property2} property2) {
  
  com.company.service.core.domain.{aggregate}.{Aggregate}Status domainStatus = 
      com.company.service.core.domain.{aggregate}.{Aggregate}Status.valueOf(this.status.name());
  
  return new {Aggregate}(...);
}
```

#### âœ… ì¢‹ì€ ì˜ˆ - import ì‚¬ìš©
```java
import java.util.List;
import com.company.service.core.domain.{aggregate}.{Aggregate};
import com.company.service.core.domain.{aggregate}.{AggregateItem};
import com.company.service.core.domain.{aggregate}.{Aggregate}Status;
import com.company.service.core.domain.{aggregate}.{Property1};
import com.company.service.core.domain.{aggregate}.{Property2};

public {Aggregate} toDomain(
    List<{AggregateItem}> items,
    {Property1} property1,
    {Property2} property2) {
  
  {Aggregate}Status domainStatus = {Aggregate}Status.valueOf(this.status.name());
  
  return new {Aggregate}(...);
}
```

**ì˜ˆì‹œ (Order):**
```java
import java.util.List;
import vroong.laas.order.core.domain.order.Order;
import vroong.laas.order.core.domain.order.OrderItem;
import vroong.laas.order.core.domain.order.OrderStatus;
import vroong.laas.order.core.domain.order.Origin;
import vroong.laas.order.core.domain.order.Destination;

public Order toDomain(
    List<OrderItem> items,
    Origin origin,
    Destination destination) {
  
  OrderStatus domainStatus = OrderStatus.valueOf(this.status.name());
  
  return new Order(...);
}
```

**ì¥ì :**
- âœ… ê°€ë…ì„± í–¥ìƒ
- âœ… ì½”ë“œ ê°„ê²°ì„±
- âœ… IDE ìë™ì™„ì„± ì§€ì›
- âœ… ë¦¬íŒ©í† ë§ ìš©ì´

**ì˜ˆì™¸ ìƒí™©:**
- ê°™ì€ ì´ë¦„ì˜ í´ë˜ìŠ¤ê°€ ì—¬ëŸ¬ íŒ¨í‚¤ì§€ì— ìˆì„ ë•Œë§Œ FQCN ì‚¬ìš© (ì˜ˆ: `OrderStatus`)
  ```java
  // Infrastructure OrderStatus vs Domain OrderStatus
  vroong.laas.order.core.domain.order.OrderStatus domainStatus = 
      vroong.laas.order.core.domain.order.OrderStatus.valueOf(this.status.name());
  ```

---

ì´ ê°€ì´ë“œë¥¼ ë”°ë¼ ì‚¬ìš©ìì™€ íš¨ìœ¨ì ìœ¼ë¡œ í˜‘ì—…í•˜ì„¸ìš”! ğŸš€
---
alwaysApply: true
---

# í”„ë¡œì íŠ¸ ê°œìš”

## ê¸°ìˆ  ìŠ¤íƒ
- Java 25
- Spring Boot 4.0.0-M3
- Spring Data JPA
- QueryDSL
- MySQL
- Kafka
- Gradle (Multi-Module)

## ëª©í‘œ
- ëŒ€ìš©ëŸ‰ íŠ¸ëœì­ì…˜ ì²˜ë¦¬ (ì¼ 30ë§Œê±´ ì´ìƒ)
- ëª…í™•í•œ ë ˆì´ì–´ ë¶„ë¦¬
- AIê°€ ì´í•´í•˜ê³  ìˆ˜ì •í•˜ê¸° ì‰¬ìš´ êµ¬ì¡°
- ë„ë©”ì¸ ì£¼ë„ ì„¤ê³„ (DDD) ì›ì¹™ ì¤€ìˆ˜

## ëª¨ë“ˆ êµ¬ì¡°

```
{service-name}/             # ì˜ˆ: order-service, payment-service, delivery-service
â”œâ”€â”€ core/                   # ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ (Spring ì˜ì¡´ì„± ìµœì†Œí™”)
â”‚   â”œâ”€â”€ domain/            # Domain Entity, Value Object, Domain Service, Command
â”‚   â””â”€â”€ application/       # Facade (íë¦„ ì¡°ì •)
â”œâ”€â”€ infrastructure/         # ê¸°ìˆ  êµ¬í˜„
â”‚   â”œâ”€â”€ storage/
â”‚   â”‚   â””â”€â”€ db/            # MySQL (JPA)
â”‚   â””â”€â”€ outbox/            # Kafka Outbox
â”œâ”€â”€ api/                    # ê³ ê°ìš© API
â”‚   â””â”€â”€ web/              # HTTP API
â”œâ”€â”€ admin/                  # ê´€ë¦¬ììš© API (ì„ íƒ)
â””â”€â”€ job/                    # Scheduled Job (Outbox Polling, í†µê³„ ì§‘ê³„, ë°ì´í„° ì •ë¦¬)
```

## ì˜ì¡´ì„± ë°©í–¥ (ì¤‘ìš”!)

í—ˆìš©: api/admin/job â†’ infrastructure â†’ core

ê¸ˆì§€: core â†’ infrastructure (ì ˆëŒ€ ì•ˆ ë¨!)

## ë ˆì´ì–´ë³„ ì±…ì„

### Domain (core/domain/)
- ëª©ì : ìˆœìˆ˜ ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™
- í—ˆìš©: Java, Lombok, Spring @Service (Domain Serviceìš©)
- ê¸ˆì§€: JPA, Infrastructure ì§ì ‘ ì˜ì¡´
- í¬í•¨:
  - Aggregate Root ({Aggregate})
  - Value Objects (ë„ë©”ì¸ íŠ¹í™” Value Objects)
  - Domain Services ({Aggregate}Creator, {Aggregate}Reader)
  - Domain Commands (Create{Aggregate}Command)
  - Domain Events ({Aggregate}CreatedEvent)
  - Ports ({Aggregate}Repository, OutboxEventClient)

**ì˜ˆì‹œ:**
- Order: Order, OrderNumber, OrderCreator, CreateOrderCommand, OrderRepository
- Payment: Payment, PaymentNumber, PaymentCreator, CreatePaymentCommand, PaymentRepository
- Delivery: Delivery, DeliveryNumber, DeliveryCreator, CreateDeliveryCommand, DeliveryRepository

### Application (core/application/)
- ëª©ì : Facade íŒ¨í„´ìœ¼ë¡œ íë¦„ ì¡°ì •
- í—ˆìš©: Domain Service, Port ì˜ì¡´
- ê¸ˆì§€: Infrastructure ì§ì ‘ ì˜ì¡´, ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì§ì ‘ êµ¬í˜„
- í¬í•¨:
  - Facade ({Aggregate}Facade)

**ì˜ˆì‹œ:**
- Order: OrderFacade
- Payment: PaymentFacade
- Delivery: DeliveryFacade

### Infrastructure (infrastructure/)
- ëª©ì : ê¸°ìˆ  êµ¬í˜„
- í—ˆìš©: JPA, Repository êµ¬í˜„, Port êµ¬í˜„
- ì±…ì„: DB, Cache, ì™¸ë¶€ API, ë©”ì‹œì§•
- í¬í•¨:
  - Repository Adapter ({Aggregate}RepositoryAdapter)
  - Outbox Client (KafkaOutboxEventClient)
  - Mapper (KafkaOutboxEventMapper)

**ì˜ˆì‹œ:**
- Order: OrderRepositoryAdapter
- Payment: PaymentRepositoryAdapter
- Delivery: DeliveryRepositoryAdapter

### Interfaces (api/, admin/)
- ëª©ì : ì™¸ë¶€ ì§„ì…ì 
- í—ˆìš©: Controller, DTO, Facade í˜¸ì¶œ
- ê¸ˆì§€: ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§, Domain Service ì§ì ‘ í˜¸ì¶œ

### Job (job/)
- ëª©ì : Scheduled Job ì‹¤í–‰
- í—ˆìš©: Domain Service í˜¸ì¶œ, @Scheduled ì‚¬ìš©
- ê¸ˆì§€: Repository ì§ì ‘ í˜¸ì¶œ, ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì§ì ‘ êµ¬í˜„
- íŒ¨í‚¤ì§€ êµ¬ì¡°:
  - scheduled/ - BaseScheduledJob (ì¸í„°í˜ì´ìŠ¤)
  - common/aspect/ - ScheduledJobLoggingAspect (AOP)
  - outbox/ - OutboxEventPublishJob
  - statistics/ - {Aggregate}StatisticsJob
  - cleanup/ - {Aggregate}CleanupJob
- ì›ì¹™: ê¸°ëŠ¥ë³„ íŒ¨í‚¤ì§€ êµ¬ì„± (outbox/, statistics/, cleanup/ ë“±)

**ì˜ˆì‹œ:**
- OrderStatisticsJob, PaymentStatisticsJob, DeliveryStatisticsJob

## ì•„í‚¤í…ì²˜ íŒ¨í„´

### 1. Facade + Domain Service íŒ¨í„´

```
Controller
  â†’ Facade (Application Layer)
    â†’ Domain Service (Domain Layer)
      â†’ Repository (Port)
        â†’ Adapter (Infrastructure Layer)
```

**íŠ¹ì§•:**
- âœ… FacadeëŠ” íë¦„ë§Œ ì¡°ì •
- âœ… Domain Serviceê°€ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ìˆ˜í–‰
- âœ… RepositoryëŠ” í†µí•© ì¸í„°í˜ì´ìŠ¤ (Store/Reader ë¶„ë¦¬ ì•ˆ í•¨)

### 2. Outbox Pattern

```
{Aggregate}Creator (Domain Service)
  1. {aggregate}Repository.store({aggregate})        â†’ Aggregate ì €ì¥ (DB)
  2. outboxEventAppender.append({aggregate})         â†’ Outbox ì €ì¥ (DB, ê°™ì€ íŠ¸ëœì­ì…˜)
     â†’ outboxEventClient.save()                      â†’ Infrastructure Layer
       â†’ KafkaOutboxEventMapper.map()                â†’ Aggregate â†’ KafkaEvent ë³€í™˜
       â†’ outboxEventService.registerEvent()          â†’ Outbox ë¼ì´ë¸ŒëŸ¬ë¦¬ í˜¸ì¶œ
```

**íŠ¹ì§•:**
- âœ… DB íŠ¸ëœì­ì…˜ê³¼ ì´ë²¤íŠ¸ ë°œí–‰ì˜ ì›ìì„± ë³´ì¥
- âœ… Aggregate ì €ì¥ + Outbox ì €ì¥ = í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜
- âœ… ë³„ë„ Workerê°€ Outbox â†’ Kafka ì „ì†¡ (ë¹„ë™ê¸°)

**ì˜ˆì‹œ:**
- OrderCreator: orderRepository.store(order) + outboxEventAppender.append(order)
- PaymentCreator: paymentRepository.store(payment) + outboxEventAppender.append(payment)

## íŒŒì¼ êµ¬ì¡° í•µì‹¬ ì›ì¹™

### Domain Layer
```
core/domain/
â”œâ”€â”€ {aggregate}/                             # ì˜ˆ: order, payment, delivery
â”‚   â”œâ”€â”€ {Aggregate}.java                     # Aggregate Root
â”‚   â”œâ”€â”€ {Aggregate}Creator.java              # Domain Service (ìƒì„±)
â”‚   â”œâ”€â”€ {Aggregate}Reader.java               # Domain Service (ì¡°íšŒ)
â”‚   â”œâ”€â”€ {AggregateItem}.java                 # Value Object (ì„ íƒ)
â”‚   â”œâ”€â”€ {Aggregate}Number.java               # Value Object
â”‚   â”œâ”€â”€ {Aggregate}Status.java               # Enum
â”‚   â”œâ”€â”€ command/
â”‚   â”‚   â””â”€â”€ Create{Aggregate}Command.java    # Domain Command
â”‚   â”œâ”€â”€ event/
â”‚   â”‚   â””â”€â”€ {Aggregate}CreatedEvent.java     # Domain Event
â”‚   â””â”€â”€ required/                            # â­ ëª¨ë“  Port
â”‚       â””â”€â”€ {Aggregate}Repository.java       # ì˜ì†ì„± Port (í†µí•©)
â”‚
â”œâ”€â”€ outbox/
â”‚   â”œâ”€â”€ OutboxEventAppender.java             # Domain Service
â”‚   â”œâ”€â”€ OutboxEventType.java                 # Enum
â”‚   â””â”€â”€ required/
â”‚       â””â”€â”€ OutboxEventClient.java           # Outbox Port
â”‚
â””â”€â”€ shared/
    â”œâ”€â”€ AggregateRoot.java                   # ì¶”ìƒ í´ë˜ìŠ¤ (Domain Event ê´€ë¦¬)
    â”œâ”€â”€ Money.java                           # Value Object (ê³µí†µ)
    â”œâ”€â”€ Weight.java                          # Value Object (ê³µí†µ)
    â””â”€â”€ event/
        â””â”€â”€ DomainEvent.java                 # Domain Event ì¸í„°í˜ì´ìŠ¤
```

**ì˜ˆì‹œ:**
- Order: order/, Order.java, OrderCreator.java, CreateOrderCommand.java
- Payment: payment/, Payment.java, PaymentCreator.java, CreatePaymentCommand.java
- Delivery: delivery/, Delivery.java, DeliveryCreator.java, CreateDeliveryCommand.java

### Application Layer
```
core/application/{aggregate}/                # ì˜ˆ: order, payment, delivery
â””â”€â”€ {Aggregate}Facade.java                   # Facade (íë¦„ ì¡°ì •)
```

**ì˜ˆì‹œ:**
- Order: application/order/OrderFacade.java
- Payment: application/payment/PaymentFacade.java
- Delivery: application/delivery/DeliveryFacade.java

### Infrastructure Layer
```
infrastructure/
â”œâ”€â”€ storage/db/{aggregate}/                      # ì˜ˆ: order, payment, delivery
â”‚   â”œâ”€â”€ adapter/
â”‚   â”‚   â””â”€â”€ {Aggregate}RepositoryAdapter.java    # Repository êµ¬í˜„
â”‚   â””â”€â”€ entity/
â”‚       â”œâ”€â”€ {Aggregate}Entity.java
â”‚       â””â”€â”€ {AggregateItem}Entity.java           # (ì„ íƒ)
â””â”€â”€ outbox/
    â”œâ”€â”€ KafkaOutboxEventClient.java              # Outbox êµ¬í˜„
    â”œâ”€â”€ KafkaOutboxEventMapper.java              # Mapper
    â””â”€â”€ KafkaOutboxEvent.java                    # DTO
```

**ì˜ˆì‹œ:**
- Order: storage/db/order/adapter/OrderRepositoryAdapter.java
- Payment: storage/db/payment/adapter/PaymentRepositoryAdapter.java
- Delivery: storage/db/delivery/adapter/DeliveryRepositoryAdapter.java

## ë¹ ë¥¸ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] Domainì— @Entity, @Table ë“± JPA ì–´ë…¸í…Œì´ì…˜ ì—†ëŠ”ê°€?
- [ ] Domain Serviceì— @Service ì• ë…¸í…Œì´ì…˜ ì‚¬ìš©í•˜ëŠ”ê°€?
- [ ] Facadeê°€ Domain Serviceë§Œ í˜¸ì¶œí•˜ëŠ”ê°€?
- [ ] Commandê°€ Domain Layerì— ìˆëŠ”ê°€?
- [ ] íŠ¸ëœì­ì…˜ì´ Repository Adapterì— ìˆëŠ”ê°€? (@Transactional)
- [ ] Outbox ì €ì¥ì´ Aggregate ì €ì¥ê³¼ ê°™ì€ íŠ¸ëœì­ì…˜ì¸ê°€?
- [ ] Controllerê°€ Facadeë§Œ í˜¸ì¶œí•˜ëŠ”ê°€?
- [ ] ëª¨ë“  ì»¤ìŠ¤í…€ Exceptionì´ BaseExceptionì„ ìƒì†ë°›ëŠ”ê°€? â­
- [ ] {Aggregate}Repositoryê°€ í†µí•© ì¸í„°í˜ì´ìŠ¤ì¸ê°€? (Store/Reader ë¶„ë¦¬ ì•ˆ í•¨)
- [ ] Jobì´ BaseScheduledJob ë˜ëŠ” LoggingScheduledJobì„ êµ¬í˜„/ìƒì†í•˜ëŠ”ê°€? â­
- [ ] 1ê°œ Job í´ë˜ìŠ¤ì— 1ê°œ @Scheduled ë©”ì„œë“œë§Œ ìˆëŠ”ê°€? â­
- [ ] Job í´ë˜ìŠ¤ ì´ë¦„ì´ *Jobìœ¼ë¡œ ëë‚˜ëŠ”ê°€? â­

## ìƒì„¸ ê·œì¹™ ë¬¸ì„œ

ë” ìƒì„¸í•œ ê·œì¹™ì€ ë‹¤ìŒ íŒŒì¼ë“¤ì„ ì°¸ê³ í•˜ì„¸ìš”:
- Domain Layer: 02-domain.md
- Application Layer: 03-application.md
- Infrastructure Layer: 04-infrastructure.md
- Interfaces Layer: 05-interfaces.md
- Validation: 06-validation.md
- Testing: 07-testing.md
- Job Layer: 08-job.md â­
---
alwaysApply: true
---

# Domain Layer ê·œì¹™

## ìœ„ì¹˜
`core/domain/`

## ì €ì¥ì†Œ êµ¬ì¡°

```
core/domain/
â”œâ”€â”€ {aggregate}/                         # ì˜ˆ: order, payment, delivery
â”‚   â”œâ”€â”€ {Aggregate}.java                 # Aggregate Root
â”‚   â”œâ”€â”€ {Aggregate}Creator.java          # Domain Service (ìƒì„±)
â”‚   â”œâ”€â”€ {Aggregate}Reader.java           # Domain Service (ì¡°íšŒ)
â”‚   â”œâ”€â”€ {AggregateItem}.java             # Value Object (ì„ íƒ)
â”‚   â”œâ”€â”€ {Aggregate}Number.java           # Value Object
â”‚   â”œâ”€â”€ {Aggregate}Status.java           # Enum
â”‚   â”œâ”€â”€ {Property1}.java                 # Value Object (ë„ë©”ì¸ íŠ¹í™”)
â”‚   â”œâ”€â”€ {Property2}.java                 # Value Object (ë„ë©”ì¸ íŠ¹í™”)
â”‚   â”œâ”€â”€ command/
â”‚   â”‚   â””â”€â”€ Create{Aggregate}Command.java  # Domain Command
â”‚   â”œâ”€â”€ event/
â”‚   â”‚   â””â”€â”€ {Aggregate}CreatedEvent.java   # Domain Event
â”‚   â”œâ”€â”€ exception/
â”‚   â”‚   â”œâ”€â”€ {Aggregate}NotFoundException.java
â”‚   â”‚   â””â”€â”€ Invalid{Aggregate}Exception.java
â”‚   â””â”€â”€ required/                        # â­ ëª¨ë“  Port
â”‚       â””â”€â”€ {Aggregate}Repository.java   # ì˜ì†ì„± Port (í†µí•©)
â”‚
â”œâ”€â”€ outbox/
â”‚   â”œâ”€â”€ OutboxEventAppender.java         # Domain Service
â”‚   â”œâ”€â”€ OutboxEventType.java             # Enum
â”‚   â””â”€â”€ required/
â”‚       â””â”€â”€ OutboxEventClient.java       # Outbox Port
â”‚
â””â”€â”€ shared/
    â”œâ”€â”€ AggregateRoot.java               # ì¶”ìƒ í´ë˜ìŠ¤ (Domain Event ê´€ë¦¬)
    â”œâ”€â”€ Money.java                       # Value Object (ê³µí†µ)
    â”œâ”€â”€ Weight.java                      # Value Object (ê³µí†µ)
    â”œâ”€â”€ Volume.java                      # Value Object (ê³µí†µ)
    â”œâ”€â”€ Address.java                     # Value Object (ê³µí†µ)
    â”œâ”€â”€ Contact.java                     # Value Object (ê³µí†µ)
    â”œâ”€â”€ LatLng.java                      # Value Object (ê³µí†µ)
    â””â”€â”€ event/
        â””â”€â”€ DomainEvent.java             # Domain Event ì¸í„°í˜ì´ìŠ¤
```

**ì˜ˆì‹œ:**
- Order: order/, Order.java, OrderCreator.java, OrderItem.java, Origin, Destination
- Payment: payment/, Payment.java, PaymentCreator.java, PaymentMethod, PaymentAmount
- Delivery: delivery/, Delivery.java, DeliveryCreator.java, DeliveryAddress, DeliveryDriver

**ì¤‘ìš”:** 
- **ëª¨ë“  PortëŠ” required/ì— ìœ„ì¹˜** (ì¼ê´€ì„±)
- **Domain ServiceëŠ” domain/{aggregate}/ ì§ì†** (OrderCreator, OrderReader)
- **CommandëŠ” domain/{aggregate}/command/ì— ìœ„ì¹˜**
- **RepositoryëŠ” í†µí•© ì¸í„°í˜ì´ìŠ¤** (Store/Reader ë¶„ë¦¬ ì•ˆ í•¨)
- Infrastructureì—ì„œ Adapterë¡œ êµ¬í˜„

## ì±…ì„
- ìˆœìˆ˜ ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™ê³¼ ë¡œì§
- í•µì‹¬ ë¶ˆë³€ì‹ ìœ ì§€
- ìê¸° ê²€ì¦
- ëª¨ë“  ì™¸ë¶€ ì˜ì¡´ì„± Port ì¸í„°í˜ì´ìŠ¤ ì •ì˜ (required/)
- Domain Serviceë¡œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ìˆ˜í–‰

## ë°˜ë“œì‹œ í•´ì•¼ í•  ê²ƒ
1. Aggregate RootëŠ” AggregateRoot ì¶”ìƒ í´ë˜ìŠ¤ ìƒì†
2. ì—”í‹°í‹° ë‚´ë¶€ì—ì„œ ìê¸° ê²€ì¦ êµ¬í˜„
3. ë¹„ì¦ˆë‹ˆìŠ¤ ê³„ì‚° ë¡œì§ í¬í•¨
4. íŒ©í† ë¦¬ ë©”ì„œë“œ ì œê³µ (create, from ë“±)
5. Domain Serviceì— @Service ì• ë…¸í…Œì´ì…˜ ì‚¬ìš©
6. Setter ì‚¬ìš© ê¸ˆì§€ (@Getterë§Œ, @Setter ê¸ˆì§€)
7. ëª¨ë“  ì™¸ë¶€ ì˜ì¡´ì„± PortëŠ” required/ì— ìœ„ì¹˜

## ì ˆëŒ€ í•˜ì§€ ë§ ê²ƒ
1. @Entity, @Table, @Column, @Id ë“± JPA ì–´ë…¸í…Œì´ì…˜ ì‚¬ìš© ê¸ˆì§€
2. Infrastructure ì˜ì¡´ ê¸ˆì§€
3. Repository êµ¬í˜„ì²´ ì˜ì¡´ ê¸ˆì§€ (ì¸í„°í˜ì´ìŠ¤ë§Œ)

---

## AggregateRoot ì¶”ìƒ í´ë˜ìŠ¤

ëª¨ë“  Aggregate RootëŠ” `AggregateRoot`ë¥¼ ìƒì†ë°›ì•„ Domain Eventë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.

```java
// core/domain/shared/AggregateRoot.java
public abstract class AggregateRoot {

  private final List<DomainEvent> domainEvents = new ArrayList<>();

  protected void addDomainEvent(DomainEvent event) {
    this.domainEvents.add(event);
  }

  public List<DomainEvent> getDomainEvents() {
    return Collections.unmodifiableList(domainEvents);
  }

  public void clearDomainEvents() {
    this.domainEvents.clear();
  }
}
```

---

## Domain Entity í…œí”Œë¦¿

### ì¼ë°˜ í…œí”Œë¦¿

```java
// core/domain/{aggregate}/{Aggregate}.java
@Getter
@ToString
public class {Aggregate} extends AggregateRoot {
    
    private final Long id;
    private final {Aggregate}Number {aggregate}Number;
    private final {Aggregate}Status status;
    private final List<{AggregateItem}> items;  // (ì„ íƒ)
    private final {Property1} property1;
    private final {Property2} property2;
    private final Instant createdAt;
    private final Instant completedAt;
    private final Instant cancelledAt;
    
    // ìƒì„±ì - í•„ìˆ˜ ê°’ ê²€ì¦
    public {Aggregate}(
        Long id,
        {Aggregate}Number {aggregate}Number,
        {Aggregate}Status status,
        List<{AggregateItem}> items,
        {Property1} property1,
        {Property2} property2,
        Instant createdAt,
        Instant completedAt,
        Instant cancelledAt
    ) {
        // í•„ìˆ˜ ê°’ ê²€ì¦
        if (id == null) {
            throw new IllegalArgumentException("IDëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤");
        }
        if ({aggregate}Number == null) {
            throw new IllegalArgumentException("{Aggregate} ë²ˆí˜¸ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤");
        }
        // ... ê¸°íƒ€ ê²€ì¦
        
        this.id = id;
        this.{aggregate}Number = {aggregate}Number;
        this.status = status;
        this.items = items != null ? List.copyOf(items) : null;
        this.property1 = property1;
        this.property2 = property2;
        this.createdAt = createdAt;
        this.completedAt = completedAt;
        this.cancelledAt = cancelledAt;
    }
    
    // íŒ©í† ë¦¬ ë©”ì„œë“œ - ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™ + Domain Event ìë™ ì¶”ê°€
    public static {Aggregate} create(
        Long id,
        {Aggregate}Number {aggregate}Number,
        List<{AggregateItem}> items,
        {Property1} property1,
        {Property2} property2
    ) {
        {Aggregate} {aggregate} = new {Aggregate}(
            id,
            {aggregate}Number,
            {Aggregate}Status.CREATED,
            items,
            property1,
            property2,
            Instant.now(),
            null,
            null
        );
        
        // Domain Event ìë™ ì¶”ê°€
        {aggregate}.addDomainEvent({Aggregate}CreatedEvent.from({aggregate}));
        
        return {aggregate};
    }
}
```

### ì‹¤ì œ ì˜ˆì‹œ (Order)

```java
// core/domain/order/Order.java
@Getter
@ToString
public class Order extends AggregateRoot {
    
    private final Long id;
    private final OrderNumber orderNumber;
    private final OrderStatus status;
    private final List<OrderItem> items;
    private final Origin origin;
    private final Destination destination;
    private final DeliveryPolicy deliveryPolicy;
    private final Instant orderedAt;
    private final Instant deliveredAt;
    private final Instant cancelledAt;
    
    // ìƒì„±ì - í•„ìˆ˜ ê°’ ê²€ì¦
    public Order(
        Long id,
        OrderNumber orderNumber,
        OrderStatus status,
        List<OrderItem> items,
        Origin origin,
        Destination destination,
        DeliveryPolicy deliveryPolicy,
        Instant orderedAt,
        Instant deliveredAt,
        Instant cancelledAt
    ) {
        // í•„ìˆ˜ ê°’ ê²€ì¦
        if (id == null) {
            throw new IllegalArgumentException("IDëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤");
        }
        if (orderNumber == null) {
            throw new IllegalArgumentException("ì£¼ë¬¸ë²ˆí˜¸ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤");
        }
        // ... ê¸°íƒ€ ê²€ì¦
        
        this.id = id;
        this.orderNumber = orderNumber;
        this.status = status;
        this.items = List.copyOf(items);
        this.origin = origin;
        this.destination = destination;
        this.deliveryPolicy = deliveryPolicy;
        this.orderedAt = orderedAt;
        this.deliveredAt = deliveredAt;
        this.cancelledAt = cancelledAt;
    }
    
    // íŒ©í† ë¦¬ ë©”ì„œë“œ - ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™ + Domain Event ìë™ ì¶”ê°€
    public static Order create(
        Long id,
        OrderNumber orderNumber,
        List<OrderItem> items,
        Origin origin,
        Destination destination,
        DeliveryPolicy deliveryPolicy
    ) {
        Order order = new Order(
            id,
            orderNumber,
            OrderStatus.CREATED,
            items,
            origin,
            destination,
            deliveryPolicy,
            Instant.now(),
            null,
            null
        );
        
        // Domain Event ìë™ ì¶”ê°€
        order.addDomainEvent(OrderCreatedEvent.from(order));
        
        return order;
    }
}
```

---

## Domain Service í…œí”Œë¦¿

### ì¼ë°˜ í…œí”Œë¦¿

#### {Aggregate}Creator (ìƒì„± ì±…ì„)

```java
// core/domain/{aggregate}/{Aggregate}Creator.java
@Service
@RequiredArgsConstructor
public class {Aggregate}Creator {

  private final {Aggregate}NumberGenerator {aggregate}NumberGenerator;
  private final {Aggregate}Repository {aggregate}Repository;
  private final OutboxEventAppender outboxEventAppender;

  @Transactional
  public {Aggregate} create(Create{Aggregate}Command command) {
    // 1. {Aggregate} ë²ˆí˜¸ ìƒì„±
    {Aggregate}Number {aggregate}Number = {aggregate}NumberGenerator.generate();

    // 2. {Aggregate} ì €ì¥ ({Aggregate}.create()ê°€ ë‚´ë¶€ì—ì„œ í˜¸ì¶œë˜ì–´ ë„ë©”ì¸ ì´ë²¤íŠ¸ ìë™ ì¶”ê°€)
    {Aggregate} {aggregate} =
        {aggregate}Repository.store(
            {aggregate}Number,
            command.items(),
            command.property1(),
            command.property2());

    // 3. ë„ë©”ì¸ ì´ë²¤íŠ¸ ë°œí–‰
    outboxEventAppender.append(OutboxEventType.{AGGREGATE}_CREATED, {aggregate});

    return {aggregate};
  }
}
```

#### {Aggregate}Reader (ì¡°íšŒ ì±…ì„)

```java
// core/domain/{aggregate}/{Aggregate}Reader.java
@Service
@RequiredArgsConstructor
public class {Aggregate}Reader {

  private final {Aggregate}Repository {aggregate}Repository;

  @ReadOnlyTransactional
  public {Aggregate} get{Aggregate}ById(Long id) {
    return {aggregate}Repository
        .findById(id)
        .orElseThrow(() -> new {Aggregate}NotFoundException(id));
  }

  @ReadOnlyTransactional
  public {Aggregate} get{Aggregate}By{Aggregate}Number({Aggregate}Number {aggregate}Number) {
    return {aggregate}Repository
        .findBy{Aggregate}Number({aggregate}Number)
        .orElseThrow(() -> new {Aggregate}NotFoundException({aggregate}Number));
  }
}
```

### ì‹¤ì œ ì˜ˆì‹œ (Order)

#### OrderCreator

```java
// core/domain/order/OrderCreator.java
@Service
@RequiredArgsConstructor
public class OrderCreator {

  private final OrderNumberGenerator orderNumberGenerator;
  private final OrderRepository orderRepository;
  private final OutboxEventAppender outboxEventAppender;

  @Transactional
  public Order create(CreateOrderCommand command) {
    // 1. ì£¼ë¬¸ë²ˆí˜¸ ìƒì„±
    OrderNumber orderNumber = orderNumberGenerator.generate();

    // 2. Order ì €ì¥ (Order.create()ê°€ ë‚´ë¶€ì—ì„œ í˜¸ì¶œë˜ì–´ ë„ë©”ì¸ ì´ë²¤íŠ¸ ìë™ ì¶”ê°€)
    Order order =
        orderRepository.store(
            orderNumber,
            command.items(),
            command.origin(),
            command.destination(),
            command.deliveryPolicy());

    // 3. ë„ë©”ì¸ ì´ë²¤íŠ¸ ë°œí–‰
    outboxEventAppender.append(OutboxEventType.ORDER_CREATED, order);

    return order;
  }
}
```

#### OrderReader

```java
// core/domain/order/OrderReader.java
@Service
@RequiredArgsConstructor
public class OrderReader {

  private final OrderRepository orderRepository;

  @ReadOnlyTransactional
  public Order getOrderById(Long id) {
    return orderRepository
        .findById(id)
        .orElseThrow(() -> new OrderNotFoundException(id));
  }

  @ReadOnlyTransactional
  public Order getOrderByOrderNumber(OrderNumber orderNumber) {
    return orderRepository
        .findByOrderNumber(orderNumber)
        .orElseThrow(() -> new OrderNotFoundException(orderNumber));
  }
}
```

**íŠ¹ì§•:**
- âœ… @Service ì• ë…¸í…Œì´ì…˜ ì‚¬ìš©
- âœ… ì±…ì„ ë¶„ë¦¬ (Creator: ìƒì„±, Reader: ì¡°íšŒ)
- âœ… ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì€ ì—¬ê¸°ì„œ ìˆ˜í–‰
- âœ… Repository Port(ì¸í„°í˜ì´ìŠ¤)ë§Œ ì˜ì¡´

---

## OrderRepository Port í…œí”Œë¦¿ (í†µí•©)

**ì¤‘ìš”:** Store/Reader ë¶„ë¦¬í•˜ì§€ ì•Šê³  **í•˜ë‚˜ì˜ Repositoryë¡œ í†µí•©**

```java
// core/domain/order/required/OrderRepository.java
public interface OrderRepository {

  /**
   * Order ìƒì„± ë° ì €ì¥
   *
   * <p>Order Entityë¥¼ ìƒì„±í•˜ê³  ì €ì¥í•œ í›„, ì™„ì „í•œ Order ëª¨ë¸(id í¬í•¨)ì„ ë°˜í™˜í•©ë‹ˆë‹¤.
   *
   * @param orderNumber ì£¼ë¬¸ë²ˆí˜¸
   * @param items ì£¼ë¬¸ ì•„ì´í…œ ëª©ë¡
   * @param origin ì¶œë°œì§€
   * @param destination ë„ì°©ì§€
   * @param deliveryPolicy ë°°ì†¡ ì •ì±…
   * @return ì €ì¥ëœ Order (id í• ë‹¹ë¨)
   */
  Order store(
      OrderNumber orderNumber,
      List<OrderItem> items,
      Origin origin,
      Destination destination,
      DeliveryPolicy deliveryPolicy);

  /**
   * IDë¡œ Order ì¡°íšŒ
   */
  Optional<Order> findById(Long id);

  /**
   * ì£¼ë¬¸ë²ˆí˜¸ë¡œ Order ì¡°íšŒ
   */
  Optional<Order> findByOrderNumber(OrderNumber orderNumber);

  /**
   * ì£¼ë¬¸ë²ˆí˜¸ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
   */
  boolean existsByOrderNumber(OrderNumber orderNumber);
}
```

**íŠ¹ì§•:**
- âœ… Domain Layerì˜ required/ì— ìœ„ì¹˜
- âœ… **Store/Reader ë¶„ë¦¬í•˜ì§€ ì•ŠìŒ** (í†µí•© ì¸í„°í˜ì´ìŠ¤)
- âœ… ìˆœìˆ˜ Java ì¸í„°í˜ì´ìŠ¤ (JPA ì–´ë…¸í…Œì´ì…˜ ì—†ìŒ)
- âœ… Infrastructureì—ì„œ Adapterë¡œ êµ¬í˜„

---

## Outbox Pattern

### OutboxEventAppender (Domain Service)

```java
// core/domain/outbox/OutboxEventAppender.java
@Service
@RequiredArgsConstructor
public class OutboxEventAppender {

  private final OutboxEventClient outboxEventClient;

  /**
   * AggregateRootë¥¼ Outboxì— ì €ì¥
   */
  public void append(OutboxEventType type, AggregateRoot aggregateRoot) {
    outboxEventClient.save(type, aggregateRoot);
  }
}
```

### OutboxEventClient Port

```java
// core/domain/outbox/required/OutboxEventClient.java
public interface OutboxEventClient {

  /**
   * AggregateRootë¥¼ Outboxì— ì €ì¥
   *
   * @param type Outbox Event Type (ORDER_CREATED, ORDER_CANCELLED ë“±)
   * @param aggregateRoot AggregateRoot (Order, Payment ë“±)
   */
  void save(OutboxEventType type, AggregateRoot aggregateRoot);
}
```

### OutboxEventType

```java
// core/domain/outbox/OutboxEventType.java
public enum OutboxEventType {
  /** ì£¼ë¬¸ ìƒì„± ì´ë²¤íŠ¸ */
  ORDER_CREATED,
}
```

**Outbox íŒ¨í„´ íë¦„:**
```
OrderCreator (Domain Service)
  1. orderRepository.store(order)        â†’ Order ì €ì¥ (DB)
  2. outboxEventAppender.append(order)   â†’ Outbox ì €ì¥ (DB, ê°™ì€ íŠ¸ëœì­ì…˜)
     â†’ outboxEventClient.save()          â†’ Infrastructure Layer
       â†’ KafkaOutboxEventMapper.map()    â†’ Order â†’ KafkaEvent ë³€í™˜
       â†’ outboxEventService.registerEvent() â†’ Outbox ë¼ì´ë¸ŒëŸ¬ë¦¬ í˜¸ì¶œ
```

---

## Domain Command í…œí”Œë¦¿

CommandëŠ” **Domain Layer**ì— ìœ„ì¹˜í•©ë‹ˆë‹¤.

```java
// core/domain/order/command/CreateOrderCommand.java
@Builder
public record CreateOrderCommand(
    List<OrderItem> items,
    Origin origin,
    Destination destination,
    DeliveryPolicy deliveryPolicy
) {
    // í•„ìˆ˜ ê°’ ê²€ì¦
    public CreateOrderCommand {
        if (items == null || items.isEmpty()) {
            throw new IllegalArgumentException("ì£¼ë¬¸ ì•„ì´í…œì€ ìµœì†Œ 1ê°œ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤");
        }
        if (origin == null) {
            throw new IllegalArgumentException("ì¶œë°œì§€ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤");
        }
        if (destination == null) {
            throw new IllegalArgumentException("ë„ì°©ì§€ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤");
        }
        if (deliveryPolicy == null) {
            throw new IllegalArgumentException("ë°°ì†¡ ì •ì±…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤");
        }
    }
}
```

**íŠ¹ì§•:**
- âœ… Domain Layerì— ìœ„ì¹˜ (domain/{aggregate}/command/)
- âœ… record ì‚¬ìš© (ë¶ˆë³€ì„±)
- âœ… í•„ìˆ˜ ê°’ ê²€ì¦ë§Œ (ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™ì€ Domain Serviceì—ì„œ)

---

## Domain Event í…œí”Œë¦¿

### DomainEvent ì¸í„°í˜ì´ìŠ¤

```java
// core/domain/shared/event/DomainEvent.java
public interface DomainEvent {
  Instant occurredAt();
  
  default String eventType() {
    return this.getClass().getSimpleName();
  }
  
  String aggregateType();
  String aggregateId();
}
```

### OrderCreatedEvent

```java
// core/domain/order/event/OrderCreatedEvent.java
public record OrderCreatedEvent(
    Long orderId,
    OrderNumber orderNumber,
    OrderStatus status,
    List<OrderItem> items,
    Origin origin,
    Destination destination,
    DeliveryPolicy deliveryPolicy,
    Instant orderedAt,
    Instant occurredAt
) implements DomainEvent {
  
  public static OrderCreatedEvent from(Order order) {
    return new OrderCreatedEvent(
        order.getId(),
        order.getOrderNumber(),
        order.getStatus(),
        List.copyOf(order.getItems()),
        order.getOrigin(),
        order.getDestination(),
        order.getDeliveryPolicy(),
        order.getOrderedAt(),
        Instant.now());
  }

  @Override
  public String aggregateType() {
    return "Order";
  }

  @Override
  public String aggregateId() {
    return String.valueOf(orderId);
  }
}
```

---

## Value Object í…œí”Œë¦¿

```java
// core/domain/shared/Money.java
public record Money(BigDecimal amount) {
    
    public static final Money ZERO = new Money(BigDecimal.ZERO);
    
    public Money {
        if (amount == null) {
            throw new IllegalArgumentException("ê¸ˆì•¡ì€ nullì¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
        }
    }
    
    public static Money of(long amount) {
        return new Money(BigDecimal.valueOf(amount));
    }
    
    public boolean isNegative() {
        return amount.compareTo(BigDecimal.ZERO) < 0;
    }
    
    public Money add(Money other) {
        return new Money(amount.add(other.amount));
    }
    
    public Money multiply(int multiplier) {
        return new Money(amount.multiply(BigDecimal.valueOf(multiplier)));
    }
}

// core/domain/shared/Address.java
public record Address(
    String jibnunAddress,
    String roadAddress,
    String detailAddress
) {
    public Address {
        if (jibnunAddress == null || jibnunAddress.isBlank()) {
            throw new IllegalArgumentException("ì§€ë²ˆ ì£¼ì†ŒëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤");
        }
        if (roadAddress == null || roadAddress.isBlank()) {
            throw new IllegalArgumentException("ë„ë¡œëª… ì£¼ì†ŒëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤");
        }
    }
}
```

---

## Domain Exception ê·œì¹™

### ì €ì¥ì†Œ êµ¬ì¡°

```
core/
â”œâ”€â”€ common/
â”‚   â””â”€â”€ exception/
â”‚       â”œâ”€â”€ BaseException.java      # â­ ëª¨ë“  ì»¤ìŠ¤í…€ ì˜ˆì™¸ì˜ ê¸°ë°˜ í´ë˜ìŠ¤
â”‚       â””â”€â”€ ErrorCode.java          # ì—ëŸ¬ ì½”ë“œ enum
â”‚
â””â”€â”€ domain/
    â””â”€â”€ order/
        â””â”€â”€ exception/              # Domain Exception
            â”œâ”€â”€ OrderNotFoundException.java
            â”œâ”€â”€ OrderAlreadyAssignedException.java
            â””â”€â”€ InvalidOrderException.java
```

### BaseException í…œí”Œë¦¿
```java
// core/common/exception/BaseException.java
@Getter
public abstract class BaseException extends RuntimeException {
  
  private final ErrorCode errorCode;
  
  protected BaseException(ErrorCode errorCode, String message) {
    super(message);
    this.errorCode = errorCode;
  }
  
  protected BaseException(ErrorCode errorCode) {
    super(errorCode.getMessage());
    this.errorCode = errorCode;
  }
}
```

### Domain Exception í…œí”Œë¦¿

```java
// core/domain/order/exception/OrderNotFoundException.java
public class OrderNotFoundException extends BaseException {
  
  public OrderNotFoundException(Long orderId) {
    super(ErrorCode.ORDER_NOT_FOUND, "ì£¼ë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ID: " + orderId);
  }
  
  public OrderNotFoundException(OrderNumber orderNumber) {
    super(ErrorCode.ORDER_NOT_FOUND, "ì£¼ë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì£¼ë¬¸ë²ˆí˜¸: " + orderNumber.value());
  }
}
```

---

## ì¤‘ìš” ì›ì¹™
1. Domainì€ ìˆœìˆ˜ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ë§Œ
2. **ëª¨ë“  PortëŠ” required/ì— ìœ„ì¹˜** (ì¼ê´€ì„±)
3. **RepositoryëŠ” í†µí•© ì¸í„°í˜ì´ìŠ¤** (Store/Reader ë¶„ë¦¬ ì•ˆ í•¨)
4. **Domain ServiceëŠ” domain/{aggregate}/ ì§ì†**
5. **CommandëŠ” domain/{aggregate}/command/ì— ìœ„ì¹˜**
6. **ëª¨ë“  ì»¤ìŠ¤í…€ Exceptionì€ BaseExceptionì„ ìƒì†**
7. Domain ServiceëŠ” @Service ì• ë…¸í…Œì´ì…˜ ì‚¬ìš©
8. Aggregate RootëŠ” AggregateRoot ìƒì†ìœ¼ë¡œ Domain Event ê´€ë¦¬
9. InfrastructureëŠ” ì ˆëŒ€ ì˜ì¡´í•˜ì§€ ì•ŠìŒ (ì¸í„°í˜ì´ìŠ¤ë¡œë§Œ ì˜ì¡´)
---
alwaysApply: true
---

# Application Layer ê·œì¹™

## ìœ„ì¹˜
`core/application/`

## ì €ì¥ì†Œ êµ¬ì¡°

```
core/application/{aggregate}/                # ì˜ˆ: order, payment, delivery
â””â”€â”€ {Aggregate}Facade.java                   # Facade (íë¦„ ì¡°ì •)
```

**ì˜ˆì‹œ:**
- Order: application/order/OrderFacade.java
- Payment: application/payment/PaymentFacade.java
- Delivery: application/delivery/DeliveryFacade.java

**ì¤‘ìš”:**
- **Facade Pattern ì‚¬ìš©** (UseCase ëŒ€ì‹ )
- **Domain Serviceë§Œ í˜¸ì¶œ** (ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì€ Domainì—ì„œ)
- **CommandëŠ” Domain Layerì— ìœ„ì¹˜** (applicationì— ì—†ìŒ)

## ì±…ì„
- Facadeë¡œ íë¦„ ì¡°ì •
- Domain Service í˜¸ì¶œ
- íŠ¸ëœì­ì…˜ ê´€ë¦¬ (í•„ìš” ì‹œ)

## ë°˜ë“œì‹œ í•´ì•¼ í•  ê²ƒ
1. @Facade ì• ë…¸í…Œì´ì…˜ ì‚¬ìš©
2. Domain Serviceë§Œ ì˜ì¡´
3. ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì€ ì ˆëŒ€ ì§ì ‘ êµ¬í˜„ ê¸ˆì§€
4. ê°„ë‹¨í•œ íë¦„ ì¡°ì •ë§Œ

## ì ˆëŒ€ í•˜ì§€ ë§ ê²ƒ
1. ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì§ì ‘ êµ¬í˜„ ê¸ˆì§€
2. JPA, Infrastructure ì§ì ‘ ì˜ì¡´ ê¸ˆì§€
3. Repository ì§ì ‘ í˜¸ì¶œ ê¸ˆì§€ (Domain Serviceë¥¼ í†µí•´ì„œë§Œ)
4. ë³µì¡í•œ ë¡œì§ ì‘ì„± ê¸ˆì§€

---

## Facade íŒ¨í„´

### ì•„í‚¤í…ì²˜

```
Controller (Interface Layer)
  â†’ Facade (Application Layer) - íë¦„ë§Œ ì¡°ì •
    â†’ Domain Service (Domain Layer) - ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ìˆ˜í–‰
      â†’ Repository (Port) - ì˜ì†ì„±
        â†’ Adapter (Infrastructure Layer) - ê¸°ìˆ  êµ¬í˜„
```

**íŠ¹ì§•:**
- âœ… FacadeëŠ” íë¦„ë§Œ ì¡°ì • (ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì—†ìŒ)
- âœ… Domain Serviceê°€ ì‹¤ì œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ìˆ˜í–‰
- âœ… íŠ¸ëœì­ì…˜ì€ Domain Serviceì—ì„œ ê´€ë¦¬

---

## Facade í…œí”Œë¦¿

### ì¼ë°˜ í…œí”Œë¦¿

```java
// core/application/{aggregate}/{Aggregate}Facade.java
@Facade
@RequiredArgsConstructor
public class {Aggregate}Facade {

  private final {Aggregate}Creator {aggregate}Creator;
  private final {Aggregate}Reader {aggregate}Reader;

  /**
   * {Aggregate} ìƒì„±
   *
   * <p>{Aggregate}Creator Domain Serviceë¥¼ í˜¸ì¶œí•˜ì—¬ ìƒì„±í•©ë‹ˆë‹¤.
   *
   * @param command ìƒì„± Command (Domain Layerì— ìœ„ì¹˜)
   * @return ìƒì„±ëœ {Aggregate}
   */
  public {Aggregate} create{Aggregate}(Create{Aggregate}Command command) {
    return {aggregate}Creator.create(command);
  }

  /**
   * {Aggregate} ì¡°íšŒ (ID)
   *
   * @param id {Aggregate} ID
   * @return {Aggregate}
   */
  public {Aggregate} get{Aggregate}ById(Long id) {
    return {aggregate}Reader.get{Aggregate}ById(id);
  }

  /**
   * {Aggregate} ì¡°íšŒ ({Aggregate}ë²ˆí˜¸)
   *
   * @param {aggregate}Number {Aggregate} ë²ˆí˜¸
   * @return {Aggregate}
   */
  public {Aggregate} get{Aggregate}By{Aggregate}Number({Aggregate}Number {aggregate}Number) {
    return {aggregate}Reader.get{Aggregate}By{Aggregate}Number({aggregate}Number);
  }
}
```

### ì‹¤ì œ ì˜ˆì‹œ (Order)

```java
// core/application/order/OrderFacade.java
@Facade
@RequiredArgsConstructor
public class OrderFacade {

  private final OrderCreator orderCreator;
  private final OrderReader orderReader;

  /**
   * ì£¼ë¬¸ ìƒì„±
   *
   * <p>OrderCreator Domain Serviceë¥¼ í˜¸ì¶œí•˜ì—¬ ì£¼ë¬¸ì„ ìƒì„±í•©ë‹ˆë‹¤.
   *
   * @param command ì£¼ë¬¸ ìƒì„± Command (Domain Layerì— ìœ„ì¹˜)
   * @return ìƒì„±ëœ Order
   */
  public Order createOrder(CreateOrderCommand command) {
    return orderCreator.create(command);
  }

  /**
   * ì£¼ë¬¸ ì¡°íšŒ (ID)
   *
   * @param orderId ì£¼ë¬¸ ID
   * @return Order
   */
  public Order getOrderById(Long orderId) {
    return orderReader.getOrderById(orderId);
  }

  /**
   * ì£¼ë¬¸ ì¡°íšŒ (ì£¼ë¬¸ë²ˆí˜¸)
   *
   * @param orderNumber ì£¼ë¬¸ë²ˆí˜¸
   * @return Order
   */
  public Order getOrderByOrderNumber(OrderNumber orderNumber) {
    return orderReader.getOrderByOrderNumber(orderNumber);
  }
}
```

**íŠ¹ì§•:**
- âœ… @Facade ì• ë…¸í…Œì´ì…˜
- âœ… Domain Serviceë§Œ í˜¸ì¶œ
- âœ… ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì—†ìŒ (ë‹¨ìˆœ ìœ„ì„)
- âœ… CommandëŠ” Domain Layerì—ì„œ ê°€ì ¸ì˜´

---

## @Facade ì• ë…¸í…Œì´ì…˜

```java
// core/application/common/annotation/Facade.java
@Target(ElementType.TYPE)
@Retention(RetentionPolicy.RUNTIME)
@Service
public @interface Facade {
}
```

**íŠ¹ì§•:**
- âœ… Spring @Serviceë¥¼ í¬í•¨
- âœ… ì˜ë¯¸ë¡ ì ìœ¼ë¡œ Facadeì„ì„ ëª…ì‹œ
- âœ… Component Scanì—ì„œ ìë™ ë“±ë¡

---

## íŠ¸ëœì­ì…˜ ì „ëµ

### ê¸°ë³¸: Domain Serviceì—ì„œ @Transactional

**FacadeëŠ” íŠ¸ëœì­ì…˜ ê´€ë¦¬ ì•ˆ í•¨**

```java
// Domain Serviceì—ì„œ íŠ¸ëœì­ì…˜
@Service
@RequiredArgsConstructor
public class OrderCreator {

  @Transactional  // â­ Domain Serviceì—ì„œ íŠ¸ëœì­ì…˜
  public Order create(CreateOrderCommand command) {
    // 1. ì£¼ë¬¸ë²ˆí˜¸ ìƒì„±
    OrderNumber orderNumber = orderNumberGenerator.generate();

    // 2. Order ì €ì¥
    Order order = orderRepository.store(...);

    // 3. Outbox ì €ì¥ (ê°™ì€ íŠ¸ëœì­ì…˜)
    outboxEventAppender.append(OutboxEventType.ORDER_CREATED, order);

    return order;
  }
}

// FacadeëŠ” ë‹¨ìˆœ í˜¸ì¶œ
@Facade
@RequiredArgsConstructor
public class OrderFacade {

  public Order createOrder(CreateOrderCommand command) {
    return orderCreator.create(command);  // íŠ¸ëœì­ì…˜ì€ Domain Serviceì—ì„œ
  }
}
```

---

## Command ìœ„ì¹˜

**CommandëŠ” Applicationì´ ì•„ë‹Œ Domain Layerì— ìœ„ì¹˜í•©ë‹ˆë‹¤.**

```
âŒ ì˜ëª»ëœ ìœ„ì¹˜:
core/application/order/command/CreateOrderCommand.java

âœ… ì˜¬ë°”ë¥¸ ìœ„ì¹˜:
core/domain/order/command/CreateOrderCommand.java
```

**ì´ìœ :**
- CommandëŠ” Domain ê°œë… (ë¹„ì¦ˆë‹ˆìŠ¤ ìš”êµ¬ì‚¬í•­)
- Domain Serviceê°€ ì§ì ‘ ì‚¬ìš©
- Applicationì€ ë‹¨ìˆœíˆ ì „ë‹¬ë§Œ

---

## Facade vs UseCase ë¹„êµ

### UseCase íŒ¨í„´ (ì´ì „)

```java
@UseCase
@RequiredArgsConstructor
public class CreateOrderUseCase {
  
  private final OrderRepository orderRepository;
  private final OrderNumberGenerator orderNumberGenerator;
  private final OutboxEventPublisher outboxEventPublisher;

  @Transactional
  public Order execute(CreateOrderCommand command) {
    // UseCaseì—ì„œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì§ì ‘ ìˆ˜í–‰
    OrderNumber orderNumber = orderNumberGenerator.generate();
    
    Order order = Order.create(...);
    Order saved = orderRepository.save(order);
    
    outboxEventPublisher.publish(saved.getDomainEvents());
    
    return saved;
  }
}
```

**ë¬¸ì œì :**
- âŒ UseCaseê°€ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ì§ì ‘ ìˆ˜í–‰
- âŒ Domain Service ê°œë… ì—†ìŒ
- âŒ ì¬ì‚¬ìš© ì–´ë ¤ì›€

### Facade íŒ¨í„´ (í˜„ì¬)

```java
@Facade
@RequiredArgsConstructor
public class OrderFacade {
  
  private final OrderCreator orderCreator;

  public Order createOrder(CreateOrderCommand command) {
    // FacadeëŠ” ë‹¨ìˆœ í˜¸ì¶œë§Œ
    return orderCreator.create(command);
  }
}

@Service
@RequiredArgsConstructor
public class OrderCreator {
  
  @Transactional
  public Order create(CreateOrderCommand command) {
    // Domain Serviceê°€ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ìˆ˜í–‰
    OrderNumber orderNumber = orderNumberGenerator.generate();
    Order order = orderRepository.store(...);
    outboxEventAppender.append(OutboxEventType.ORDER_CREATED, order);
    return order;
  }
}
```

**ì¥ì :**
- âœ… FacadeëŠ” íë¦„ë§Œ ì¡°ì •
- âœ… Domain Serviceê°€ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ìˆ˜í–‰
- âœ… Domain Service ì¬ì‚¬ìš© ê°€ëŠ¥
- âœ… ì±…ì„ ë¶„ë¦¬ ëª…í™•

---

## ì—¬ëŸ¬ Domain Service ì¡°í•©

ì—¬ëŸ¬ Domain Serviceë¥¼ ì¡°í•©í•´ì•¼ í•  ë•ŒëŠ” **Facadeì—ì„œ íë¦„ ì¡°ì •**

```java
@Facade
@RequiredArgsConstructor
public class OrderFacade {
  
  private final OrderCreator orderCreator;
  private final OrderValidator orderValidator;
  private final InventoryChecker inventoryChecker;

  public Order createOrderWithValidation(CreateOrderCommand command) {
    // 1. ì¬ê³  í™•ì¸ (Domain Service)
    inventoryChecker.checkAvailability(command.items());
    
    // 2. ì£¼ë¬¸ ê²€ì¦ (Domain Service)
    orderValidator.validate(command);
    
    // 3. ì£¼ë¬¸ ìƒì„± (Domain Service)
    return orderCreator.create(command);
  }
}
```

**íŠ¹ì§•:**
- âœ… Facadeê°€ ì—¬ëŸ¬ Domain Service ì¡°í•©
- âœ… ê° Domain ServiceëŠ” ë…ë¦½ì 
- âœ… FacadeëŠ” íë¦„ë§Œ ì œì–´

---

## ë³µì¡í•œ íë¦„ ì²˜ë¦¬

### TransactionTemplate ì‚¬ìš© (ì„ íƒì )

ì—¬ëŸ¬ Aggregateë¥¼ ìˆ˜ì •í•˜ê³  ì™¸ë¶€ API í˜¸ì¶œì´ ìˆëŠ” ê²½ìš°

```java
@Facade
@RequiredArgsConstructor
public class OrderFacade {
  
  private final TransactionTemplate transactionTemplate;
  private final OrderCreator orderCreator;
  private final PaymentProcessor paymentProcessor;
  private final OrderStatusUpdater orderStatusUpdater;

  public Order createAndPayOrder(CreateOrderCommand command, PaymentInfo paymentInfo) {
    
    // 1. íŠ¸ëœì­ì…˜ 1: ì£¼ë¬¸ ìƒì„±
    Order order = transactionTemplate.execute(status -> 
      orderCreator.create(command)
    );
    
    // 2. ì™¸ë¶€ API: ê²°ì œ ì²˜ë¦¬ (íŠ¸ëœì­ì…˜ ë°–)
    PaymentResult result = paymentProcessor.process(order.getId(), paymentInfo);
    
    // 3. íŠ¸ëœì­ì…˜ 2: ì£¼ë¬¸ ìƒíƒœ ì—…ë°ì´íŠ¸
    return transactionTemplate.execute(status -> 
      orderStatusUpdater.updateToPaid(order.getId(), result)
    );
  }
}
```

**ì–¸ì œ ì‚¬ìš©:**
- âœ… ì—¬ëŸ¬ Aggregate ìˆ˜ì • + ì™¸ë¶€ API í˜¸ì¶œ
- âœ… íŠ¸ëœì­ì…˜ ë¶„ë¦¬ê°€ í•„ìš”í•œ ê²½ìš°

---

## ì˜ˆì™¸ ì²˜ë¦¬

### Domain Exceptionì€ ê·¸ëŒ€ë¡œ ì „íŒŒ

```java
@Facade
@RequiredArgsConstructor
public class OrderFacade {
  
  private final OrderReader orderReader;

  public Order getOrderById(Long orderId) {
    // Domain Serviceì—ì„œ ë°œìƒí•œ ì˜ˆì™¸ë¥¼ ê·¸ëŒ€ë¡œ ì „íŒŒ
    return orderReader.getOrderById(orderId);  // OrderNotFoundException ë°œìƒ ê°€ëŠ¥
  }
}
```

**íŠ¹ì§•:**
- âœ… FacadeëŠ” ì˜ˆì™¸ë¥¼ ë³€í™˜í•˜ì§€ ì•ŠìŒ
- âœ… Domain Exceptionì„ ê·¸ëŒ€ë¡œ ì „íŒŒ
- âœ… Controllerì˜ ExceptionHandlerì—ì„œ ì²˜ë¦¬

---

## ê¸ˆì§€ ì‚¬í•­

### âŒ Facadeì—ì„œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì§ì ‘ êµ¬í˜„

```java
// âŒ ë‚˜ìœ ì˜ˆ
@Facade
public class OrderFacade {
  
  public Order createOrder(CreateOrderCommand command) {
    // Facadeì—ì„œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì§ì ‘ ìˆ˜í–‰ ê¸ˆì§€!
    OrderNumber orderNumber = orderNumberGenerator.generate();
    Order order = Order.create(...);
    Order saved = orderRepository.store(...);
    outboxEventAppender.append(...);
    return saved;
  }
}

// âœ… ì¢‹ì€ ì˜ˆ
@Facade
public class OrderFacade {
  
  public Order createOrder(CreateOrderCommand command) {
    // Domain Serviceì—ê²Œ ìœ„ì„
    return orderCreator.create(command);
  }
}
```

### âŒ Repository ì§ì ‘ í˜¸ì¶œ

```java
// âŒ ë‚˜ìœ ì˜ˆ
@Facade
public class OrderFacade {
  
  private final OrderRepository orderRepository;  // ê¸ˆì§€!

  public Order getOrder(Long id) {
    return orderRepository.findById(id).orElseThrow();
  }
}

// âœ… ì¢‹ì€ ì˜ˆ
@Facade
public class OrderFacade {
  
  private final OrderReader orderReader;  // Domain Service

  public Order getOrder(Long id) {
    return orderReader.getOrderById(id);
  }
}
```

---

## ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] Facadeì— @Facade ì• ë…¸í…Œì´ì…˜ì´ ìˆëŠ”ê°€?
- [ ] Facadeê°€ Domain Serviceë§Œ í˜¸ì¶œí•˜ëŠ”ê°€?
- [ ] Facadeì— ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì´ ì—†ëŠ”ê°€?
- [ ] Commandê°€ Domain Layerì— ìˆëŠ”ê°€?
- [ ] Repositoryë¥¼ ì§ì ‘ í˜¸ì¶œí•˜ì§€ ì•ŠëŠ”ê°€?
- [ ] íŠ¸ëœì­ì…˜ì´ Domain Serviceì— ìˆëŠ”ê°€?
- [ ] ì˜ˆì™¸ë¥¼ ë³€í™˜í•˜ì§€ ì•Šê³  ê·¸ëŒ€ë¡œ ì „íŒŒí•˜ëŠ”ê°€?

---

## ì¤‘ìš” ì›ì¹™

1. **FacadeëŠ” íë¦„ë§Œ ì¡°ì •** (ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì—†ìŒ)
2. **Domain Serviceê°€ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ìˆ˜í–‰**
3. **CommandëŠ” Domain Layerì— ìœ„ì¹˜**
4. **íŠ¸ëœì­ì…˜ì€ Domain Serviceì—ì„œ ê´€ë¦¬**
5. **RepositoryëŠ” Domain Serviceë¥¼ í†µí•´ì„œë§Œ í˜¸ì¶œ**
6. **ì—¬ëŸ¬ Domain Service ì¡°í•© ì‹œ Facadeì—ì„œ íë¦„ ì œì–´**
---
alwaysApply: true
---

# Infrastructure Layer ê·œì¹™

## ìœ„ì¹˜
`infrastructure/`

## ì±…ì„
- ê¸°ìˆ  êµ¬í˜„ (JPA, Kafka, Feign, Redis)
- Domain Port ì¸í„°í˜ì´ìŠ¤ êµ¬í˜„ (Store/Reader)
- ì™¸ë¶€ ì‹œìŠ¤í…œ ì—°ë™

## ì €ì¥ì†Œ êµ¬ì¡°

**infrastructure/**
- **storage/** - ì €ì¥ì†Œ
  - **db/** - ë°ì´í„°ë² ì´ìŠ¤ (JPA)
    - {aggregate}/                   # ì˜ˆ: order, payment, delivery
      - entity/
      - adapter/
  - **cache/** - ìºì‹œ (Redis) [ì„ íƒ]
    - {aggregate}/
    - config/
- **outbox/** - Outbox Pattern
  - KafkaOutboxEventClient.java
  - KafkaOutboxEventMapper.java
  - KafkaOutboxEvent.java
- **external/** - ì™¸ë¶€ API [ì„ íƒ]
  - client/
  - adapter/
- **config/** - ê³µí†µ ì„¤ì •

**ì˜ˆì‹œ:**
- Order: storage/db/order/entity/, storage/db/order/adapter/
- Payment: storage/db/payment/entity/, storage/db/payment/adapter/
- Delivery: storage/db/delivery/entity/, storage/db/delivery/adapter/

## JPA Entity ê·œì¹™

### ë°˜ë“œì‹œ í•´ì•¼ í•  ê²ƒ
1. @Entity, @Table ë“± JPA ì–´ë…¸í…Œì´ì…˜ ì‚¬ìš©
2. from(Domain) ì •ì  ë©”ì„œë“œë¡œ Domain â†’ Entity ë³€í™˜
3. toDomain() ì¸ìŠ¤í„´ìŠ¤ ë©”ì„œë“œë¡œ Entity â†’ Domain ë³€í™˜
4. @NoArgsConstructor(access = AccessLevel.PROTECTED)
5. Getterë§Œ ì‚¬ìš© (Setter ê¸ˆì§€)
6. **ê³µí†µ ì½”ë“œ ìŠ¤íƒ€ì¼ ì¤€ìˆ˜** (00-workflow.mdc ì°¸ê³ )
   - FQCN ëŒ€ì‹  import ì‚¬ìš©

### ì ˆëŒ€ í•˜ì§€ ë§ ê²ƒ
1. Entityì— ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì‘ì„± ê¸ˆì§€
2. Entityê°€ Domainì„ ìƒì†ë°›ëŠ” ê²ƒ ê¸ˆì§€
3. FQCN(Fully Qualified Class Name) ì‚¬ìš© ê¸ˆì§€
4. EAGER fetch ì‚¬ìš© ê¸ˆì§€
5. ì–‘ë°©í–¥ ì—°ê´€ê´€ê³„ ìµœì†Œí™”

### JPA Entity í…œí”Œë¦¿

#### ì¼ë°˜ í…œí”Œë¦¿

```java
// infrastructure/storage/db/{aggregate}/entity/{Aggregate}Entity.java
@Entity
@Table(name = "{aggregates}")  # í…Œì´ë¸”ëª…ì€ ë³µìˆ˜í˜•
@Getter
@NoArgsConstructor(access = AccessLevel.PROTECTED)
public class {Aggregate}Entity {
    
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(nullable = false, unique = true)
    private String {aggregate}Number;
    
    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    private {Aggregate}Status status;
    
    @Column(nullable = false)
    private BigDecimal amount;  // ë„ë©”ì¸ íŠ¹í™” í•„ë“œ
    
    @Embedded
    private Property1Embed property1;  // Embedded Value Object
    
    @OneToMany(cascade = CascadeType.ALL, orphanRemoval = true)
    @JoinColumn(name = "{aggregate}_id")
    private List<{Aggregate}ItemEntity> items = new ArrayList<>();  // (ì„ íƒ)
    
    @Column(nullable = false, updatable = false)
    private Instant createdAt;
    
    // Domain â†’ Entity ë³€í™˜
    public static {Aggregate}Entity from({Aggregate} domain) {
        {Aggregate}Entity entity = new {Aggregate}Entity();
        entity.id = domain.getId();
        entity.{aggregate}Number = domain.get{Aggregate}Number().value();
        entity.status = domain.getStatus();
        entity.amount = domain.getAmount().amount();
        entity.property1 = Property1Embed.from(domain.getProperty1());
        entity.items = domain.getItems().stream()
            .map({Aggregate}ItemEntity::from)
            .collect(Collectors.toList());
        entity.createdAt = domain.getCreatedAt();
        return entity;
    }
    
    // Entity â†’ Domain ë³€í™˜
    public {Aggregate} toDomain() {
        return {Aggregate}.builder()
            .id(this.id)
            .{aggregate}Number({Aggregate}Number.of(this.{aggregate}Number))
            .status(this.status)
            .amount(Money.of(this.amount))
            .property1(this.property1.toDomain())
            .items(this.items.stream()
                .map({Aggregate}ItemEntity::toDomain)
                .collect(Collectors.toList()))
            .createdAt(this.createdAt)
            .build();
    }
}
```

#### ì‹¤ì œ ì˜ˆì‹œ (Order)

```java
// infrastructure/storage/db/order/entity/OrderEntity.java
@Entity
@Table(name = "orders")
@Getter
@NoArgsConstructor(access = AccessLevel.PROTECTED)
public class OrderEntity {
    
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(nullable = false, unique = true)
    private String orderNumber;
    
    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    private OrderStatus status;
    
    @Column(nullable = false)
    private BigDecimal totalAmount;
    
    @Embedded
    private AddressEmbed deliveryAddress;
    
    @OneToMany(cascade = CascadeType.ALL, orphanRemoval = true)
    @JoinColumn(name = "order_id")
    private List<OrderItemEntity> items = new ArrayList<>();
    
    @Column(nullable = false, updatable = false)
    private Instant orderedAt;
    
    // Domain â†’ Entity ë³€í™˜
    public static OrderEntity from(Order domain) {
        OrderEntity entity = new OrderEntity();
        entity.id = domain.getId();
        entity.orderNumber = domain.getOrderNumber().value();
        entity.status = domain.getStatus();
        entity.totalAmount = domain.getTotalAmount().amount();
        entity.deliveryAddress = AddressEmbed.from(domain.getDeliveryAddress());
        entity.items = domain.getItems().stream()
            .map(OrderItemEntity::from)
            .collect(Collectors.toList());
        entity.orderedAt = domain.getOrderedAt();
        return entity;
    }
    
    // Entity â†’ Domain ë³€í™˜
    public Order toDomain() {
        return Order.builder()
            .id(this.id)
            .orderNumber(OrderNumber.of(this.orderNumber))
            .status(this.status)
            .totalAmount(Money.of(this.totalAmount))
            .deliveryAddress(this.deliveryAddress.toDomain())
            .items(this.items.stream()
                .map(OrderItemEntity::toDomain)
                .collect(Collectors.toList()))
            .orderedAt(this.orderedAt)
            .build();
    }
}
```

```java
// infrastructure/storage/db/order/entity/OrderItemJpaEntity.java
@Entity
@Table(name = "order_items")
@Getter
@NoArgsConstructor(access = AccessLevel.PROTECTED)
public class OrderItemJpaEntity {
    
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(nullable = false)
    private Long productId;
    
    @Column(nullable = false)
    private String productName;
    
    @Column(nullable = false)
    private Integer quantity;
    
    @Column(nullable = false)
    private BigDecimal unitPrice;
    
    public static OrderItemJpaEntity from(OrderItem domain) {
        OrderItemJpaEntity entity = new OrderItemJpaEntity();
        entity.id = domain.getId();
        entity.productId = domain.getProductId();
        entity.productName = domain.getProductName();
        entity.quantity = domain.getQuantity();
        entity.unitPrice = domain.getUnitPrice().value();
        return entity;
    }
    
    public OrderItem toDomain() {
        return OrderItem.builder()
            .id(this.id)
            .productId(this.productId)
            .productName(this.productName)
            .quantity(this.quantity)
            .unitPrice(Money.of(this.unitPrice))
            .build();
    }
}
```

```java
// infrastructure/storage/db/order/entity/AddressEmbed.java
@Embeddable
@Getter
@NoArgsConstructor(access = AccessLevel.PROTECTED)
@AllArgsConstructor
public class AddressEmbed {
    
    @Column(name = "zip_code", nullable = false)
    private String zipCode;
    
    @Column(name = "street", nullable = false)
    private String street;
    
    @Column(name = "detail")
    private String detail;
    
    public static AddressEmbed from(Address domain) {
        return new AddressEmbed(
            domain.zipCode(),
            domain.street(),
            domain.detail()
        );
    }
    
    public Address toDomain() {
        return new Address(zipCode, street, detail);
    }
}
```

---

## Flyway ë§ˆì´ê·¸ë ˆì´ì…˜ ê·œì¹™ â­

### ìœ„ì¹˜
`infrastructure/src/main/resources/db/migration/`

### í•„ìˆ˜ ì›ì¹™
**Domain Entityë‚˜ JPA Entityê°€ ë³€ê²½ë˜ë©´ ë°˜ë“œì‹œ Flyway ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ì„ ì¶”ê°€í•´ì•¼ í•©ë‹ˆë‹¤.**

### íŒŒì¼ ë„¤ì´ë° ê·œì¹™

```
V{YYYYMMDD}_{NNN}__{Description}.sql
```

**ì˜ˆì‹œ:**
```
V20250106_001__Create_order_aggregate.sql
V20250107_001__Add_order_memo_column.sql
V20250107_002__Add_index_on_order_number.sql
```

**êµ¬ì„±:**
- **V**: Version prefix (í•„ìˆ˜, ëŒ€ë¬¸ì)
- **YYYYMMDD**: ë‚ ì§œ (8ìë¦¬)
- **NNN**: ì¼ë ¨ë²ˆí˜¸ (3ìë¦¬, 001ë¶€í„°)
- **__**: êµ¬ë¶„ì (ì–¸ë”ìŠ¤ì½”ì–´ 2ê°œ)
- **Description**: ì˜ë¬¸ ì„¤ëª… (Snake_case)

### Entity ë³€ê²½ ì‹œ ì›Œí¬í”Œë¡œìš°

#### 1. Domain Entity ë³€ê²½
```java
// core/domain/order/Order.java
@Getter
@Builder
public class Order {
    private String memo;  // â­ ìƒˆ í•„ë“œ ì¶”ê°€
}
```

#### 2. JPA Entity ë³€ê²½
```java
// infrastructure/storage/db/order/entity/OrderJpaEntity.java
@Column(name = "memo")
private String memo;  // â­ ìƒˆ ì»¬ëŸ¼ ì¶”ê°€
```

#### 3. Flyway ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ìƒì„± (í•„ìˆ˜!)
```sql
-- infrastructure/src/main/resources/db/migration/V20250107_001__Add_order_memo_column.sql
ALTER TABLE orders 
ADD COLUMN memo VARCHAR(1000) NULL COMMENT 'ì£¼ë¬¸ ë©”ëª¨';
```

#### 4. ë¡œì»¬ í…ŒìŠ¤íŠ¸
```bash
# 1. ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ (Flyway ìë™ ì‹¤í–‰)
./gradlew :api:bootRun

# 2. í…Œì´ë¸” í™•ì¸
docker exec order-mysql mysql -u order_user -porder_password order -e "DESC orders;"

# 3. Flyway ì´ë ¥ í™•ì¸
docker exec order-mysql mysql -u order_user -porder_password order \
  -e "SELECT * FROM flyway_schema_history;"
```

### ë³€ê²½ íƒ€ì…ë³„ íŒŒì¼ëª…

| ë³€ê²½ íƒ€ì… | íŒŒì¼ëª… í˜•ì‹ | ì˜ˆì‹œ |
|----------|-----------|------|
| Aggregate ìƒì„± | `V{YYYYMMDD}_001__Create_{aggregate}_aggregate.sql` | `V20250106_001__Create_order_aggregate.sql` |
| ì»¬ëŸ¼ ì¶”ê°€ | `V{YYYYMMDD}_{NNN}__Add_{table}_{column}_column.sql` | `V20250107_001__Add_order_memo_column.sql` |
| ì»¬ëŸ¼ ë³€ê²½ | `V{YYYYMMDD}_{NNN}__Alter_{table}_{column}.sql` | `V20250107_002__Alter_order_memo_increase_length.sql` |
| ì¸ë±ìŠ¤ ì¶”ê°€ | `V{YYYYMMDD}_{NNN}__Add_index_on_{table}_{column}.sql` | `V20250107_003__Add_index_on_order_number.sql` |
| í…Œì´ë¸” ì‚­ì œ | `V{YYYYMMDD}_{NNN}__Drop_{table}_table.sql` | `V20250107_004__Drop_old_order_history_table.sql` |

### ì²´í¬ë¦¬ìŠ¤íŠ¸

Entity ë³€ê²½ ì‹œ ë‹¤ìŒì„ ë°˜ë“œì‹œ í™•ì¸:

- [ ] Domain Entityê°€ ë³€ê²½ë˜ì—ˆëŠ”ê°€?
- [ ] JPA Entityê°€ ë³€ê²½ë˜ì—ˆëŠ”ê°€?
- [ ] **Flyway ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ì„ ìƒì„±í–ˆëŠ”ê°€?** â­
- [ ] íŒŒì¼ëª…ì´ ë„¤ì´ë° ê·œì¹™ì„ ë”°ë¥´ëŠ”ê°€?
- [ ] ë¡œì»¬ì—ì„œ í…ŒìŠ¤íŠ¸í–ˆëŠ”ê°€?
- [ ] í…Œì´ë¸” ë³€ê²½ì‚¬í•­ì´ ì •í™•í•œê°€?
- [ ] ë¡¤ë°± ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë¬¸ì„œí™”í–ˆëŠ”ê°€?

### ì ˆëŒ€ í•˜ì§€ ë§ ê²ƒ

âŒ **ì´ë¯¸ ì ìš©ëœ ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ìˆ˜ì • ê¸ˆì§€**
```sql
-- V20250106_001__Create_order_aggregate.sql (ì´ë¯¸ ì ìš©ë¨)
-- ì´ íŒŒì¼ì„ ìˆ˜ì •í•˜ì§€ ë§ˆì„¸ìš”! ìƒˆë¡œìš´ ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ì„ ë§Œë“œì„¸ìš”.
```

âŒ **ê°™ì€ ë‚ ì§œì— ì¼ë ¨ë²ˆí˜¸ ì¤‘ë³µ ê¸ˆì§€**
```
V20250107_001__Add_column_A.sql
V20250107_001__Add_column_B.sql  // âŒ ì¼ë ¨ë²ˆí˜¸ ì¤‘ë³µ!
```

âŒ **JPA `ddl-auto`ì— ì˜ì¡´ ê¸ˆì§€**
```yaml
# application.yml
spring:
  jpa:
    hibernate:
      ddl-auto: none  # ë°˜ë“œì‹œ none! (Flywayê°€ ê´€ë¦¬)
```

### ë°˜ë“œì‹œ í•´ì•¼ í•  ê²ƒ

âœ… **ë¡¤ë°± ìŠ¤í¬ë¦½íŠ¸ ì¤€ë¹„**
```sql
-- V20250107_001__Add_order_memo_column.sql
ALTER TABLE orders ADD COLUMN memo VARCHAR(1000) NULL;

-- ë¡¤ë°± ìŠ¤í¬ë¦½íŠ¸ (ë³„ë„ ë¬¸ì„œí™”)
-- ALTER TABLE orders DROP COLUMN memo;
```

âœ… **Production ì ìš© ì „ Staging í…ŒìŠ¤íŠ¸**

âœ… **ëŒ€ìš©ëŸ‰ í…Œì´ë¸” ë³€ê²½ ì‹œ ì ê²€ ì‹œê°„ í™•ë³´**

### FlywayConfig ì„¤ì •

```java
// infrastructure/common/config/FlywayConfig.java
@Configuration
@Profile("local")  // Local í™˜ê²½ì—ì„œë§Œ ì‹¤í–‰
class FlywayConfig {
    
    @Bean(initMethod = "migrate")
    public Flyway flyway(DataSource dataSource) {
        return Flyway.configure()
            .dataSource(dataSource)
            .locations("classpath:db/migration")
            .baselineOnMigrate(true)
            .baselineVersion("0")
            .validateOnMigrate(true)
            .outOfOrder(false)
            .cleanDisabled(true)
            .load();
    }
}
```

### í™˜ê²½ë³„ ì‹¤í–‰ ì „ëµ

**Local í™˜ê²½:**
- Flywayê°€ ìë™ìœ¼ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
- `@Profile("local")` í™œì„±í™”

**Production í™˜ê²½:**
- DBAê°€ ìˆ˜ë™ìœ¼ë¡œ SQL ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
- Flyway ë¹„í™œì„±í™”

### ìì„¸í•œ ê°€ì´ë“œ

**ë” ìƒì„¸í•œ ë§ˆì´ê·¸ë ˆì´ì…˜ ê°€ì´ë“œëŠ” [documents/flyway-guide.md](../documents/flyway-guide.md)ë¥¼ ì°¸ê³ í•˜ì„¸ìš”.**

---

## Repository Adapter ê·œì¹™

### ìœ„ì¹˜
`infrastructure/storage/db/*/adapter/`

### ì±…ì„
- OrderRepository ì¸í„°í˜ì´ìŠ¤ êµ¬í˜„ (í†µí•©)
- JpaRepository ì‚¬ìš©
- Domain â†” Entity ë³€í™˜
- **@Transactional ê´€ë¦¬ (íŠ¸ëœì­ì…˜ ê²½ê³„)**

### Repository Adapter í…œí”Œë¦¿

```java
// infrastructure/storage/db/order/adapter/OrderRepositoryAdapter.java
@Repository
@RequiredArgsConstructor
public class OrderRepositoryAdapter implements OrderRepository {
    
    private final OrderJpaRepository orderJpaRepository;
    private final OrderItemJpaRepository orderItemJpaRepository;
    private final OrderLocationJpaRepository orderLocationJpaRepository;
    private final OrderDeliveryPolicyJpaRepository orderDeliveryPolicyJpaRepository;
    
    /**
     * Order ìƒì„± ë° ì €ì¥
     *
     * <p>Order Entityë¥¼ ìƒì„±í•˜ê³  ì €ì¥í•œ í›„, Order.create()ë¡œ ì™„ì „í•œ Domain Model ë°˜í™˜
     */
    @Transactional  // â­ ì—¬ê¸°ì„œ íŠ¸ëœì­ì…˜ ê´€ë¦¬
    @Override
    public Order store(
        OrderNumber orderNumber,
        List<OrderItem> items,
        Origin origin,
        Destination destination,
        DeliveryPolicy deliveryPolicy) {

      // 1. OrderEntity ìƒì„± ë° ì €ì¥
      OrderEntity orderEntity =
          OrderEntity.builder()
              .orderNumber(orderNumber.value())
              .status(OrderStatus.CREATED)
              .orderedAt(Instant.now())
              .build();
      OrderEntity savedOrderEntity = orderJpaRepository.save(orderEntity);
      Long orderId = savedOrderEntity.getId();

      // 2. ì—°ê´€ Entity ì €ì¥
      saveOrderItems(items, orderId);
      saveOrderLocation(origin, destination, orderId);
      saveOrderDeliveryPolicy(deliveryPolicy, orderId);

      // 3. Order.create()ë¡œ ì™„ì „í•œ Domain Model ìƒì„± (Domain Event ìë™ ì¶”ê°€)
      return Order.create(orderId, orderNumber, items, origin, destination, deliveryPolicy);
    }
    
    @Transactional(readOnly = true)
    @Override
    public Optional<Order> findById(Long id) {
        return orderJpaRepository.findById(id)
            .map(entity -> reconstructOrder(entity));
    }
    
    @Transactional(readOnly = true)
    @Override
    public Optional<Order> findByOrderNumber(OrderNumber orderNumber) {
        return orderJpaRepository.findByOrderNumber(orderNumber.value())
            .map(entity -> reconstructOrder(entity));
    }
    
    @Override
    public boolean existsByOrderNumber(OrderNumber orderNumber) {
        return orderJpaRepository.existsByOrderNumber(orderNumber.value());
    }
    
    // private í—¬í¼ ë©”ì„œë“œë“¤
    private void saveOrderItems(List<OrderItem> items, Long orderId) { /* ... */ }
    private void saveOrderLocation(Origin origin, Destination destination, Long orderId) { /* ... */ }
    private void saveOrderDeliveryPolicy(DeliveryPolicy deliveryPolicy, Long orderId) { /* ... */ }
    private Order reconstructOrder(OrderEntity entity) { /* ... */ }
}
```

**íŠ¹ì§•:**
- âœ… **Store/Reader í†µí•©** (í•˜ë‚˜ì˜ Repository)
- âœ… `store()` ë©”ì„œë“œê°€ Order Entity ìƒì„± ë° ì €ì¥
- âœ… `Order.create()`ë¡œ Domain Model ìƒì„± (Domain Event ìë™ ì¶”ê°€)
- âœ… ë©”ì„œë“œ ë‹¨ìœ„ë¡œ ì§§ì€ íŠ¸ëœì­ì…˜
- âœ… Domain Serviceì—ì„œ @Transactionalë¡œ íŠ¸ëœì­ì…˜ ê´€ë¦¬

```java
// infrastructure/storage/db/order/adapter/OrderJpaRepository.java
public interface OrderJpaRepository extends JpaRepository<OrderEntity, Long> {
    
    Optional<OrderEntity> findByOrderNumber(String orderNumber);
    boolean existsByOrderNumber(String orderNumber);
}
```

---

## ë¶€ë¶„ ì—…ë°ì´íŠ¸ íŒ¨í„´ (Partial Update) â­

ë„ë©”ì¸ì˜ íŠ¹ì • í•„ë“œë§Œ ì—…ë°ì´íŠ¸í•˜ëŠ” íŒ¨í„´ì…ë‹ˆë‹¤.

**ì‚¬ìš© ì‹œê¸°:**
- âœ… ì „ì²´ Aggregateë¥¼ êµì²´í•˜ì§€ ì•Šê³  ì¼ë¶€ í•„ë“œë§Œ ë³€ê²½
- âœ… ì„±ëŠ¥ ìµœì í™” (ë¶ˆí•„ìš”í•œ í•„ë“œ ì—…ë°ì´íŠ¸ ë°©ì§€)
- âœ… ëª…í™•í•œ ì—…ë°ì´íŠ¸ ì˜ë„ í‘œí˜„

### ì˜ˆì‹œ: ì£¼ë¬¸ ë„ì°©ì§€ ì£¼ì†Œ ì—…ë°ì´íŠ¸

**1. Repository Port (Domain Layer)**

```java
// core/domain/order/required/OrderRepository.java
public interface OrderRepository {
    
    /**
     * ë„ì°©ì§€ ì£¼ì†Œ ì—…ë°ì´íŠ¸
     *
     * <p>ë³€ê²½ ë²”ìœ„:
     * - Address (ì£¼ì†Œ)
     * - LatLng (ìœ„ê²½ë„)
     * - EntranceInfo (ì¶œì… ê°€ì´ë“œ)
     *
     * <p>ìœ ì§€ë˜ëŠ” ê²ƒ:
     * - Contact (ì—°ë½ì²˜) - ë³€ê²½ë˜ì§€ ì•ŠìŒ
     */
    void updateDestinationAddress(
        Long orderId, 
        Address newAddress, 
        LatLng newLatLng, 
        EntranceInfo newEntranceInfo
    );
}
```

**2. Repository Adapter (Infrastructure Layer)**

```java
// infrastructure/storage/db/order/adapter/OrderRepositoryAdapter.java
@Override
public void updateDestinationAddress(
    Long orderId, Address newAddress, LatLng newLatLng, EntranceInfo newEntranceInfo) {
    
    // 1. Entity ì¡°íšŒ
    OrderLocationEntity locationEntity = orderLocationJpaRepository
        .findByOrderId(orderId)
        .orElseThrow(() -> 
            new IllegalStateException("OrderLocationì´ ì—†ìŠµë‹ˆë‹¤. orderId: " + orderId));
    
    // 2. Entityì˜ ì—…ë°ì´íŠ¸ ë©”ì„œë“œ í˜¸ì¶œ
    locationEntity.updateDestinationAddress(newAddress, newLatLng, newEntranceInfo);
    
    // 3. ëª…ì‹œì  save í˜¸ì¶œ (ì˜ë„ ëª…í™•)
    orderLocationJpaRepository.save(locationEntity);
}
```

**3. Entity ì—…ë°ì´íŠ¸ ë©”ì„œë“œ (Infrastructure Layer)**

```java
// infrastructure/storage/db/order/OrderLocationEntity.java
@Entity
@Table(name = "order_locations")
public class OrderLocationEntity extends BaseEntity {
    
    // Contact í•„ë“œ (ë³€ê²½ë˜ì§€ ì•ŠìŒ)
    @Column(name = "destination_contact_name")
    private String destinationContactName;
    
    @Column(name = "destination_contact_phone_number")
    private String destinationContactPhoneNumber;
    
    // Address í•„ë“œ
    @Column(name = "destination_jibnun_address")
    private String destinationJibnunAddress;
    
    @Column(name = "destination_road_address")
    private String destinationRoadAddress;
    
    @Column(name = "destination_detail_address")
    private String destinationDetailAddress;
    
    // LatLng í•„ë“œ
    @Column(name = "destination_latitude")
    private BigDecimal destinationLatitude;
    
    @Column(name = "destination_longitude")
    private BigDecimal destinationLongitude;
    
    // EntranceInfo í•„ë“œ
    @Column(name = "destination_entrance_password")
    private String destinationEntrancePassword;
    
    @Column(name = "destination_entrance_guide")
    private String destinationEntranceGuide;
    
    @Column(name = "destination_request_message")
    private String destinationRequestMessage;
    
    /**
     * Destination ì£¼ì†Œ ì •ë³´ë§Œ ì—…ë°ì´íŠ¸
     *
     * <p>ë³€ê²½ ë²”ìœ„:
     * - Address (ì£¼ì†Œ)
     * - LatLng (ìœ„ê²½ë„)
     * - EntranceInfo (ì¶œì… ê°€ì´ë“œ)
     *
     * <p>ìœ ì§€ë˜ëŠ” ê²ƒ:
     * - Contact (ì—°ë½ì²˜) - ë³€ê²½ë˜ì§€ ì•ŠìŒ
     */
    public void updateDestinationAddress(
        Address newAddress, LatLng newLatLng, EntranceInfo newEntranceInfo) {
        
        // ContactëŠ” ìœ ì§€ (destinationContactName, destinationContactPhoneNumber ë³€ê²½ ì•ˆ í•¨)
        
        // Address ì—…ë°ì´íŠ¸
        this.destinationJibnunAddress = newAddress.jibnunAddress();
        this.destinationRoadAddress = newAddress.roadAddress();
        this.destinationDetailAddress = newAddress.detailAddress();
        
        // LatLng ì—…ë°ì´íŠ¸
        this.destinationLatitude = newLatLng.latitude();
        this.destinationLongitude = newLatLng.longitude();
        
        // EntranceInfo ì—…ë°ì´íŠ¸
        this.destinationEntrancePassword = newEntranceInfo.password();
        this.destinationEntranceGuide = newEntranceInfo.guide();
        this.destinationRequestMessage = newEntranceInfo.requestMessage();
    }
}
```

**4. Domain Serviceì—ì„œ ì‚¬ìš© (Domain Layer)**

```java
// core/domain/order/OrderLocationChanger.java
@Service
@RequiredArgsConstructor
public class OrderLocationChanger {
    
    private final OrderRepository orderRepository;
    
    @Transactional  // â­ íŠ¸ëœì­ì…˜ì€ Domain Serviceì—ì„œ ê´€ë¦¬
    public Order changeDestinationAddress(
        Order order,
        Address refinedAddress,
        LatLng refinedLatLng,
        EntranceInfo refinedEntranceInfo) {
        
        // 1. ë„ì°©ì§€ ì£¼ì†Œ ë³€ê²½ (ë„ë©”ì¸ ì´ë²¤íŠ¸ ì¶”ê°€)
        order.changeDestinationAddress(refinedAddress, refinedLatLng, refinedEntranceInfo);
        
        // 2. DB ì—…ë°ì´íŠ¸ (ë¶€ë¶„ ì—…ë°ì´íŠ¸)
        orderRepository.updateDestinationAddress(
            order.getId(), refinedAddress, refinedLatLng, refinedEntranceInfo);
        
        return order;
    }
}
```

### íŠ¹ì§•

**ì¥ì :**
- âœ… íŠ¹ì • í•„ë“œë§Œ ì—…ë°ì´íŠ¸ (íš¨ìœ¨ì )
- âœ… ëª…ì‹œì  save() í˜¸ì¶œ (ì˜ë„ ëª…í™•)
- âœ… Entityì˜ ì—…ë°ì´íŠ¸ ë©”ì„œë“œë¡œ ìº¡ìŠí™”
- âœ… íŠ¸ëœì­ì…˜ì€ Domain Serviceì—ì„œ ê´€ë¦¬
- âœ… ë¶ˆí•„ìš”í•œ ë°ì´í„° ë³€ê²½ ë°©ì§€

**ì£¼ì˜ì‚¬í•­:**
- âš ï¸ @Versionì„ ì‚¬ìš©í•œ ë‚™ê´€ì  ë½ ê¶Œì¥ (ë™ì‹œì„± ì œì–´)
- âš ï¸ save() í˜¸ì¶œ í•„ìˆ˜ (JPA Dirty Checkingì—ë§Œ ì˜ì¡´í•˜ì§€ ë§ ê²ƒ)
- âš ï¸ Entity ì—…ë°ì´íŠ¸ ë©”ì„œë“œëŠ” ë‹¨ìˆœ í•„ë“œ ë³€ê²½ë§Œ (ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ê¸ˆì§€)

**vs ì „ì²´ êµì²´:**

| íŒ¨í„´ | ìš©ë„ | ì„±ëŠ¥ | ëª…í™•ì„± |
|---|---|---|---|
| **ë¶€ë¶„ ì—…ë°ì´íŠ¸** | íŠ¹ì • í•„ë“œë§Œ ë³€ê²½ | âœ… íš¨ìœ¨ì  | âœ… ëª…í™• |
| **ì „ì²´ êµì²´** | Aggregate ì „ì²´ êµì²´ | âš ï¸ ëª¨ë“  í•„ë“œ ë³€ê²½ | âš ï¸ ì˜ë„ ë¶ˆëª…í™• |

---

## Outbox Pattern êµ¬í˜„

### ìœ„ì¹˜
`infrastructure/outbox/`

### ì±…ì„
- OutboxEventClient Port êµ¬í˜„
- Domain Model â†’ Kafka Event Payload ë³€í™˜
- Outbox ë¼ì´ë¸ŒëŸ¬ë¦¬ í˜¸ì¶œ

### Outbox íë¦„

```
OrderCreator (Domain Service)
  1. orderRepository.store(order)        â†’ Order ì €ì¥ (DB)
  2. outboxEventAppender.append(order)   â†’ Outbox ì €ì¥ (DB, ê°™ì€ íŠ¸ëœì­ì…˜)
     â†’ outboxEventClient.save()          â†’ Infrastructure Layer
       â†’ KafkaOutboxEventMapper.map()    â†’ Order â†’ KafkaEvent ë³€í™˜
       â†’ outboxEventService.registerEvent() â†’ Outbox ë¼ì´ë¸ŒëŸ¬ë¦¬ í˜¸ì¶œ
```

### KafkaOutboxEventClient (Adapter)

```java
// infrastructure/outbox/KafkaOutboxEventClient.java
@Repository
@RequiredArgsConstructor
@Slf4j
public class KafkaOutboxEventClient implements OutboxEventClient {

  private final OutboxEventService outboxEventService;
  private final KafkaOutboxEventMapper outboxEventMapper = new KafkaOutboxEventMapper();

  /**
   * Domain Eventë¥¼ Outboxì— ì €ì¥
   */
  @Override
  public void save(OutboxEventType eventType, AggregateRoot aggregateRoot) {
    KafkaOutboxEvent event = outboxEventMapper.map(eventType, aggregateRoot);
    outboxEventService.registerEvent(event.kafkaEvent(), event.eventKey());
  }
}
```

### KafkaOutboxEventMapper

```java
// infrastructure/outbox/KafkaOutboxEventMapper.java
class KafkaOutboxEventMapper {

  private final KafkaEventSource ORDER_EVENT_SOURCE = KafkaEventSource.ORDER;

  public KafkaOutboxEvent map(OutboxEventType eventType, AggregateRoot aggregateRoot) {
    if (eventType == OutboxEventType.ORDER_CREATED) {
      Order order = (Order) aggregateRoot;
      return mapToOrderCreatedEvent(order);
    }

    throw new IllegalArgumentException("ì§€ì›í•˜ì§€ ì•ŠëŠ” ì´ë²¤íŠ¸ íƒ€ì…ì…ë‹ˆë‹¤: " + eventType);
  }

  private KafkaOutboxEvent mapToOrderCreatedEvent(Order order) {
    // 1. Items ë§¤í•‘
    List<OrderCreatedOrderItem> items = order.getItems().stream()
        .map(item -> OrderCreatedOrderItem.builder()
            .itemName(item.itemName())
            .quantity(item.quantity())
            .price(item.price().amount())
            .category(item.category())
            .weight(item.weight() != null ? item.weight().value() : null)
            .build())
        .toList();

    // 2. Origin/Destination ë§¤í•‘
    OrderCreatedOrderLocation originLocation = mapToLocation(order.getOrigin());
    OrderCreatedOrderLocation destinationLocation = mapToLocation(order.getDestination());

    // 3. Delivery Policy ë§¤í•‘
    OrderCreatedOrderDeliveryPolicy deliveryPolicy = mapToDeliveryPolicy(order.getDeliveryPolicy());

    // 4. Payload ìƒì„±
    OrderCreatedKafkaEventPayload payload = OrderCreatedKafkaEventPayload.builder()
        .orderId(order.getId())
        .orderNumber(order.getOrderNumber().value())
        .orderStatus(order.getStatus().name())
        .items(items)
        .originLocation(originLocation)
        .destinationLocation(destinationLocation)
        .deliveryPolicy(deliveryPolicy)
        .orderedAt(order.getOrderedAt())
        .build();

    // 5. KafkaEvent ìƒì„±
    KafkaEvent<KafkaEventPayload> kafkaEvent = KafkaEvent.of(
        KafkaEventType.ORDER_ORDER_CREATED,
        ORDER_EVENT_SOURCE,
        payload);

    // 6. KafkaOutboxEvent ë°˜í™˜
    return new KafkaOutboxEvent(String.valueOf(order.getId()), kafkaEvent);
  }

  // í—¬í¼ ë©”ì„œë“œë“¤
  private OrderCreatedOrderLocation mapToLocation(Origin origin) { /* ... */ }
  private OrderCreatedOrderDeliveryPolicy mapToDeliveryPolicy(DeliveryPolicy policy) { /* ... */ }
}
```

### KafkaOutboxEvent (DTO)

```java
// infrastructure/outbox/KafkaOutboxEvent.java
record KafkaOutboxEvent(
    String eventKey,
    KafkaEvent<KafkaEventPayload> kafkaEvent
) { }
```

**íŠ¹ì§•:**
- âœ… DB íŠ¸ëœì­ì…˜ê³¼ ì´ë²¤íŠ¸ ë°œí–‰ì˜ ì›ìì„± ë³´ì¥
- âœ… Order ì €ì¥ + Outbox ì €ì¥ = í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜
- âœ… ë³„ë„ Workerê°€ Outbox â†’ Kafka ì „ì†¡ (ë¹„ë™ê¸°)
- âœ… ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„ ë³´ì¥

## ì™¸ë¶€ API Adapter ê·œì¹™

### ìœ„ì¹˜
`infrastructure/external/`

### ì±…ì„
- ì™¸ë¶€ ì‹œìŠ¤í…œ ì—°ë™
- Application Port êµ¬í˜„
- Feign Client ì‚¬ìš©

### ì™¸ë¶€ API Adapter í…œí”Œë¦¿

```java
// infrastructure/external/client/PaymentFeignClient.java
@FeignClient(name = "payment-service", url = "${payment.service.url}")
public interface PaymentFeignClient {
    
    @PostMapping("/api/v1/payments")
    PaymentApiResponse processPayment(@RequestBody PaymentApiRequest request);
    
    @PostMapping("/api/v1/payments/{paymentId}/cancel")
    void cancelPayment(@PathVariable Long paymentId);
    
    @PostMapping("/api/v1/payments/{paymentId}/refund")
    void refundPayment(
        @PathVariable Long paymentId,
        @RequestBody RefundApiRequest request
    );
}
```

```java
// infrastructure/external/adapter/PaymentAdapter.java
@Component
@RequiredArgsConstructor
public class PaymentAdapter implements PaymentPort {
    
    private final PaymentFeignClient paymentClient;
    
    @Override
    public Payment processPayment(Long orderId, Money amount, PaymentMethod method) {
        PaymentApiRequest request = PaymentApiRequest.builder()
            .orderId(orderId)
            .amount(amount.value())
            .method(method.name())
            .build();
        
        try {
            PaymentApiResponse response = paymentClient.processPayment(request);
            
            return Payment.builder()
                .id(response.paymentId())
                .orderId(orderId)
                .amount(Money.of(response.amount()))
                .method(method)
                .status(PaymentStatus.valueOf(response.status()))
                .build();
                
        } catch (FeignException e) {
            throw new PaymentProcessingException("ê²°ì œ ì²˜ë¦¬ ì‹¤íŒ¨", e);
        }
    }
    
    @Override
    public void cancelPayment(Long paymentId) {
        try {
            paymentClient.cancelPayment(paymentId);
        } catch (FeignException e) {
            throw new PaymentCancellationException("ê²°ì œ ì·¨ì†Œ ì‹¤íŒ¨", e);
        }
    }
}
```

## Kafka Event Publisher ê·œì¹™

### ìœ„ì¹˜
`infrastructure/messaging/adapter/`

### Kafka Event Publisher í…œí”Œë¦¿

```java
// infrastructure/messaging/adapter/KafkaEventPublisher.java
@Component
@RequiredArgsConstructor
public class KafkaEventPublisher implements EventPublisher {
    
    private final KafkaTemplate<String, Object> kafkaTemplate;
    
    @Override
    public void publish(DomainEvent event) {
        String topic = resolveTopicName(event);
        String key = event.getAggregateId().toString();
        
        kafkaTemplate.send(topic, key, event)
            .whenComplete((result, ex) -> {
                if (ex != null) {
                    log.error("Failed to publish event: {}", event, ex);
                } else {
                    log.info("Event published successfully: {}", event);
                }
            });
    }
    
    private String resolveTopicName(DomainEvent event) {
        return switch (event) {
            case OrderCreatedEvent e -> "order.created";
            case OrderCancelledEvent e -> "order.cancelled";
            case OrderStatusChangedEvent e -> "order.status-changed";
            default -> throw new IllegalArgumentException("Unknown event type");
        };
    }
}
```

```java
// infrastructure/messaging/adapter/OrderEventConsumer.java
@Component
@RequiredArgsConstructor
public class OrderEventConsumer {
    
    private final OrderStore orderStore;
    
    @KafkaListener(topics = "inventory.reserved", groupId = "order-service")
    public void handleInventoryReserved(InventoryReservedEvent event) {
        Order order = orderStore.findById(event.orderId())
            .orElseThrow();
        
        order.confirmInventoryReserved();
        orderStore.save(order);
    }
    
    @KafkaListener(topics = "payment.completed", groupId = "order-service")
    public void handlePaymentCompleted(PaymentCompletedEvent event) {
        Order order = orderStore.findById(event.orderId())
            .orElseThrow();
        
        order.completePayment(event.paymentId());
        orderStore.save(order);
    }
}
```

## Cache Adapter ê·œì¹™

### ìœ„ì¹˜
`infrastructure/storage/cache/`

### Cache Adapter í…œí”Œë¦¿

```java
// infrastructure/storage/cache/order/OrderCacheAdapter.java
@Component
@RequiredArgsConstructor
public class OrderCacheAdapter {
    
    private final RedisTemplate<String, OrderCacheDto> redisTemplate;
    
    private static final String CACHE_KEY_PREFIX = "order:";
    private static final Duration CACHE_TTL = Duration.ofMinutes(10);
    
    public Optional<Order> findById(Long orderId) {
        String key = CACHE_KEY_PREFIX + orderId;
        OrderCacheDto cached = redisTemplate.opsForValue().get(key);
        
        return Optional.ofNullable(cached)
            .map(OrderCacheDto::toDomain);
    }
    
    public void save(Order order) {
        String key = CACHE_KEY_PREFIX + order.getId();
        OrderCacheDto dto = OrderCacheDto.from(order);
        redisTemplate.opsForValue().set(key, dto, CACHE_TTL);
    }
    
    public void evict(Long orderId) {
        String key = CACHE_KEY_PREFIX + orderId;
        redisTemplate.delete(key);
    }
}
```

## ì„¤ì • íŒŒì¼

### JPA Config

```java
// infrastructure/config/JpaConfig.java
@Configuration
@EnableJpaAuditing
@EnableJpaRepositories(basePackages = "vroong.laas.order.infrastructure.storage.db")
public class JpaConfig {
}
```

### QueryDSL Config

```java
// infrastructure/config/QueryDslConfig.java
@Configuration
public class QueryDslConfig {
    
    @Bean
    public JPAQueryFactory jpaQueryFactory(EntityManager entityManager) {
        return new JPAQueryFactory(entityManager);
    }
}
```

### Feign Config

```java
// infrastructure/config/FeignConfig.java
@Configuration
public class FeignConfig {
    
    @Bean
    public Logger.Level feignLoggerLevel() {
        return Logger.Level.FULL;
    }
    
    @Bean
    public ErrorDecoder errorDecoder() {
        return new CustomErrorDecoder();
    }
}
```

## ì ˆëŒ€ ê¸ˆì§€ ì‚¬í•­
1. Entityì— ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì‘ì„± ê¸ˆì§€
2. EAGER fetch ì‚¬ìš© ê¸ˆì§€
3. Entityê°€ Domainì„ ìƒì†í•˜ëŠ” ê²ƒ ê¸ˆì§€
4. Adapterì—ì„œ ì§ì ‘ Domain ë¡œì§ ì‹¤í–‰ ê¸ˆì§€
5. ì–‘ë°©í–¥ ì—°ê´€ê´€ê³„ ë‚¨ë°œ ê¸ˆì§€

## ì¤‘ìš” ì›ì¹™
1. EntityëŠ” ë‹¨ìˆœ ë°ì´í„° êµ¬ì¡°ì²´
2. from/toDomainìœ¼ë¡œ ëª…í™•í•œ ë³€í™˜
3. AdapterëŠ” ì¸í„°í˜ì´ìŠ¤ êµ¬í˜„ë§Œ
4. QueryDSLë¡œ ë™ì  ì¿¼ë¦¬
5. ì™¸ë¶€ API ì˜¤ë¥˜ëŠ” Domain ì˜ˆì™¸ë¡œ ë³€í™˜---
alwaysApply: true
---

# Interfaces Layer ê·œì¹™

## ìœ„ì¹˜
`api/`, `admin/`, `worker/`

## ì±…ì„
- ì™¸ë¶€ ì§„ì…ì  (Controller, gRPC Service, Batch Job)
- Facade í˜¸ì¶œ
- DTO ë³€í™˜ (Request â†’ Command, Domain â†’ Response)
- ì˜ˆì™¸ ì²˜ë¦¬
- CommandëŠ” Domain Layerì— ìœ„ì¹˜

## Web Controller ê·œì¹™ (api/web/)

### ìœ„ì¹˜
`api/web/*/`

### ì±…ì„
- HTTP API ì œê³µ
- Facadeë§Œ í˜¸ì¶œ
- Request â†’ Command ë³€í™˜ (CommandëŠ” Domain Layerì—ì„œ ê°€ì ¸ì˜´)
- Domain â†’ Response ë³€í™˜

### ë°˜ë“œì‹œ í•´ì•¼ í•  ê²ƒ
1. @RestController ì‚¬ìš©
2. Facadeë§Œ ì˜ì¡´
3. Request DTOì—ì„œ Command ë³€í™˜ (CommandëŠ” Domain Layerì—ì„œ import)
4. Domainì—ì„œ Response DTO ë³€í™˜
5. Bean Validation ì‚¬ìš©

### ì ˆëŒ€ í•˜ì§€ ë§ ê²ƒ
1. ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì‘ì„± ê¸ˆì§€
2. Domain Service ì§ì ‘ í˜¸ì¶œ ê¸ˆì§€
3. Repository ì§ì ‘ ì˜ì¡´ ê¸ˆì§€
4. íŠ¸ëœì­ì…˜ ê´€ë¦¬ ê¸ˆì§€ (Domain Serviceì—ì„œ)

### Web Controller í…œí”Œë¦¿

#### ì¼ë°˜ í…œí”Œë¦¿

```java
// api/web/{aggregate}/{Aggregate}Controller.java
@RestController
@RequestMapping("/api/v1/{aggregates}")
@RequiredArgsConstructor
public class {Aggregate}Controller {
    
    private final {Aggregate}Facade {aggregate}Facade;  // â­ Facade ì‚¬ìš©
    
    @PostMapping
    @ResponseStatus(HttpStatus.CREATED)
    public {Aggregate}Response create{Aggregate}(@RequestBody @Valid Create{Aggregate}Request request) {
        // Request â†’ Command ë³€í™˜ (CommandëŠ” Domain Layerì—ì„œ import)
        Create{Aggregate}Command command = request.toCommand();
        
        // Facade í˜¸ì¶œ
        {Aggregate} {aggregate} = {aggregate}Facade.create{Aggregate}(command);
        
        // Domain â†’ Response ë³€í™˜
        return {Aggregate}Response.from({aggregate});
    }
    
    @GetMapping("/{id}")
    public {Aggregate}Response get{Aggregate}(@PathVariable Long id) {
        // Facade í˜¸ì¶œ
        {Aggregate} {aggregate} = {aggregate}Facade.get{Aggregate}ById(id);
        
        return {Aggregate}Response.from({aggregate});
    }
    
    @GetMapping("/{aggregate}-number/{number}")
    public {Aggregate}Response get{Aggregate}By{Aggregate}Number(@PathVariable String number) {
        {Aggregate}Number {aggregate}NumberVO = {Aggregate}Number.of(number);
        
        // Facade í˜¸ì¶œ
        {Aggregate} {aggregate} = {aggregate}Facade.get{Aggregate}By{Aggregate}Number({aggregate}NumberVO);
        
        return {Aggregate}Response.from({aggregate});
    }
}
```

**íŠ¹ì§•:**
- âœ… Facadeë§Œ ì˜ì¡´
- âœ… CommandëŠ” Domain Layerì—ì„œ import
- âœ… @ResponseStatusë¡œ ê°„ê²°í•œ ìƒíƒœ ì½”ë“œ ê´€ë¦¬
- âœ… ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì—†ìŒ (ë‹¨ìˆœ ìœ„ì„)

#### ì‹¤ì œ ì˜ˆì‹œ (Order)

```java
// api/web/order/OrderController.java
@RestController
@RequestMapping("/api/v1/orders")
@RequiredArgsConstructor
public class OrderController {
    
    private final OrderFacade orderFacade;  // â­ Facade ì‚¬ìš©
    
    @PostMapping
    @ResponseStatus(HttpStatus.CREATED)
    public OrderResponse createOrder(@RequestBody @Valid CreateOrderRequest request) {
        // Request â†’ Command ë³€í™˜ (CommandëŠ” Domain Layerì—ì„œ import)
        CreateOrderCommand command = request.toCommand();
        
        // Facade í˜¸ì¶œ
        Order order = orderFacade.createOrder(command);
        
        // Domain â†’ Response ë³€í™˜
        return OrderResponse.from(order);
    }
    
    @GetMapping("/{orderId}")
    public OrderResponse getOrder(@PathVariable Long orderId) {
        // Facade í˜¸ì¶œ
        Order order = orderFacade.getOrderById(orderId);
        
        return OrderResponse.from(order);
    }
    
    @GetMapping("/order-number/{orderNumber}")
    public OrderResponse getOrderByOrderNumber(@PathVariable String orderNumber) {
        OrderNumber orderNumberVO = OrderNumber.of(orderNumber);
        
        // Facade í˜¸ì¶œ
        Order order = orderFacade.getOrderByOrderNumber(orderNumberVO);
        
        return OrderResponse.from(order);
    }
}
```

## Request DTO ê·œì¹™

### ìœ„ì¹˜
`api/web/*/dto/request/`

### ì±…ì„
- HTTP ìš”ì²­ ë°ì´í„° ìˆ˜ì‹ 
- Bean Validationìœ¼ë¡œ í˜•ì‹ ê²€ì¦

### Request DTO í…œí”Œë¦¿

#### ì¼ë°˜ í…œí”Œë¦¿

```java
// api/web/{aggregate}/dto/request/Create{Aggregate}Request.java
public record Create{Aggregate}Request(
    @NotNull(message = "í•„ìˆ˜ í•„ë“œì…ë‹ˆë‹¤")
    @Size(min = 1, message = "ìµœì†Œ 1ê°œ ì´ìƒ í•„ìš”í•©ë‹ˆë‹¤")
    List<{Aggregate}ItemRequest> items,
    
    @NotBlank(message = "í•„ìˆ˜ í•„ë“œì…ë‹ˆë‹¤")
    @Size(max = 500, message = "500ì ì´ë‚´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”")
    String requiredField,
    
    Long optionalId
) {
    public record {Aggregate}ItemRequest(
        @NotNull(message = "IDëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤")
        @Positive(message = "IDëŠ” ì–‘ìˆ˜ì—¬ì•¼ í•©ë‹ˆë‹¤")
        Long id,
        
        @Min(value = 1, message = "ìµœì†Œê°’ì€ 1ì…ë‹ˆë‹¤")
        @Max(value = 100, message = "ìµœëŒ€ê°’ì€ 100ì…ë‹ˆë‹¤")
        int quantity
    ) {}
}
```

```java
// api/web/{aggregate}/dto/request/Cancel{Aggregate}Request.java
public record Cancel{Aggregate}Request(
    @NotBlank(message = "ì·¨ì†Œ ì‚¬ìœ ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤")
    @Size(max = 1000, message = "ì·¨ì†Œ ì‚¬ìœ ëŠ” 1000ì ì´ë‚´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”")
    String reason
) {}
```

#### ì‹¤ì œ ì˜ˆì‹œ (Order)

```java
// api/web/order/dto/request/CreateOrderRequest.java
public record CreateOrderRequest(
    @NotNull(message = "ìƒí’ˆ ëª©ë¡ì€ í•„ìˆ˜ì…ë‹ˆë‹¤")
    @Size(min = 1, message = "ìµœì†Œ 1ê°œ ì´ìƒì˜ ìƒí’ˆì´ í•„ìš”í•©ë‹ˆë‹¤")
    List<OrderItemRequest> items,
    
    @NotBlank(message = "ë°°ì†¡ì§€ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤")
    @Size(max = 500, message = "ë°°ì†¡ì§€ëŠ” 500ì ì´ë‚´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”")
    String deliveryAddress,
    
    Long couponId
) {
    public record OrderItemRequest(
        @NotNull(message = "ìƒí’ˆ IDëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤")
        @Positive(message = "ìƒí’ˆ IDëŠ” ì–‘ìˆ˜ì—¬ì•¼ í•©ë‹ˆë‹¤")
        Long productId,
        
        @Min(value = 1, message = "ìˆ˜ëŸ‰ì€ ìµœì†Œ 1ê°œ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤")
        @Max(value = 100, message = "ìˆ˜ëŸ‰ì€ ìµœëŒ€ 100ê°œê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤")
        int quantity
    ) {}
}
```

```java
// api/web/order/dto/request/CancelOrderRequest.java
public record CancelOrderRequest(
    @NotBlank(message = "ì·¨ì†Œ ì‚¬ìœ ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤")
    @Size(max = 1000, message = "ì·¨ì†Œ ì‚¬ìœ ëŠ” 1000ì ì´ë‚´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”")
    String reason
) {}
```

## Response DTO ê·œì¹™

### ìœ„ì¹˜
`api/web/*/dto/response/`

### ì±…ì„
- HTTP ì‘ë‹µ ë°ì´í„° ë°˜í™˜
- Domainì—ì„œ DTO ë³€í™˜

### Response DTO í…œí”Œë¦¿

```java
// api/web/order/dto/response/OrderResponse.java
public record OrderResponse(
    Long id,
    String orderNumber,
    String status,
    BigDecimal totalAmount,
    String deliveryAddress,
    List<OrderItemResponse> items,
    LocalDateTime createdAt
) {
    public static OrderResponse from(Order order) {
        return new OrderResponse(
            order.getId(),
            order.getOrderNumber(),
            order.getStatus().name(),
            order.getTotalAmount().value(),
            order.getDeliveryAddress().getFullAddress(),
            order.getItems().stream()
                .map(OrderItemResponse::from)
                .toList(),
            order.getCreatedAt()
        );
    }
    
    public record OrderItemResponse(
        Long productId,
        String productName,
        int quantity,
        BigDecimal unitPrice,
        BigDecimal subtotal
    ) {
        public static OrderItemResponse from(OrderItem item) {
            return new OrderItemResponse(
                item.getProductId(),
                item.getProductName(),
                item.getQuantity(),
                item.getUnitPrice().value(),
                item.getSubtotal().value()
            );
        }
    }
}
```

```java
// api/web/order/dto/response/OrderSummaryResponse.java
public record OrderSummaryResponse(
    Long id,
    String orderNumber,
    String status,
    BigDecimal totalAmount,
    int itemCount,
    LocalDateTime createdAt
) {
    public static OrderSummaryResponse from(OrderSummary summary) {
        return new OrderSummaryResponse(
            summary.id(),
            summary.orderNumber(),
            summary.status(),
            summary.totalAmount(),
            summary.itemCount(),
            summary.createdAt()
        );
    }
}
```

## Exception Handler ê·œì¹™

### ìœ„ì¹˜
`api/web/config/`

### Exception Handler í…œí”Œë¦¿

```java
// api/web/config/ApiExceptionHandler.java
@RestControllerAdvice
@Slf4j
public class ApiExceptionHandler {
    
    // Domain ì˜ˆì™¸
    @ExceptionHandler(OrderNotFoundException.class)
    public ResponseEntity<ErrorResponse> handleOrderNotFound(
        OrderNotFoundException e
    ) {
        log.warn("Order not found: {}", e.getMessage());
        
        ErrorResponse response = ErrorResponse.of(
            "ORDER_NOT_FOUND",
            e.getMessage()
        );
        
        return ResponseEntity
            .status(HttpStatus.NOT_FOUND)
            .body(response);
    }
    
    @ExceptionHandler(OrderNotCancellableException.class)
    public ResponseEntity<ErrorResponse> handleOrderNotCancellable(
        OrderNotCancellableException e
    ) {
        log.warn("Order not cancellable: {}", e.getMessage());
        
        ErrorResponse response = ErrorResponse.of(
            "ORDER_NOT_CANCELLABLE",
            e.getMessage()
        );
        
        return ResponseEntity
            .status(HttpStatus.BAD_REQUEST)
            .body(response);
    }
    
    // Validation ì˜ˆì™¸
    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ResponseEntity<ErrorResponse> handleValidation(
        MethodArgumentNotValidException e
    ) {
        Map<String, String> errors = new HashMap<>();
        
        e.getBindingResult().getFieldErrors().forEach(error ->
            errors.put(error.getField(), error.getDefaultMessage())
        );
        
        ErrorResponse response = ErrorResponse.of(
            "VALIDATION_ERROR",
            "ì…ë ¥ê°’ ê²€ì¦ ì‹¤íŒ¨",
            errors
        );
        
        return ResponseEntity
            .status(HttpStatus.BAD_REQUEST)
            .body(response);
    }
    
    // ì¼ë°˜ ì˜ˆì™¸
    @ExceptionHandler(Exception.class)
    public ResponseEntity<ErrorResponse> handleException(Exception e) {
        log.error("Unexpected error", e);
        
        ErrorResponse response = ErrorResponse.of(
            "INTERNAL_SERVER_ERROR",
            "ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤"
        );
        
        return ResponseEntity
            .status(HttpStatus.INTERNAL_SERVER_ERROR)
            .body(response);
    }
}
```

```java
// api/web/config/ErrorResponse.java
public record ErrorResponse(
    String code,
    String message,
    Map<String, String> errors,
    LocalDateTime timestamp
) {
    public static ErrorResponse of(String code, String message) {
        return new ErrorResponse(
            code,
            message,
            Collections.emptyMap(),
            LocalDateTime.now()
        );
    }
    
    public static ErrorResponse of(
        String code,
        String message,
        Map<String, String> errors
    ) {
        return new ErrorResponse(
            code,
            message,
            errors,
            LocalDateTime.now()
        );
    }
}
```

## gRPC Service ê·œì¹™ (api/grpc/)

### ìœ„ì¹˜
`api/grpc/*/`

### gRPC Service í…œí”Œë¦¿

```java
// api/grpc/order/OrderGrpcService.java
@GrpcService
@RequiredArgsConstructor
public class OrderGrpcService extends OrderServiceGrpc.OrderServiceImplBase {
    
    private final CreateOrderUseCase createOrderUseCase;
    private final GetOrderUseCase getOrderUseCase;
    private final OrderGrpcMapper mapper;
    
    @Override
    public void createOrder(
        CreateOrderGrpcRequest request,
        StreamObserver<OrderGrpcResponse> responseObserver
    ) {
        try {
            // gRPC Request â†’ Command
            CreateOrderCommand command = mapper.toCommand(request);
            
            // Use Case ì‹¤í–‰
            Order order = createOrderUseCase.execute(command);
            
            // Domain â†’ gRPC Response
            OrderGrpcResponse response = mapper.toResponse(order);
            
            responseObserver.onNext(response);
            responseObserver.onCompleted();
            
        } catch (Exception e) {
            responseObserver.onError(
                Status.INTERNAL
                    .withDescription(e.getMessage())
                    .asRuntimeException()
            );
        }
    }
    
    @Override
    public void getOrder(
        GetOrderGrpcRequest request,
        StreamObserver<OrderGrpcResponse> responseObserver
    ) {
        try {
            GetOrderQuery query = new GetOrderQuery(
                request.getOrderId(),
                request.getUserId()
            );
            
            Order order = getOrderUseCase.execute(query);
            
            OrderGrpcResponse response = mapper.toResponse(order);
            
            responseObserver.onNext(response);
            responseObserver.onCompleted();
            
        } catch (OrderNotFoundException e) {
            responseObserver.onError(
                Status.NOT_FOUND
                    .withDescription(e.getMessage())
                    .asRuntimeException()
            );
        } catch (Exception e) {
            responseObserver.onError(
                Status.INTERNAL
                    .withDescription(e.getMessage())
                    .asRuntimeException()
            );
        }
    }
}
```

```java
// api/grpc/order/mapper/OrderGrpcMapper.java
@Component
public class OrderGrpcMapper {
    
    public CreateOrderCommand toCommand(CreateOrderGrpcRequest request) {
        List<CreateOrderCommand.OrderItemCommand> items = request.getItemsList()
            .stream()
            .map(item -> new CreateOrderCommand.OrderItemCommand(
                item.getProductId(),
                item.getQuantity()
            ))
            .toList();
        
        return CreateOrderCommand.builder()
            .userId(request.getUserId())
            .items(items)
            .deliveryAddress(request.getDeliveryAddress())
            .couponId(request.hasCouponId() ? request.getCouponId() : null)
            .build();
    }
    
    public OrderGrpcResponse toResponse(Order order) {
        List<OrderItemGrpcResponse> items = order.getItems().stream()
            .map(item -> OrderItemGrpcResponse.newBuilder()
                .setProductId(item.getProductId())
                .setProductName(item.getProductName())
                .setQuantity(item.getQuantity())
                .setUnitPrice(item.getUnitPrice().value().doubleValue())
                .build())
            .toList();
        
        return OrderGrpcResponse.newBuilder()
            .setOrderId(order.getId())
            .setOrderNumber(order.getOrderNumber())
            .setStatus(order.getStatus().name())
            .setTotalAmount(order.getTotalAmount().value().doubleValue())
            .addAllItems(items)
            .build();
    }
}
```

## Admin Controller ê·œì¹™ (admin/web/)

### ìœ„ì¹˜
`admin/web/*/`

### Admin Controller í…œí”Œë¦¿

```java
// admin/web/order/OrderAdminController.java
@RestController
@RequestMapping("/admin/api/v1/orders")
@RequiredArgsConstructor
public class OrderAdminController {
    
    private final OrderAdminQueryService orderAdminQueryService;
    private final OrderAdminCommandService orderAdminCommandService;
    
    @GetMapping
    public ResponseEntity<Page<OrderAdminResponse>> searchOrders(
        @ModelAttribute OrderSearchRequest request,
        Pageable pageable
    ) {
        OrderSearchCondition condition = OrderSearchCondition.builder()
            .userId(request.userId())
            .status(request.status())
            .startDate(request.startDate())
            .endDate(request.endDate())
            .build();
        
        Page<Order> orders = orderAdminQueryService.searchOrders(condition, pageable);
        
        Page<OrderAdminResponse> response = orders.map(OrderAdminResponse::from);
        
        return ResponseEntity.ok(response);
    }
    
    @PostMapping("/{orderId}/force-cancel")
    public ResponseEntity<Void> forceCancel(
        @PathVariable Long orderId,
        @RequestBody @Valid AdminCancelRequest request
    ) {
        CancelOrderCommand command = CancelOrderCommand.builder()
            .orderId(orderId)
            .reason(request.reason())
            .cancelType(CancelType.ADMIN)
            .adminId(request.adminId())
            .adminMemo(request.adminMemo())
            .build();
        
        orderAdminCommandService.forceCancel(command);
        
        return ResponseEntity.noContent().build();
    }
    
    @GetMapping("/statistics")
    public ResponseEntity<OrderStatisticsResponse> getStatistics(
        @RequestParam LocalDate startDate,
        @RequestParam LocalDate endDate
    ) {
        OrderStatistics statistics = orderAdminQueryService.getStatistics(
            startDate,
            endDate
        );
        
        return ResponseEntity.ok(OrderStatisticsResponse.from(statistics));
    }
}
```

## Batch Job ê·œì¹™ (worker/job/)

### ìœ„ì¹˜
`worker/job/*/`

### Batch Job í…œí”Œë¦¿

```java
// worker/job/order/OrderCleanupJob.java
@Component
@RequiredArgsConstructor
@Slf4j
public class OrderCleanupJob {
    
    private final OrderReader orderReader;
    private final OrderStore orderStore;
    
    @Scheduled(cron = "0 0 2 * * *")  // ë§¤ì¼ ìƒˆë²½ 2ì‹œ
    public void cleanupExpiredOrders() {
        log.info("Starting order cleanup job");
        
        LocalDate cutoffDate = LocalDate.now().minusDays(30);
        
        OrderSearchCondition condition = OrderSearchCondition.builder()
            .status(OrderStatus.CANCELLED)
            .endDate(cutoffDate)
            .build();
        
        Page<Order> orders = orderReader.searchOrders(
            condition,
            PageRequest.of(0, 100)
        );
        
        orders.forEach(order -> {
            orderStore.delete(order);
            log.info("Deleted expired order: {}", order.getOrderNumber());
        });
        
        log.info("Order cleanup job completed. Deleted {} orders", orders.getSize());
    }
}
```

```java
// worker/job/order/OrderStatisticsJob.java
@Component
@RequiredArgsConstructor
@Slf4j
public class OrderStatisticsJob {
    
    private final OrderReader orderReader;
    private final StatisticsStore statisticsStore;
    
    @Scheduled(cron = "0 30 0 * * *")  // ë§¤ì¼ 0ì‹œ 30ë¶„
    public void calculateDailyStatistics() {
        log.info("Starting daily statistics calculation");
        
        LocalDate yesterday = LocalDate.now().minusDays(1);
        
        OrderStatistics statistics = orderReader.calculateStatistics(
            yesterday,
            yesterday
        );
        
        statisticsStore.save(statistics);
        
        log.info("Daily statistics calculated for {}", yesterday);
    }
}
```

## Controller ì‘ë‹µ ê·œì¹™

### @ResponseStatus ì‚¬ìš© (ê¶Œì¥) â­

**ì‚¬ìš© ì‹œê¸°:**
- ìƒíƒœ ì½”ë“œê°€ ê³ ì •ëœ ê²½ìš°
- ìƒì„±(201), ì‚­ì œ(204) ë“±

**ì¥ì :**
- ì½”ë“œ ê°„ê²°
- ì˜ë„ ëª…í™• (ë©”ì„œë“œ ì„ ì–¸ë¶€ì— ìƒíƒœ ì½”ë“œ)
- ë¶ˆí•„ìš”í•œ ë˜í•‘ ì œê±°

**ì˜ˆì‹œ:**
```java
// ìƒì„± (201 Created)
@PostMapping
@ResponseStatus(HttpStatus.CREATED)
public OrderResponse createOrder(@RequestBody @Valid CreateOrderRequest request) {
    Order order = createOrderUseCase.execute(request.toCommand());
    return OrderResponse.from(order);
}

// ì¡°íšŒ (200 OK - ê¸°ë³¸ê°’)
@GetMapping("/{orderId}")
public OrderResponse getOrder(@PathVariable Long orderId) {
    Order order = getOrderUseCase.execute(orderId);
    return OrderResponse.from(order);
}

// ì‚­ì œ (204 No Content)
@DeleteMapping("/{orderId}")
@ResponseStatus(HttpStatus.NO_CONTENT)
public void cancelOrder(@PathVariable Long orderId) {
    cancelOrderUseCase.execute(orderId);
}
```

### ResponseEntity ì‚¬ìš© (í•„ìš”ì‹œë§Œ)

**ì‚¬ìš© ì‹œê¸°:**
- Location í—¤ë” ì¶”ê°€ í•„ìš”
- ì¡°ê±´ë¶€ ìƒíƒœ ì½”ë“œ
- ì»¤ìŠ¤í…€ í—¤ë” ì¶”ê°€

**ì˜ˆì‹œ:**
```java
// Location í—¤ë” ì¶”ê°€
@PostMapping
public ResponseEntity<OrderResponse> createOrder(...) {
    Order order = createOrderUseCase.execute(...);
    OrderResponse response = OrderResponse.from(order);
    
    return ResponseEntity
        .status(HttpStatus.CREATED)
        .header("Location", "/api/v1/orders/" + order.getId())
        .body(response);
}

// ì¡°ê±´ë¶€ ìƒíƒœ ì½”ë“œ
@GetMapping("/{orderId}")
public ResponseEntity<OrderResponse> getOrder(@PathVariable Long orderId) {
    Optional<Order> order = getOrderUseCase.execute(orderId);
    
    return order
        .map(o -> ResponseEntity.ok(OrderResponse.from(o)))
        .orElse(ResponseEntity.notFound().build());
}
```

### REST API ìƒíƒœ ì½”ë“œ ê´€ë¡€

| ìƒí™© | ìƒíƒœ ì½”ë“œ | ê¶Œì¥ ë°©ë²• |
|---|---|---|
| ì¡°íšŒ ì„±ê³µ | 200 OK | ê°ì²´ ì§ì ‘ ë°˜í™˜ |
| ìƒì„± ì„±ê³µ | 201 Created | @ResponseStatus |
| ìˆ˜ì • ì„±ê³µ | 200 OK | ê°ì²´ ì§ì ‘ ë°˜í™˜ |
| ì‚­ì œ ì„±ê³µ | 204 No Content | @ResponseStatus + void |
| ìœ íš¨ì„± ê²€ì¦ ì‹¤íŒ¨ | 400 Bad Request | ìë™ (Bean Validation) |
| ì¸ì¦ ì‹¤íŒ¨ | 401 Unauthorized | Security ì„¤ì • |
| ê¶Œí•œ ì—†ìŒ | 403 Forbidden | Security ì„¤ì • |
| ë¦¬ì†ŒìŠ¤ ì—†ìŒ | 404 Not Found | Exception Handler |
| ì„œë²„ ì˜¤ë¥˜ | 500 Internal Server Error | Exception Handler |

## ì¤‘ìš” ì›ì¹™
1. ControllerëŠ” Use Caseë§Œ í˜¸ì¶œ
2. Request â†’ Command, Domain â†’ Response ë³€í™˜
3. ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì ˆëŒ€ ê¸ˆì§€
4. Bean Validationìœ¼ë¡œ í˜•ì‹ ê²€ì¦
5. Exception Handlerë¡œ í†µì¼ëœ ì˜¤ë¥˜ ì‘ë‹µ# Validation ê·œì¹™

## ê²€ì¦ ë ˆì´ì–´ë³„ ì±…ì„

### ì „ì²´ íë¦„

```
Controller (í˜•ì‹ ê²€ì¦)
    â†“
Command (ê¸°ë³¸ ì •í•©ì„± ê²€ì¦)
    â†“
Application Support (ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™ ì‚¬ì „ ê²€ì¦)
    â†“
Domain Service (ë³µì¡í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™ ê²€ì¦)
    â†“
Domain Entity (í•µì‹¬ ë¶ˆë³€ì‹ ê²€ì¦)
```

## 1. Controller - í˜•ì‹ ê²€ì¦

### ìœ„ì¹˜
`api/web/*/dto/request/`

### ì±…ì„
- HTTP ìš”ì²­ì˜ í˜•ì‹ ê²€ì¦
- Bean Validation ì‚¬ìš©
- null, ë¹ˆ ê°’, íƒ€ì…, ê¸¸ì´, ë²”ìœ„ ë“±

### ê²€ì¦ ë‚´ìš©
- âœ… null ì²´í¬
- âœ… ë¹ˆ ë¬¸ìì—´ ì²´í¬
- âœ… ê¸¸ì´ ì œí•œ
- âœ… ìˆ«ì ë²”ìœ„
- âœ… ì´ë©”ì¼ í˜•ì‹
- âœ… ì •ê·œì‹ íŒ¨í„´

### ì˜ˆì‹œ

```java
// api/web/order/dto/request/CreateOrderRequest.java
public record CreateOrderRequest(
    @NotNull(message = "ìƒí’ˆ ëª©ë¡ì€ í•„ìˆ˜ì…ë‹ˆë‹¤")
    @Size(min = 1, max = 100, message = "ìƒí’ˆì€ 1~100ê°œê¹Œì§€ ì£¼ë¬¸ ê°€ëŠ¥í•©ë‹ˆë‹¤")
    List<OrderItemRequest> items,
    
    @NotBlank(message = "ë°°ì†¡ì§€ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤")
    @Size(max = 500, message = "ë°°ì†¡ì§€ëŠ” 500ì ì´ë‚´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”")
    String deliveryAddress,
    
    @Pattern(regexp = "^01[0-9]-[0-9]{3,4}-[0-9]{4}$", message = "ì˜¬ë°”ë¥¸ ì „í™”ë²ˆí˜¸ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤")
    String phoneNumber,
    
    @Email(message = "ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤")
    String email,
    
    Long couponId
) {
    public record OrderItemRequest(
        @NotNull(message = "ìƒí’ˆ IDëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤")
        @Positive(message = "ìƒí’ˆ IDëŠ” ì–‘ìˆ˜ì—¬ì•¼ í•©ë‹ˆë‹¤")
        Long productId,
        
        @Min(value = 1, message = "ìˆ˜ëŸ‰ì€ ìµœì†Œ 1ê°œ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤")
        @Max(value = 100, message = "ìˆ˜ëŸ‰ì€ ìµœëŒ€ 100ê°œê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤")
        int quantity,
        
        @Positive(message = "ê°€ê²©ì€ ì–‘ìˆ˜ì—¬ì•¼ í•©ë‹ˆë‹¤")
        BigDecimal price
    ) {}
}
```

**ê²€ì¦ ì‹¤íŒ¨ ì‹œ:**
```json
{
  "code": "VALIDATION_ERROR",
  "message": "ì…ë ¥ê°’ ê²€ì¦ ì‹¤íŒ¨",
  "errors": {
    "items": "ìƒí’ˆ ëª©ë¡ì€ í•„ìˆ˜ì…ë‹ˆë‹¤",
    "phoneNumber": "ì˜¬ë°”ë¥¸ ì „í™”ë²ˆí˜¸ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤"
  }
}
```

---

## 2. Command - ê¸°ë³¸ ì •í•©ì„± ê²€ì¦

### ìœ„ì¹˜
`core/application/*/usecase/command/`

### ì±…ì„
- ë°ì´í„° ì •í•©ì„± ê²€ì¦
- null ì²´í¬
- ë¹ˆ ì»¬ë ‰ì…˜ ì²´í¬
- ì¤‘ë³µ ì²´í¬
- ë…¼ë¦¬ì  ëª¨ìˆœ ì²´í¬

### ê²€ì¦ ë‚´ìš©
- âœ… í•„ìˆ˜ ê°’ ì²´í¬
- âœ… ë¹ˆ ë¦¬ìŠ¤íŠ¸/ì»¬ë ‰ì…˜ ì²´í¬
- âœ… ì¤‘ë³µ ë°ì´í„° ì²´í¬
- âœ… ìƒí˜¸ ë°°íƒ€ì  í•„ë“œ ì²´í¬
- âœ… ì¡°ê±´ë¶€ í•„ìˆ˜ í•„ë“œ ì²´í¬

### ì˜ˆì‹œ

```java
// core/application/order/usecase/command/CreateOrderCommand.java
@Builder
public record CreateOrderCommand(
    Long userId,
    List<OrderItemCommand> items,
    String deliveryAddress,
    String phoneNumber,
    Long couponId
) {
    // Compact Constructorì—ì„œ ê²€ì¦
    public CreateOrderCommand {
        // í•„ìˆ˜ ê°’ ì²´í¬
        if (userId == null || userId <= 0) {
            throw new IllegalArgumentException("ìœ íš¨í•˜ì§€ ì•Šì€ ì‚¬ìš©ì IDì…ë‹ˆë‹¤");
        }
        
        // ë¹ˆ ì»¬ë ‰ì…˜ ì²´í¬
        if (items == null || items.isEmpty()) {
            throw new IllegalArgumentException("ì£¼ë¬¸ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤");
        }
        
        // í•„ìˆ˜ ë¬¸ìì—´ ì²´í¬
        if (deliveryAddress == null || deliveryAddress.isBlank()) {
            throw new IllegalArgumentException("ë°°ì†¡ì§€ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤");
        }
        
        if (phoneNumber == null || phoneNumber.isBlank()) {
            throw new IllegalArgumentException("ì „í™”ë²ˆí˜¸ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤");
        }
        
        // ì¤‘ë³µ ìƒí’ˆ ì²´í¬
        long distinctCount = items.stream()
            .map(OrderItemCommand::productId)
            .distinct()
            .count();
        
        if (distinctCount != items.size()) {
            throw new IllegalArgumentException("ì¤‘ë³µëœ ìƒí’ˆì´ ìˆìŠµë‹ˆë‹¤");
        }
        
        // ê° OrderItem ê²€ì¦
        items.forEach(item -> {
            if (item.productId() == null || item.productId() <= 0) {
                throw new IllegalArgumentException("ìœ íš¨í•˜ì§€ ì•Šì€ ìƒí’ˆ IDì…ë‹ˆë‹¤");
            }
            if (item.quantity() < 1 || item.quantity() > 100) {
                throw new IllegalArgumentException("ìˆ˜ëŸ‰ì€ 1~100 ì‚¬ì´ì—¬ì•¼ í•©ë‹ˆë‹¤");
            }
        });
    }
    
    public record OrderItemCommand(
        Long productId,
        int quantity
    ) {}
}
```

```java
// core/application/order/usecase/command/CancelOrderCommand.java
@Builder
public record CancelOrderCommand(
    Long orderId,
    String reason,
    CancelType cancelType,
    
    // ì¡°ê±´ë¶€ í•„ìˆ˜ í•„ë“œ
    Long userId,
    Long adminId,
    String adminMemo,
    String systemCode
) {
    public CancelOrderCommand {
        if (orderId == null || orderId <= 0) {
            throw new IllegalArgumentException("ìœ íš¨í•˜ì§€ ì•Šì€ ì£¼ë¬¸ IDì…ë‹ˆë‹¤");
        }
        
        if (reason == null || reason.isBlank()) {
            throw new IllegalArgumentException("ì·¨ì†Œ ì‚¬ìœ ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤");
        }
        
        if (cancelType == null) {
            throw new IllegalArgumentException("ì·¨ì†Œ íƒ€ì…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤");
        }
        
        // íƒ€ì…ë³„ í•„ìˆ˜ í•„ë“œ ê²€ì¦
        switch (cancelType) {
            case CUSTOMER -> {
                if (userId == null) {
                    throw new IllegalArgumentException("ê³ ê° IDëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤");
                }
            }
            case ADMIN -> {
                if (adminId == null) {
                    throw new IllegalArgumentException("ê´€ë¦¬ì IDëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤");
                }
                if (adminMemo == null || adminMemo.isBlank()) {
                    throw new IllegalArgumentException("ê´€ë¦¬ì ë©”ëª¨ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤");
                }
            }
            case SYSTEM -> {
                if (systemCode == null || systemCode.isBlank()) {
                    throw new IllegalArgumentException("ì‹œìŠ¤í…œ ì½”ë“œëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤");
                }
            }
        }
    }
}
```

---

## 3. Application Support - ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™ ì‚¬ì „ ê²€ì¦

### ìœ„ì¹˜
`core/application/*/support/`

### ì±…ì„
- ì €ì¥ì†Œ ì¡°íšŒë¥¼ í†µí•œ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
- ìƒíƒœ í™•ì¸
- ê¶Œí•œ í™•ì¸
- ê¸°ê°„ í™•ì¸
- ìœ íš¨ì„± í™•ì¸

### ê²€ì¦ ë‚´ìš©
- âœ… ì—”í‹°í‹° ì¡´ì¬ ì—¬ë¶€
- âœ… ì—”í‹°í‹° ìƒíƒœ í™•ì¸ (í™œì„±í™”, ë§Œë£Œ ë“±)
- âœ… ê¶Œí•œ í™•ì¸
- âœ… ìœ íš¨ ê¸°ê°„ í™•ì¸
- âœ… ì‚¬ìš© ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸

### ì˜ˆì‹œ

```java
// core/application/order/support/OrderPreparationHelper.java
@Component
@RequiredArgsConstructor
public class OrderPreparationHelper {
    
    private final CustomerStore customerStore;
    private final CouponReader couponReader;
    private final ProductReader productReader;
    private final OrderValidationService orderValidationService;
    
    public OrderPreparationResult prepare(CreateOrderCommand command) {
        
        // 1. Customer ì¡´ì¬ ë° ìƒíƒœ í™•ì¸
        Customer customer = customerStore.findById(command.userId())
            .orElseThrow(() -> new CustomerNotFoundException(
                "ê³ ê°ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: " + command.userId()
            ));
        
        if (!customer.isActive()) {
            throw new InactiveCustomerException(
                "ë¹„í™œì„±í™”ëœ ê³ ê°ì…ë‹ˆë‹¤"
            );
        }
        
        if (customer.isSuspended()) {
            throw new CustomerSuspendedException(
                "ì •ì§€ëœ ê³ ê°ì…ë‹ˆë‹¤"
            );
        }
        
        // 2. Product ì¡´ì¬ ë° íŒë§¤ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
        List<Product> products = command.items().stream()
            .map(item -> {
                Product product = productReader.findById(item.productId())
                    .orElseThrow(() -> new ProductNotFoundException(
                        "ìƒí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: " + item.productId()
                    ));
                
                if (!product.isOnSale()) {
                    throw new ProductNotOnSaleException(
                        "íŒë§¤ ì¤‘ì´ ì•„ë‹Œ ìƒí’ˆì…ë‹ˆë‹¤: " + product.getName()
                    );
                }
                
                if (product.getStock() < item.quantity()) {
                    throw new InsufficientStockException(
                        "ì¬ê³ ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤: " + product.getName()
                    );
                }
                
                return product;
            })
            .toList();
        
        // 3. Coupon ì¡´ì¬ ë° ìœ íš¨ì„± í™•ì¸
        Coupon coupon = null;
        if (command.couponId() != null) {
            coupon = couponReader.findById(command.couponId())
                .orElseThrow(() -> new CouponNotFoundException(
                    "ì¿ í°ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: " + command.couponId()
                ));
            
            if (coupon.isExpired()) {
                throw new CouponExpiredException(
                    "ë§Œë£Œëœ ì¿ í°ì…ë‹ˆë‹¤"
                );
            }
            
            if (coupon.isUsed()) {
                throw new CouponAlreadyUsedException(
                    "ì´ë¯¸ ì‚¬ìš©ëœ ì¿ í°ì…ë‹ˆë‹¤"
                );
            }
            
            if (!coupon.isOwnedBy(customer.getId())) {
                throw new CouponOwnershipException(
                    "ë³¸ì¸ ì†Œìœ ì˜ ì¿ í°ì´ ì•„ë‹™ë‹ˆë‹¤"
                );
            }
        }
        
        // 4. Domain Serviceë¡œ ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™ ê²€ì¦ ìœ„ì„
        orderValidationService.validateOrderCreation(
            command.items(),
            coupon,
            customer
        );
        
        return OrderPreparationResult.builder()
            .customer(customer)
            .products(products)
            .coupon(coupon)
            .items(command.items())
            .build();
    }
}
```

```java
// core/application/order/support/OrderRetriever.java
@Component
@RequiredArgsConstructor
public class OrderRetriever {
    
    private final OrderStore orderStore;
    
    public Order getOrder(Long orderId) {
        return orderStore.findByIdWithItems(orderId)
            .orElseThrow(() -> new OrderNotFoundException(
                "ì£¼ë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: " + orderId
            ));
    }
    
    public Order getOrderWithOwnershipCheck(Long orderId, Long userId) {
        Order order = getOrder(orderId);
        
        // ê¶Œí•œ í™•ì¸
        if (!order.isOwnedBy(userId)) {
            throw new OrderAccessDeniedException(
                "í•´ë‹¹ ì£¼ë¬¸ì— ì ‘ê·¼í•  ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤"
            );
        }
        
        return order;
    }
}
```

---

## 4. Domain Service - ë³µì¡í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™ ê²€ì¦

### ìœ„ì¹˜
`core/domain/service/`

### ì±…ì„
- ì—¬ëŸ¬ Aggregateë¥¼ ì¡°í•©í•œ ë³µì¡í•œ ê·œì¹™ ê²€ì¦
- ì •ì±… ê¸°ë°˜ ê²€ì¦
- ê³„ì‚° ê¸°ë°˜ ê²€ì¦

### ê²€ì¦ ë‚´ìš©
- âœ… ì¼ì¼ ì£¼ë¬¸ í•œë„
- âœ… ë“±ê¸‰ë³„ í• ì¸ ì œí•œ
- âœ… ì¿ í° ì ìš© ì¡°ê±´
- âœ… ìµœì†Œ/ìµœëŒ€ ì£¼ë¬¸ ê¸ˆì•¡
- âœ… ë°°ì†¡ ê°€ëŠ¥ ì§€ì—­

### ì˜ˆì‹œ

```java
// core/domain/service/OrderValidationService.java
@DomainService
public class OrderValidationService {
    
    /**
     * ì£¼ë¬¸ ìƒì„± ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™ ê²€ì¦
     */
    public void validateOrderCreation(
        List<OrderItemCommand> items,
        Coupon coupon,
        Customer customer
    ) {
        // 1. ì¼ì¼ ì£¼ë¬¸ í•œë„ í™•ì¸
        validateDailyOrderLimit(customer);
        
        // 2. ìµœì†Œ ì£¼ë¬¸ ê¸ˆì•¡ í™•ì¸
        validateMinimumOrderAmount(items, customer.getGrade());
        
        // 3. ìµœëŒ€ ì£¼ë¬¸ ê¸ˆì•¡ í™•ì¸
        validateMaximumOrderAmount(items, customer.getGrade());
        
        // 4. ì¿ í° ì ìš© ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
        if (coupon != null) {
            validateCouponApplicability(items, coupon, customer);
        }
        
        // 5. ë“±ê¸‰ë³„ êµ¬ë§¤ ì œí•œ í™•ì¸
        validateGradeRestriction(items, customer.getGrade());
    }
    
    /**
     * ì¼ì¼ ì£¼ë¬¸ í•œë„ ê²€ì¦
     */
    private void validateDailyOrderLimit(Customer customer) {
        int dailyLimit = switch (customer.getGrade()) {
            case VIP -> 10;
            case GOLD -> 7;
            case SILVER -> 5;
            case BRONZE -> 3;
        };
        
        if (customer.getTodayOrderCount() >= dailyLimit) {
            throw new DailyOrderLimitExceededException(
                String.format("ì¼ì¼ ì£¼ë¬¸ í•œë„(%dê±´)ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤", dailyLimit)
            );
        }
    }
    
    /**
     * ìµœì†Œ ì£¼ë¬¸ ê¸ˆì•¡ ê²€ì¦
     */
    private void validateMinimumOrderAmount(
        List<OrderItemCommand> items,
        CustomerGrade grade
    ) {
        Money totalAmount = calculateTotalAmount(items);
        
        Money minimumAmount = switch (grade) {
            case VIP -> Money.of(0);
            case GOLD -> Money.of(10_000);
            case SILVER -> Money.of(20_000);
            case BRONZE -> Money.of(30_000);
        };
        
        if (totalAmount.isLessThan(minimumAmount)) {
            throw new MinimumOrderAmountException(
                String.format(
                    "ìµœì†Œ ì£¼ë¬¸ ê¸ˆì•¡ì€ %sì›ì…ë‹ˆë‹¤",
                    minimumAmount.value()
                )
            );
        }
    }
    
    /**
     * ìµœëŒ€ ì£¼ë¬¸ ê¸ˆì•¡ ê²€ì¦
     */
    private void validateMaximumOrderAmount(
        List<OrderItemCommand> items,
        CustomerGrade grade
    ) {
        Money totalAmount = calculateTotalAmount(items);
        
        Money maximumAmount = switch (grade) {
            case VIP -> Money.of(10_000_000);
            case GOLD -> Money.of(5_000_000);
            case SILVER -> Money.of(3_000_000);
            case BRONZE -> Money.of(1_000_000);
        };
        
        if (totalAmount.isGreaterThan(maximumAmount)) {
            throw new MaximumOrderAmountException(
                String.format(
                    "ìµœëŒ€ ì£¼ë¬¸ ê¸ˆì•¡ì€ %sì›ì…ë‹ˆë‹¤",
                    maximumAmount.value()
                )
            );
        }
    }
    
    /**
     * ì¿ í° ì ìš© ê°€ëŠ¥ ì—¬ë¶€ ê²€ì¦
     */
    private void validateCouponApplicability(
        List<OrderItemCommand> items,
        Coupon coupon,
        Customer customer
    ) {
        Money totalAmount = calculateTotalAmount(items);
        
        // ìµœì†Œ ì‚¬ìš© ê¸ˆì•¡ í™•ì¸
        if (totalAmount.isLessThan(coupon.getMinimumAmount())) {
            throw new CouponMinimumAmountException(
                String.format(
                    "ì¿ í° ì‚¬ìš© ê°€ëŠ¥ ìµœì†Œ ê¸ˆì•¡ì€ %sì›ì…ë‹ˆë‹¤",
                    coupon.getMinimumAmount().value()
                )
            );
        }
        
        // ë“±ê¸‰ ì œí•œ í™•ì¸
        if (!coupon.isApplicableForGrade(customer.getGrade())) {
            throw new CouponGradeRestrictionException(
                "í•´ë‹¹ ë“±ê¸‰ì—ì„œëŠ” ì‚¬ìš©í•  ìˆ˜ ì—†ëŠ” ì¿ í°ì…ë‹ˆë‹¤"
            );
        }
    }
    
    /**
     * ë“±ê¸‰ë³„ êµ¬ë§¤ ì œí•œ ê²€ì¦
     */
    private void validateGradeRestriction(
        List<OrderItemCommand> items,
        CustomerGrade grade
    ) {
        int maxQuantityPerItem = switch (grade) {
            case VIP -> 100;
            case GOLD -> 50;
            case SILVER -> 30;
            case BRONZE -> 10;
        };
        
        items.forEach(item -> {
            if (item.quantity() > maxQuantityPerItem) {
                throw new ItemQuantityLimitException(
                    String.format(
                        "ìƒí’ˆë‹¹ ìµœëŒ€ êµ¬ë§¤ ê°€ëŠ¥ ìˆ˜ëŸ‰ì€ %dê°œì…ë‹ˆë‹¤",
                        maxQuantityPerItem
                    )
                );
            }
        });
    }
    
    private Money calculateTotalAmount(List<OrderItemCommand> items) {
        // ê³„ì‚° ë¡œì§
        return Money.ZERO;
    }
}
```

---

## 5. Domain Entity - í•µì‹¬ ë¶ˆë³€ì‹ ê²€ì¦

### ìœ„ì¹˜
`core/domain/*/model/`

### ì±…ì„
- ì—”í‹°í‹°ì˜ í•µì‹¬ ë¶ˆë³€ì‹ ìœ ì§€
- ìƒíƒœ ì¼ê´€ì„± ë³´ì¥
- ê³„ì‚° ê²°ê³¼ ê²€ì¦

### ê²€ì¦ ë‚´ìš©
- âœ… í•„ìˆ˜ ê°’ ì¡´ì¬
- âœ… ìƒíƒœ ì „ì´ ê·œì¹™
- âœ… ê³„ì‚° ê²°ê³¼ ì¼ì¹˜
- âœ… ë¶ˆë³€ì‹ ìœ ì§€
- âœ… ë¹„ì¦ˆë‹ˆìŠ¤ ì œì•½ì‚¬í•­

### ì˜ˆì‹œ

```java
// core/domain/order/model/Order.java
@Getter
@Builder
@AllArgsConstructor(access = AccessLevel.PRIVATE)
public class Order {
    
    private Long id;
    private Long userId;
    private String orderNumber;
    private OrderStatus status;
    private List<OrderItem> items;
    private Address deliveryAddress;
    private Money totalAmount;
    private LocalDateTime createdAt;
    
    public static Order create(
        Long userId,
        List<OrderItem> items,
        Address deliveryAddress,
        Money totalAmount
    ) {
        Order order = Order.builder()
            .userId(userId)
            .orderNumber(generateOrderNumber())
            .status(OrderStatus.PENDING)
            .items(new ArrayList<>(items))
            .deliveryAddress(deliveryAddress)
            .totalAmount(totalAmount)
            .createdAt(LocalDateTime.now())
            .build();
        
        // ìƒì„± ì‹œ ê²€ì¦
        order.validate();
        
        return order;
    }
    
    /**
     * í•µì‹¬ ë¶ˆë³€ì‹ ê²€ì¦
     */
    private void validate() {
        // 1. í•„ìˆ˜ ê°’ ê²€ì¦
        if (userId == null || userId <= 0) {
            throw new InvalidOrderException("ìœ íš¨í•˜ì§€ ì•Šì€ ì‚¬ìš©ì IDì…ë‹ˆë‹¤");
        }
        
        if (orderNumber == null || orderNumber.isBlank()) {
            throw new InvalidOrderException("ì£¼ë¬¸ë²ˆí˜¸ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤");
        }
        
        if (items == null || items.isEmpty()) {
            throw new EmptyOrderException("ì£¼ë¬¸ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤");
        }
        
        if (deliveryAddress == null) {
            throw new InvalidOrderException("ë°°ì†¡ì§€ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤");
        }
        
        if (totalAmount == null || totalAmount.isNegative()) {
            throw new InvalidOrderException("ìœ íš¨í•˜ì§€ ì•Šì€ ì£¼ë¬¸ ê¸ˆì•¡ì…ë‹ˆë‹¤");
        }
        
        // 2. ê° OrderItem ê²€ì¦
        items.forEach(OrderItem::validate);
        
        // 3. ê³„ì‚°ëœ ê¸ˆì•¡ê³¼ ì‹¤ì œ ê¸ˆì•¡ ì¼ì¹˜ ê²€ì¦
        Money calculatedAmount = items.stream()
            .map(OrderItem::getSubtotal)
            .reduce(Money.ZERO, Money::add);
        
        if (!totalAmount.equals(calculatedAmount)) {
            throw new OrderAmountMismatchException(
                String.format(
                    "ì£¼ë¬¸ ê¸ˆì•¡ ë¶ˆì¼ì¹˜ - ì…ë ¥: %s, ê³„ì‚°: %s",
                    totalAmount.value(),
                    calculatedAmount.value()
                )
            );
        }
    }
    
    /**
     * ì·¨ì†Œ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸ (ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™)
     */
    public boolean isCancellable() {
        return status == OrderStatus.PENDING || 
               status == OrderStatus.PAID;
    }
    
    /**
     * ì£¼ë¬¸ ì·¨ì†Œ (ìƒíƒœ ì „ì´ ê²€ì¦)
     */
    public void cancel(String reason) {
        if (!isCancellable()) {
            throw new OrderNotCancellableException(
                String.format(
                    "í˜„ì¬ ìƒíƒœ(%s)ì—ì„œëŠ” ì·¨ì†Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤",
                    status
                )
            );
        }
        
        if (reason == null || reason.isBlank()) {
            throw new InvalidOrderException("ì·¨ì†Œ ì‚¬ìœ ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤");
        }
        
        this.status = OrderStatus.CANCELLED;
    }
    
    /**
     * ë°°ì†¡ì§€ ë³€ê²½ (ìƒíƒœ ê²€ì¦)
     */
    public void changeAddress(Address newAddress) {
        if (!isModifiable()) {
            throw new OrderNotModifiableException(
                "ë°°ì†¡ ì¤€ë¹„ ì¤‘ì´ê±°ë‚˜ ë°°ì†¡ ì¤‘ì¸ ì£¼ë¬¸ì€ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            );
        }
        
        if (newAddress == null) {
            throw new InvalidOrderException("ë°°ì†¡ì§€ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤");
        }
        
        this.deliveryAddress = newAddress;
    }
    
    public boolean isModifiable() {
        return status == OrderStatus.PENDING;
    }
}
```

---

## ê²€ì¦ ë ˆì´ì–´ë³„ ì •ë¦¬

| ë ˆì´ì–´ | ìœ„ì¹˜ | ê²€ì¦ ë‚´ìš© | ì˜ˆì‹œ |
|--------|------|-----------|------|
| **Controller** | api/web/*/dto/request/ | í˜•ì‹ ê²€ì¦ | @NotNull, @Size, @Email |
| **Command** | core/application/*/usecase/command/ | ì •í•©ì„± ê²€ì¦ | null ì²´í¬, ì¤‘ë³µ ì²´í¬ |
| **Application Support** | core/application/*/support/ | ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™ ì‚¬ì „ ê²€ì¦ | ì¡´ì¬ ì—¬ë¶€, ìƒíƒœ, ê¶Œí•œ |
| **Domain Service** | core/domain/service/ | ë³µì¡í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™ | ì¼ì¼ í•œë„, ë“±ê¸‰ë³„ ì œí•œ |
| **Domain Entity** | core/domain/*/model/ | í•µì‹¬ ë¶ˆë³€ì‹ | ìƒíƒœ ì „ì´, ê³„ì‚° ì¼ì¹˜ |

## ì¤‘ìš” ì›ì¹™
1. ê²€ì¦ì€ ê°€ëŠ¥í•œ ë¹ ë¥¸ ë ˆì´ì–´ì—ì„œ
2. ê° ë ˆì´ì–´ëŠ” ìì‹ ì˜ ì±…ì„ì— ë§ëŠ” ê²€ì¦ë§Œ
3. Domain EntityëŠ” í•­ìƒ ìœ íš¨í•œ ìƒíƒœ ìœ ì§€
4. ëª…í™•í•œ ì˜ˆì™¸ ë©”ì‹œì§€ ì œê³µ
5. ê²€ì¦ ì‹¤íŒ¨ ì‹œ êµ¬ì²´ì ì¸ ì›ì¸ ì „ë‹¬
</artifact>

------
alwaysApply: true
---
## ğŸ›  ê¸°ìˆ  ìŠ¤íƒ

### í•„ìˆ˜ ë¼ì´ë¸ŒëŸ¬ë¦¬

```gradle
dependencies {
    // JUnit 5
    testImplementation 'org.junit.jupiter:junit-jupiter:5.10.0'
    
    // AssertJ (ê°€ë…ì„± ì¢‹ì€ assertion)
    testImplementation 'org.assertj:assertj-core:3.24.0'
    
    // Mockito (Mock ê°ì²´)
    testImplementation 'org.mockito:mockito-core:5.5.0'
    testImplementation 'org.mockito:mockito-junit-jupiter:5.5.0'
    
    // Fixture Monkey (í…ŒìŠ¤íŠ¸ ê°ì²´ ìƒì„±)
    testImplementation 'com.navercorp.fixturemonkey:fixture-monkey-starter:1.0.0'
    
    // Spring Boot Test
    testImplementation 'org.springframework.boot:spring-boot-starter-test'
}
```

### ì£¼ìš” ë„êµ¬

| ë„êµ¬ | ìš©ë„ | ì‚¬ìš© ìœ„ì¹˜ |
|------|------|-----------|
| **JUnit 5** | í…ŒìŠ¤íŠ¸ í”„ë ˆì„ì›Œí¬ | ëª¨ë“  í…ŒìŠ¤íŠ¸ |
| **AssertJ** | Assertion | ëª¨ë“  í…ŒìŠ¤íŠ¸ |
| **Mockito** | Mock ê°ì²´ | Application, Interface Layer |
| **Fixture Monkey** | í…ŒìŠ¤íŠ¸ ê°ì²´ ìƒì„± | ëª¨ë“  í…ŒìŠ¤íŠ¸ |
| **@DataJpaTest** | Repository í…ŒìŠ¤íŠ¸ | Infrastructure Layer |
| **@WebMvcTest** | Controller í…ŒìŠ¤íŠ¸ | Interface Layer |

---

## ğŸ“‹ ê³„ì¸µë³„ í…ŒìŠ¤íŠ¸ ì „ëµ

### 1. Domain Layer í…ŒìŠ¤íŠ¸

**íŠ¹ì§•:**
- ìˆœìˆ˜ Java ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
- ì™¸ë¶€ ì˜ì¡´ì„± ì—†ìŒ
- ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ê²€ì¦

**í…ŒìŠ¤íŠ¸ ëŒ€ìƒ:**
- Domain Entity
- Value Object
- Domain Service
- Domain Exception

**ì˜ˆì‹œ:**
```java
// core/src/test/java/vroong/laas/order/domain/order/OrderTest.java
class OrderTest {
    
    private FixtureMonkey fixtureMonkey;
    
    @BeforeEach
    void setUp() {
        fixtureMonkey = FixtureMonkey.builder()
            .objectIntrospector(ConstructorPropertiesArbitraryIntrospector.INSTANCE)
            .build();
    }
    
    @Test
    @DisplayName("ì£¼ë¬¸ì„ ì·¨ì†Œí•˜ë©´ ìƒíƒœê°€ CANCELLEDë¡œ ë³€ê²½ëœë‹¤")
    void cancel_order_changes_status_to_cancelled() {
        // given
        Order order = fixtureMonkey.giveMeBuilder(Order.class)
            .set("status", OrderStatus.PENDING)
            .sample();
        
        String reason = "ê³ ê° ìš”ì²­";
        
        // when
        order.cancel(reason);
        
        // then
        assertThat(order.getStatus()).isEqualTo(OrderStatus.CANCELLED);
        assertThat(order.getCancelReason()).isEqualTo(reason);
    }
    
    @Test
    @DisplayName("ì´ë¯¸ ì·¨ì†Œëœ ì£¼ë¬¸ì€ ë‹¤ì‹œ ì·¨ì†Œí•  ìˆ˜ ì—†ë‹¤")
    void cannot_cancel_already_cancelled_order() {
        // given
        Order order = fixtureMonkey.giveMeBuilder(Order.class)
            .set("status", OrderStatus.CANCELLED)
            .sample();
        
        // when & then
        assertThatThrownBy(() -> order.cancel("ì¬ì·¨ì†Œ"))
            .isInstanceOf(OrderAlreadyCancelledException.class)
            .hasMessage("ì´ë¯¸ ì·¨ì†Œëœ ì£¼ë¬¸ì…ë‹ˆë‹¤");
    }
}
```

---

### ğŸ“Œ Domain Layer í…ŒìŠ¤íŠ¸ ì‹¤ì „ ê°€ì´ë“œ

#### 1. Spring Context ì‚¬ìš© ê¸ˆì§€ â­â­â­

**Domain LayerëŠ” ìˆœìˆ˜ Java í…ŒìŠ¤íŠ¸ì—¬ì•¼ í•©ë‹ˆë‹¤. Spring ì˜ì¡´ì„± ì ˆëŒ€ ê¸ˆì§€!**

```java
// âŒ ì˜ëª»ëœ ì˜ˆ - Spring Context ì‚¬ìš©
@Component  // ê¸ˆì§€!
public class OrderFixtures {
    @Autowired
    private FixtureMonkey fixtureMonkey;  // ê¸ˆì§€!
}

@SpringBootTest  // Domain Layerì—ì„œ ê¸ˆì§€!
class OrderTest {
    @Autowired
    private OrderFixtures fixtures;
}

// âœ… ì˜¬ë°”ë¥¸ ì˜ˆ - ìˆœìˆ˜ Java
public class OrderFixtures {
    private final FixtureMonkey fixtureMonkey;
    
    public OrderFixtures(FixtureMonkey fixtureMonkey) {
        this.fixtureMonkey = fixtureMonkey;
    }
}

class OrderTest {
    private OrderFixtures orderFixtures;
    
    @BeforeEach
    void setUp() {
        FixtureMonkey fixtureMonkey = FixtureMonkey.builder()
            .objectIntrospector(ConstructorPropertiesArbitraryIntrospector.INSTANCE)
            .defaultNotNull(true)
            .build();
        
        orderFixtures = new OrderFixtures(fixtureMonkey);
    }
}
```

**ì™œ ì¤‘ìš”í•œê°€?**
- Domain LayerëŠ” Infrastructureì— ì˜ì¡´í•˜ì§€ ì•ŠìŒ
- ë¹ ë¥¸ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (Spring Context ë¡œë”© ì—†ìŒ)
- ìˆœìˆ˜í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ê²€ì¦

---

#### 2. ìƒì„±ì vs íŒ©í† ë¦¬ ë©”ì„œë“œ íŒ¨í„´ â­â­â­

**ìƒì„±ìì—ì„œ í•„ìˆ˜ ê°’ ì²´í¬, create()ëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™ìš©**

```java
public class Order {
    
    // ìƒì„±ì - í•„ìˆ˜ ê°’ ì²´í¬ (í•­ìƒ ì‹¤í–‰)
    public Order(
        Long id,
        String orderNumber,
        OrderStatus status,
        List<OrderItem> items,
        Origin origin,
        Destination destination,
        DeliveryPolicy deliveryPolicy,
        Instant orderedAt,
        Instant deliveredAt,
        Instant cancelledAt
    ) {
        // í•„ìˆ˜ ê°’ ì²´í¬
        if (orderNumber == null || orderNumber.isBlank()) {
            throw new IllegalArgumentException("ì£¼ë¬¸ë²ˆí˜¸ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤");
        }
        if (items == null || items.isEmpty()) {
            throw new IllegalArgumentException("ì£¼ë¬¸ ì•„ì´í…œì€ ìµœì†Œ 1ê°œ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤");
        }
        if (origin == null) {
            throw new IllegalArgumentException("ì¶œë°œì§€ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤");
        }
        if (destination == null) {
            throw new IllegalArgumentException("ë„ì°©ì§€ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤");
        }
        
        // í• ë‹¹
        this.id = id;
        this.orderNumber = orderNumber;
        this.status = status;
        this.items = new ArrayList<>(items);
        this.origin = origin;
        this.destination = destination;
        this.deliveryPolicy = deliveryPolicy;
        this.orderedAt = orderedAt;
        this.deliveredAt = deliveredAt;
        this.cancelledAt = cancelledAt;
    }
    
    // create() - ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™ + ì´ˆê¸° ìƒíƒœë¡œ ìƒì„±
    public static Order create(
        String orderNumber,
        List<OrderItem> items,
        Origin origin,
        Destination destination,
        DeliveryPolicy deliveryPolicy
    ) {
        // ì¶”ê°€ ë¹„ì¦ˆë‹ˆìŠ¤ ê²€ì¦ (ì„ íƒì )
        validateBusinessRules(items, origin, destination);
        
        // ì´ˆê¸° ìƒíƒœë¡œ ìƒì„±
        return new Order(
            null,                  // idëŠ” ë‚˜ì¤‘ì— í• ë‹¹
            orderNumber,
            OrderStatus.CREATED,   // ì´ˆê¸° ìƒíƒœ
            items,
            origin,
            destination,
            deliveryPolicy,
            Instant.now(),         // í˜„ì¬ ì‹œê°„
            null,                  // deliveredAt
            null                   // cancelledAt
        );
    }
}
```

**ì‚¬ìš© êµ¬ë¶„:**

| ë°©ë²• | ìš©ë„ | ê²€ì¦ | ì‚¬ìš©ì²˜ |
|------|------|------|--------|
| **`create()`** | ìƒˆ ì£¼ë¬¸ ìƒì„± | ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™ âœ… | í”„ë¡œë•ì…˜ (UseCase) |
| **ìƒì„±ì** | ê°ì²´ ë³µì›/í…ŒìŠ¤íŠ¸ | í•„ìˆ˜ ê°’ë§Œ âœ… | í…ŒìŠ¤íŠ¸, Infrastructure |

```java
// í”„ë¡œë•ì…˜ - create() ì‚¬ìš©
Order order = Order.create(
    "ORD-001", items, origin, destination, policy
);

// í…ŒìŠ¤íŠ¸ - ìƒì„±ì ì§ì ‘ ì‚¬ìš© (ë‹¤ì–‘í•œ ìƒíƒœ)
Order deliveredOrder = new Order(
    1L, "ORD-001", OrderStatus.DELIVERED, items, 
    origin, destination, policy,
    Instant.now().minusSeconds(3600),
    Instant.now(),  // deliveredAt
    null
);

// Infrastructure - ìƒì„±ì ì‚¬ìš© (DB â†’ Domain)
public Order toDomain() {
    return new Order(
        this.id, this.orderNumber, this.status,
        this.items.stream()...
    );
}
```

---

#### 3. ConstructorPropertiesArbitraryIntrospector í•„ìˆ˜ â­â­â­

**record, ë¶ˆë³€ ê°ì²´ë¥¼ ìœ„í•´ ë°˜ë“œì‹œ ì„¤ì •!**

```java
// âœ… í•„ìˆ˜ ì„¤ì •
FixtureMonkey fixtureMonkey = FixtureMonkey.builder()
    .objectIntrospector(ConstructorPropertiesArbitraryIntrospector.INSTANCE)  // â­
    .defaultNotNull(true)  // null ë°©ì§€
    .build();

// recordì—ì„œ ì‘ë™
public record Contact(String name, String phoneNumber) { }

Contact contact = fixtureMonkey.giveMeOne(Contact.class);  // âœ… ì‘ë™!

// ë¶ˆë³€ ê°ì²´ì—ì„œ ì‘ë™
@Getter
@AllArgsConstructor
public class Order {
    private final String orderNumber;
    // ...
}

Order order = fixtureMonkey.giveMeOne(Order.class);  // âœ… ì‘ë™!
```

**ì—†ìœ¼ë©´?**
```java
// âŒ ConstructorPropertiesArbitraryIntrospector ì—†ì´
FixtureMonkey fixtureMonkey = FixtureMonkey.builder().build();

Contact contact = fixtureMonkey.giveMeOne(Contact.class);
// â†’ ì—ëŸ¬! recordëŠ” ê¸°ë³¸ ìƒì„±ìê°€ ì—†ìŒ
```

---

#### 4. Arbitrariesì™€ FixtureMonkey ì¡°í•© â­â­

**ë²”ìœ„ê°€ ìˆëŠ” ëœë¤ ê°’ ìƒì„±**

```java
import net.jqwik.api.Arbitraries;

public class OrderFixtures {
    
    private final FixtureMonkey fixtureMonkey;
    
    // Arbitrariesë¡œ ë²”ìœ„ ì§€ì •
    public OrderItem randomOrderItem() {
        String itemName = "ìƒí’ˆ" + fixtureMonkey.giveMeOne(Integer.class);
        int quantity = Arbitraries.integers().between(1, 10).sample();
        Money price = new Money(
            BigDecimal.valueOf(Arbitraries.longs().between(1000L, 100000L).sample())
        );
        String category = Arbitraries.of("ì‹í’ˆ", "ìƒí™œìš©í’ˆ", "ì˜ë¥˜", "ì „ìì œí’ˆ").sample();
        
        return new OrderItem(itemName, quantity, price, category, null, null);
    }
    
    // FixtureMonkey.giveMeBuilder()ì™€ Arbitraries ì¡°í•©
    public Contact randomContact() {
        return fixtureMonkey.giveMeBuilder(Contact.class)
            .set("name", "í…ŒìŠ¤í„°" + fixtureMonkey.giveMeOne(Integer.class))
            .set("phoneNumber", 
                "010-" + 
                Arbitraries.strings().numeric().ofLength(4).sample() + 
                "-" + 
                Arbitraries.strings().numeric().ofLength(4).sample())
            .sample();
    }
    
    public LatLng randomLatLng() {
        return fixtureMonkey.giveMeBuilder(LatLng.class)
            .set("latitude", 
                Arbitraries.doubles().between(37.0, 38.0)
                    .map(BigDecimal::valueOf))
            .set("longitude", 
                Arbitraries.doubles().between(126.0, 127.0)
                    .map(BigDecimal::valueOf))
            .sample();
    }
}
```

**ì£¼ìš” Arbitraries ë©”ì„œë“œ:**

```java
// ì •ìˆ˜ ë²”ìœ„
Arbitraries.integers().between(1, 10).sample()

// Long ë²”ìœ„
Arbitraries.longs().between(1000L, 100000L).sample()

// Double ë²”ìœ„
Arbitraries.doubles().between(37.0, 38.0).sample()

// ëª©ë¡ì—ì„œ ì„ íƒ
Arbitraries.of("A", "B", "C", "D").sample()

// ìˆ«ì ë¬¸ìì—´
Arbitraries.strings().numeric().ofLength(4).sample()  // "1234"

// ì•ŒíŒŒë²³ ë¬¸ìì—´
Arbitraries.strings().alpha().ofLength(10).sample()  // "abcdEFGHij"
```

---

#### 5. ì‹¤ì „ Fixture íŒ¨í„´ â­â­

**ìƒíƒœë³„ Fixture ë©”ì„œë“œ ì œê³µ**

```java
public class OrderFixtures {
    
    private final FixtureMonkey fixtureMonkey;
    
    public OrderFixtures(FixtureMonkey fixtureMonkey) {
        this.fixtureMonkey = fixtureMonkey;
    }
    
    // ê¸°ë³¸ ì£¼ë¬¸ (CREATED ìƒíƒœ)
    public Order order() {
        return new Order(
            null,
            generateOrderNumber(),
            OrderStatus.CREATED,
            randomOrderItems(),
            randomOrigin(),
            randomDestination(),
            randomDeliveryPolicy(),
            Instant.now(),
            null,
            null
        );
    }
    
    // íŠ¹ì • ì£¼ë¬¸ë²ˆí˜¸ë¡œ ìƒì„±
    public Order order(String orderNumber) {
        return new Order(
            null,
            orderNumber,
            OrderStatus.CREATED,
            randomOrderItems(),
            randomOrigin(),
            randomDestination(),
            randomDeliveryPolicy(),
            Instant.now(),
            null,
            null
        );
    }
    
    // ë°°ì†¡ì™„ë£Œ ì£¼ë¬¸
    public Order deliveredOrder() {
        return new Order(
            fixtureMonkey.giveMeOne(Long.class),
            generateOrderNumber(),
            OrderStatus.DELIVERED,
            randomOrderItems(),
            randomOrigin(),
            randomDestination(),
            randomDeliveryPolicy(),
            Instant.now().minusSeconds(3600),
            Instant.now(),  // deliveredAt
            null
        );
    }
    
    // ì·¨ì†Œëœ ì£¼ë¬¸
    public Order cancelledOrder() {
        return new Order(
            fixtureMonkey.giveMeOne(Long.class),
            generateOrderNumber(),
            OrderStatus.CANCELLED,
            randomOrderItems(),
            randomOrigin(),
            randomDestination(),
            randomDeliveryPolicy(),
            Instant.now().minusSeconds(3600),
            null,
            Instant.now()  // cancelledAt
        );
    }
    
    // íŠ¹ì • IDë¡œ ìƒì„±
    public Order orderWithId(Long id) {
        return new Order(
            id,
            generateOrderNumber(),
            OrderStatus.CREATED,
            randomOrderItems(),
            randomOrigin(),
            randomDestination(),
            randomDeliveryPolicy(),
            Instant.now(),
            null,
            null
        );
    }
    
    // íŠ¹ì • ìƒíƒœë¡œ ìƒì„±
    public Order orderWithStatus(OrderStatus status) {
        Instant deliveredAt = status == OrderStatus.DELIVERED ? Instant.now() : null;
        Instant cancelledAt = status == OrderStatus.CANCELLED ? Instant.now() : null;
        
        return new Order(
            null,
            generateOrderNumber(),
            status,
            randomOrderItems(),
            randomOrigin(),
            randomDestination(),
            randomDeliveryPolicy(),
            Instant.now().minusSeconds(3600),
            deliveredAt,
            cancelledAt
        );
    }
    
    // Value Object ëœë¤ ìƒì„± í—¬í¼
    public List<OrderItem> randomOrderItems() {
        int count = Math.abs(fixtureMonkey.giveMeOne(Integer.class) % 3) + 1;
        return List.of(
            randomOrderItem(),
            randomOrderItem(),
            randomOrderItem()
        ).subList(0, count);
    }
    
    public OrderItem randomOrderItem() {
        // Arbitraries í™œìš©
        String itemName = "ìƒí’ˆ" + Math.abs(fixtureMonkey.giveMeOne(Integer.class) % 1000);
        int quantity = Arbitraries.integers().between(1, 10).sample();
        Money price = new Money(
            BigDecimal.valueOf(Arbitraries.longs().between(1000L, 100000L).sample())
        );
        String category = Arbitraries.of("ì‹í’ˆ", "ìƒí™œìš©í’ˆ", "ì˜ë¥˜", "ì „ìì œí’ˆ").sample();
        
        return new OrderItem(itemName, quantity, price, category, null, null);
    }
    
    public Contact randomContact() {
        return fixtureMonkey.giveMeBuilder(Contact.class)
            .set("name", "í…ŒìŠ¤í„°" + fixtureMonkey.giveMeOne(Integer.class))
            .set("phoneNumber", 
                "010-" + 
                Arbitraries.strings().numeric().ofLength(4).sample() + 
                "-" + 
                Arbitraries.strings().numeric().ofLength(4).sample())
            .sample();
    }
    
    private String generateOrderNumber() {
        return "ORD-" + System.currentTimeMillis();
    }
}
```

**í…ŒìŠ¤íŠ¸ì—ì„œ ì‚¬ìš©:**

```java
class OrderTest {
    
    private OrderFixtures orderFixtures;
    
    @BeforeEach
    void setUp() {
        FixtureMonkey fixtureMonkey = FixtureMonkey.builder()
            .objectIntrospector(ConstructorPropertiesArbitraryIntrospector.INSTANCE)
            .defaultNotNull(true)
            .build();
        
        orderFixtures = new OrderFixtures(fixtureMonkey);
    }
    
    @Test
    void test_with_created_order() {
        Order order = orderFixtures.order();
        // í…ŒìŠ¤íŠ¸...
    }
    
    @Test
    void test_with_delivered_order() {
        Order order = orderFixtures.deliveredOrder();
        // í…ŒìŠ¤íŠ¸...
    }
    
    @Test
    void test_with_specific_status() {
        Order order = orderFixtures.orderWithStatus(OrderStatus.CANCELLED);
        // í…ŒìŠ¤íŠ¸...
    }
}
```

---

### 2. Application Layer í…ŒìŠ¤íŠ¸

**íŠ¹ì§•:**
- UseCase í…ŒìŠ¤íŠ¸
- Mockìœ¼ë¡œ Port ëŒ€ì²´
- íë¦„ ê²€ì¦ (Given-When-Then)

**í…ŒìŠ¤íŠ¸ ëŒ€ìƒ:**
- UseCase
- Command/Query

**ì˜ˆì‹œ:**
```java
// core/src/test/java/vroong/laas/order/application/order/CancelOrderUseCaseTest.java
@ExtendWith(MockitoExtension.class)
class CancelOrderUseCaseTest {
    
    @InjectMocks
    private CancelOrderUseCase sut;
    
    @Mock
    private OrderStore orderStore;
    
    @Mock
    private EventPublisher eventPublisher;
    
    private FixtureMonkey fixtureMonkey;
    
    @BeforeEach
    void setUp() {
        fixtureMonkey = FixtureMonkey.builder()
            .objectIntrospector(ConstructorPropertiesArbitraryIntrospector.INSTANCE)
            .build();
    }
    
    @Test
    @DisplayName("ì£¼ë¬¸ì„ ì·¨ì†Œí•˜ê³  ì´ë²¤íŠ¸ë¥¼ ë°œí–‰í•œë‹¤")
    void cancel_order_and_publish_event() {
        // given
        Long orderId = 1L;
        String reason = "ê³ ê° ìš”ì²­";
        
        Order order = fixtureMonkey.giveMeBuilder(Order.class)
            .set("id", orderId)
            .set("status", OrderStatus.PENDING)
            .sample();
        
        given(orderStore.findById(orderId))
            .willReturn(Optional.of(order));
        
        CancelOrderCommand command = new CancelOrderCommand(orderId, reason);
        
        // when
        sut.execute(command);
        
        // then
        assertThat(order.getStatus()).isEqualTo(OrderStatus.CANCELLED);
        
        verify(orderStore).save(order);
        verify(eventPublisher).publish(any(OrderCancelledEvent.class));
    }
    
    @Test
    @DisplayName("ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì£¼ë¬¸ì€ ì·¨ì†Œí•  ìˆ˜ ì—†ë‹¤")
    void cannot_cancel_non_existing_order() {
        // given
        Long orderId = 999L;
        
        given(orderStore.findById(orderId))
            .willReturn(Optional.empty());
        
        CancelOrderCommand command = new CancelOrderCommand(orderId, "ì‚¬ìœ ");
        
        // when & then
        assertThatThrownBy(() -> sut.execute(command))
            .isInstanceOf(OrderNotFoundException.class);
        
        verify(orderStore, never()).save(any());
        verify(eventPublisher, never()).publish(any());
    }
}
```

---

### 3. Infrastructure Layer í…ŒìŠ¤íŠ¸

**íŠ¹ì§•:**
- Repository í†µí•© í…ŒìŠ¤íŠ¸
- @DataJpaTest ì‚¬ìš©
- ì‹¤ì œ DB(H2) ì‚¬ìš©

**í…ŒìŠ¤íŠ¸ ëŒ€ìƒ:**
- Repository Adapter
- JPA Entity
- Query

**ì˜ˆì‹œ:**
```java
// infrastructure/src/test/java/vroong/laas/order/infrastructure/storage/db/order/OrderStoreAdapterTest.java
@DataJpaTest
@Import(OrderStoreAdapter.class)
class OrderStoreAdapterTest {
    
    @Autowired
    private OrderStoreAdapter orderStoreAdapter;
    
    @Autowired
    private OrderJpaRepository orderJpaRepository;
    
    private FixtureMonkey fixtureMonkey;
    
    @BeforeEach
    void setUp() {
        fixtureMonkey = FixtureMonkey.builder()
            .objectIntrospector(ConstructorPropertiesArbitraryIntrospector.INSTANCE)
            .build();
    }
    
    @Test
    @DisplayName("ì£¼ë¬¸ì„ ì €ì¥í•˜ê³  ì¡°íšŒí•  ìˆ˜ ìˆë‹¤")
    void save_and_find_order() {
        // given
        Order order = fixtureMonkey.giveMeBuilder(Order.class)
            .set("id", null)  // ì‹ ê·œ ì£¼ë¬¸
            .set("status", OrderStatus.PENDING)
            .sample();
        
        // when
        Order saved = orderStoreAdapter.save(order);
        Order found = orderStoreAdapter.findById(saved.getId()).orElseThrow();
        
        // then
        assertThat(found.getId()).isEqualTo(saved.getId());
        assertThat(found.getStatus()).isEqualTo(OrderStatus.PENDING);
    }
    
    @Test
    @DisplayName("ì£¼ë¬¸ê³¼ ì•„ì´í…œì„ í•¨ê»˜ ì¡°íšŒí•  ìˆ˜ ìˆë‹¤")
    void find_order_with_items() {
        // given
        OrderJpaEntity entity = fixtureMonkey.giveMeBuilder(OrderJpaEntity.class)
            .set("id", null)
            .size("items", 3)
            .sample();
        
        OrderJpaEntity saved = orderJpaRepository.save(entity);
        
        // when
        Order order = orderStoreAdapter.findByIdWithItems(saved.getId()).orElseThrow();
        
        // then
        assertThat(order.getItems()).hasSize(3);
    }
}
```

---

### 4. Interface Layer í…ŒìŠ¤íŠ¸

**íŠ¹ì§•:**
- Controller í…ŒìŠ¤íŠ¸
- @WebMvcTest ì‚¬ìš©
- API ê³„ì•½ ê²€ì¦

**í…ŒìŠ¤íŠ¸ ëŒ€ìƒ:**
- Controller
- Request/Response DTO
- Exception Handler

**ì˜ˆì‹œ:**
```java
// api/src/test/java/vroong/laas/order/api/web/order/OrderControllerTest.java
@WebMvcTest(OrderController.class)
class OrderControllerTest {
    
    @Autowired
    private MockMvc mockMvc;
    
    @MockBean
    private CancelOrderUseCase cancelOrderUseCase;
    
    @Autowired
    private ObjectMapper objectMapper;
    
    private FixtureMonkey fixtureMonkey;
    
    @BeforeEach
    void setUp() {
        fixtureMonkey = FixtureMonkey.builder()
            .objectIntrospector(ConstructorPropertiesArbitraryIntrospector.INSTANCE)
            .build();
    }
    
    @Test
    @DisplayName("ì£¼ë¬¸ ì·¨ì†Œ API - ì„±ê³µ")
    void cancel_order_success() throws Exception {
        // given
        Long orderId = 1L;
        
        CancelOrderRequest request = fixtureMonkey.giveMeBuilder(CancelOrderRequest.class)
            .set("reason", "ê³ ê° ìš”ì²­")
            .sample();
        
        // when & then
        mockMvc.perform(
                post("/api/orders/{orderId}/cancel", orderId)
                    .contentType(MediaType.APPLICATION_JSON)
                    .content(objectMapper.writeValueAsString(request))
            )
            .andExpect(status().isOk())
            .andExpect(jsonPath("$.success").value(true));
        
        verify(cancelOrderUseCase).execute(any(CancelOrderCommand.class));
    }
    
    @Test
    @DisplayName("ì£¼ë¬¸ ì·¨ì†Œ API - ìœ íš¨ì„± ê²€ì¦ ì‹¤íŒ¨")
    void cancel_order_validation_fail() throws Exception {
        // given
        Long orderId = 1L;
        
        CancelOrderRequest request = new CancelOrderRequest(null);  // reason ëˆ„ë½
        
        // when & then
        mockMvc.perform(
                post("/api/orders/{orderId}/cancel", orderId)
                    .contentType(MediaType.APPLICATION_JSON)
                    .content(objectMapper.writeValueAsString(request))
            )
            .andExpect(status().isBadRequest())
            .andExpect(jsonPath("$.errorCode").value("INVALID_INPUT"));
    }
}
```

---

## 5. REST Docs - API ë¬¸ì„œ ìë™ ìƒì„± â­

**íŠ¹ì§•:**
- Controller í…ŒìŠ¤íŠ¸ì™€ í•¨ê»˜ API ë¬¸ì„œ ìë™ ìƒì„±
- **@WebMvcTest ì‚¬ìš©** (Web Layerë§Œ ë¡œë“œ, ë¹ ë¥¸ ì‹¤í–‰)
- **FixtureMonkey ì‚¬ìš© ì•ˆ í•¨** (ì¼ê´€ëœ ë¬¸ì„œë¥¼ ìœ„í•´ ê³ ì • ë°ì´í„° ì‚¬ìš©)
- ì»¤ìŠ¤í…€ í…œí”Œë¦¿ìœ¼ë¡œ Constraints ì»¬ëŸ¼ ì¶”ê°€

### REST Docs í…ŒìŠ¤íŠ¸ í…œí”Œë¦¿

```java
// api/src/test/java/vroong/laas/order/api/web/order/OrderControllerTest.java
@WebMvcTest(
    controllers = OrderController.class,
    excludeFilters = @ComponentScan.Filter(
        type = FilterType.REGEX,
        pattern = "vroong.laas.order.api.web.common.logging.*"
    )
)
@AutoConfigureRestDocs
@Import({RestDocsConfiguration.class, WebApiControllerAdvice.class})
class OrderControllerTest {
    
    @Autowired
    private MockMvc mockMvc;
    
    @MockBean
    private OrderFacade orderFacade;
    
    @Autowired
    private ObjectMapper objectMapper;
    
    @Autowired
    private RestDocumentationResultHandler restDocs;
    
    @Test
    @DisplayName("ì£¼ë¬¸ ìƒì„± API")
    void createOrder_success() throws Exception {
        // given - ê³ ì •ëœ í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‚¬ìš© (FixtureMonkey ì‚¬ìš© ì•ˆ í•¨)
        CreateOrderRequest request = CreateOrderRequest.builder()
            .items(List.of(
                OrderItemDto.builder()
                    .itemName("ìƒí’ˆA")
                    .quantity(2)
                    .price(new BigDecimal("10000"))
                    .category("ì‹í’ˆ")
                    .build()
            ))
            .origin(OriginDto.builder()
                .contact(ContactDto.builder()
                    .name("ë°œì†¡ì")
                    .phoneNumber("010-1234-5678")
                    .build())
                .address(AddressDto.builder()
                    .jibnunAddress("ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ ì—­ì‚¼ë™ 123")
                    .roadAddress("ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 123")
                    .detailAddress("1ì¸µ")
                    .build())
                .latLng(LatLngDto.builder()
                    .latitude(new BigDecimal("37.123456"))
                    .longitude(new BigDecimal("127.123456"))
                    .build())
                .build())
            .destination(DestinationDto.builder()
                .contact(ContactDto.builder()
                    .name("ìˆ˜ë ¹ì")
                    .phoneNumber("010-9876-5432")
                    .build())
                .address(AddressDto.builder()
                    .jibnunAddress("ì„œìš¸ì‹œ ì„œì´ˆêµ¬ ì„œì´ˆë™ 456")
                    .roadAddress("ì„œìš¸ì‹œ ì„œì´ˆêµ¬ ì„œì´ˆëŒ€ë¡œ 456")
                    .detailAddress("2ì¸µ")
                    .build())
                .latLng(LatLngDto.builder()
                    .latitude(new BigDecimal("37.234567"))
                    .longitude(new BigDecimal("127.234567"))
                    .build())
                .entranceInfo(EntranceInfoDto.builder()
                    .entrancePassword("1234")
                    .entranceNote("í˜„ê´€ ë¹„ë°€ë²ˆí˜¸ëŠ” 1234ì…ë‹ˆë‹¤")
                    .build())
                .build())
            .deliveryPolicy(DeliveryPolicyDto.builder()
                .pickupDueAt(Instant.now().plusSeconds(3600))
                .deliveryDueAt(Instant.now().plusSeconds(7200))
                .build())
            .build();
        
        Order mockOrder = Order.builder()
            .id(1L)
            .orderNumber(OrderNumber.of("ORD-20250112-001"))
            .status(OrderStatus.CREATED)
            .items(request.toItems())
            .origin(request.toOrigin())
            .destination(request.toDestination())
            .deliveryPolicy(request.toDeliveryPolicy())
            .orderedAt(Instant.now())
            .build();
        
        given(orderFacade.createOrder(any(CreateOrderCommand.class)))
            .willReturn(mockOrder);
        
        // when & then
        mockMvc.perform(post("/api/v1/orders")
                .contentType(APPLICATION_JSON)
                .content(objectMapper.writeValueAsString(request)))
            .andExpect(status().isCreated())
            .andExpect(jsonPath("$.id").value(1))
            .andExpect(jsonPath("$.orderNumber").value("ORD-20250112-001"))
            .andExpect(jsonPath("$.status").value("CREATED"))
            .andDo(restDocs.document(
                requestFields(
                    fieldWithPath("items[]").description("ì£¼ë¬¸ ì•„ì´í…œ ëª©ë¡")
                        .attributes(key("constraints").value("ìµœì†Œ 1ê°œ")),
                    fieldWithPath("items[].itemName").description("ìƒí’ˆëª…"),
                    fieldWithPath("items[].quantity").description("ìˆ˜ëŸ‰")
                        .attributes(key("constraints").value("1 ì´ìƒ")),
                    fieldWithPath("items[].price").description("ê°€ê²©"),
                    fieldWithPath("items[].category").description("ì¹´í…Œê³ ë¦¬"),
                    fieldWithPath("origin.contact.name").description("ë°œì†¡ì ì´ë¦„"),
                    fieldWithPath("origin.contact.phoneNumber").description("ë°œì†¡ì ì „í™”ë²ˆí˜¸"),
                    // ... ê¸°íƒ€ í•„ë“œ
                ),
                responseFields(
                    fieldWithPath("id").description("ì£¼ë¬¸ ID"),
                    fieldWithPath("orderNumber").description("ì£¼ë¬¸ ë²ˆí˜¸"),
                    fieldWithPath("status").description("ì£¼ë¬¸ ìƒíƒœ")
                        .attributes(key("constraints").value("CREATED, DELIVERED, CANCELLED")),
                    // ... ê¸°íƒ€ í•„ë“œ
                )
            ));
    }
}
```

### RestDocsConfiguration (ê³µí†µ ì„¤ì •)

```java
// api/src/test/java/vroong/laas/order/api/config/RestDocsConfiguration.java
@TestConfiguration
public class RestDocsConfiguration {
    
    @Bean
    public RestDocumentationResultHandler write() {
        return MockMvcRestDocumentation.document(
            "{class-name}/{method-name}",
            preprocessRequest(prettyPrint()),
            preprocessResponse(prettyPrint())
        );
    }
}
```

### ì»¤ìŠ¤í…€ í…œí”Œë¦¿ (Constraints ì»¬ëŸ¼ ì¶”ê°€)

**ì¤‘ìš”:** í…œí”Œë¦¿ ê²½ë¡œëŠ” ë°˜ë“œì‹œ `src/test/resources/org/springframework/restdocs/templates/asciidoctor/`ì´ì–´ì•¼ í•©ë‹ˆë‹¤. (Spring REST Docs ê³ ì • ê·œì¹™)

```
// api/src/test/resources/org/springframework/restdocs/templates/asciidoctor/request-fields.snippet
|===
|Path|Type|Description|Constraints

{{#fields}}
|{{#tableCellContent}}`+{{path}}+`{{/tableCellContent}}
|{{#tableCellContent}}`+{{type}}+`{{/tableCellContent}}
|{{#tableCellContent}}{{description}}{{/tableCellContent}}
|{{#tableCellContent}}{{#constraints}}{{.}}{{/constraints}}{{^constraints}}-{{/constraints}}{{/tableCellContent}}

{{/fields}}
|===
```

```
// api/src/test/resources/org/springframework/restdocs/templates/asciidoctor/response-fields.snippet
|===
|Path|Type|Description|Constraints

{{#fields}}
|{{#tableCellContent}}`+{{path}}+`{{/tableCellContent}}
|{{#tableCellContent}}`+{{type}}+`{{/tableCellContent}}
|{{#tableCellContent}}{{description}}{{/tableCellContent}}
|{{#tableCellContent}}{{#constraints}}{{.}}{{/constraints}}{{^constraints}}-{{/constraints}}{{/tableCellContent}}

{{/fields}}
|===
```

### ì£¼ìš” ê·œì¹™

1. **@WebMvcTest ì‚¬ìš© (í•„ìˆ˜)**
   - `@SpringBootTest` ëŒ€ì‹  `@WebMvcTest` ì‚¬ìš©
   - Web Layerë§Œ ë¡œë“œí•˜ì—¬ ë¹ ë¥¸ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
   - í•„ìš”í•œ Beanì€ `@Import`ë¡œ ëª…ì‹œì  ì¶”ê°€

2. **FixtureMonkey ì‚¬ìš© ì•ˆ í•¨ (í•„ìˆ˜)**
   - REST DocsëŠ” ì¼ê´€ëœ ë¬¸ì„œê°€ í•„ìš”
   - ê³ ì •ëœ í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‚¬ìš©
   - ë¹Œë” íŒ¨í„´ìœ¼ë¡œ ê°€ë…ì„± ìˆê²Œ ì‘ì„±

3. **WebApiControllerAdvice Import (í•„ìˆ˜)**
   - `@WebMvcTest`ëŠ” `@ControllerAdvice`ë¥¼ ìë™ìœ¼ë¡œ ë¡œë“œí•˜ì§€ ì•ŠìŒ
   - `@Import({WebApiControllerAdvice.class})`ë¡œ ëª…ì‹œì  ì¶”ê°€

4. **RequestResponseLoggingFilter ì œì™¸ (í•„ìˆ˜)**
   - `@WebMvcTest`ëŠ” `LoggingProperties` Beanì„ ë¡œë“œí•˜ì§€ ì•ŠìŒ
   - `excludeFilters`ë¡œ ë¡œê¹… í•„í„° ì œì™¸

5. **ì»¤ìŠ¤í…€ í…œí”Œë¦¿ ê²½ë¡œ (ê³ ì •)**
   - ë°˜ë“œì‹œ `src/test/resources/org/springframework/restdocs/templates/asciidoctor/`
   - ë‹¤ë¥¸ ê²½ë¡œëŠ” Spring REST Docsê°€ ì¸ì‹í•˜ì§€ ëª»í•¨

### ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] `@WebMvcTest` ì‚¬ìš© (not `@SpringBootTest`)
- [ ] `@AutoConfigureRestDocs` ì¶”ê°€
- [ ] `@Import({RestDocsConfiguration.class, WebApiControllerAdvice.class})` ì¶”ê°€
- [ ] `excludeFilters`ë¡œ `RequestResponseLoggingFilter` ì œì™¸
- [ ] FixtureMonkey ì œê±°, ê³ ì • ë°ì´í„° ì‚¬ìš©
- [ ] ì»¤ìŠ¤í…€ í…œí”Œë¦¿ ê²½ë¡œ í™•ì¸ (`org/springframework/restdocs/templates/asciidoctor/`)
- [ ] Constraints ì¶”ê°€ (`.attributes(key("constraints").value(...))`)

### ìì£¼í•˜ëŠ” ì‹¤ìˆ˜

**âŒ ì˜ëª»ëœ í…œí”Œë¦¿ ê²½ë¡œ**
```
src/test/resources/restdocs/templates/asciidoctor/  â† ì¸ì‹ ì•ˆ ë¨!
```

**âœ… ì˜¬ë°”ë¥¸ í…œí”Œë¦¿ ê²½ë¡œ**
```
src/test/resources/org/springframework/restdocs/templates/asciidoctor/  â† í•„ìˆ˜!
```

**âŒ FixtureMonkey ì‚¬ìš©**
```java
Order order = fixtureMonkey.giveMeOne(Order.class);  // ëœë¤ ë°ì´í„° â†’ ë¬¸ì„œê°€ ë§¤ë²ˆ ë‹¬ë¼ì§
```

**âœ… ê³ ì • ë°ì´í„° ì‚¬ìš©**
```java
Order order = Order.builder()
    .id(1L)
    .orderNumber(OrderNumber.of("ORD-20250112-001"))
    .build();  // ê³ ì • ë°ì´í„° â†’ ì¼ê´€ëœ ë¬¸ì„œ
```

**âŒ @SpringBootTest ì‚¬ìš©**
```java
@SpringBootTest  // ì „ì²´ Context ë¡œë“œ â†’ ëŠë¦¼
@AutoConfigureMockMvc
class OrderControllerTest { }
```

**âœ… @WebMvcTest ì‚¬ìš©**
```java
@WebMvcTest(OrderController.class)  // Web Layerë§Œ ë¡œë“œ â†’ ë¹ ë¦„
@AutoConfigureRestDocs
class OrderControllerTest { }
```

---

## ğŸ¯ Fixture Monkey ì‚¬ìš© ê·œì¹™

### 1. ì„¤ì •

**ê³µí†µ Fixture ì„¤ì • í´ë˜ìŠ¤ ì‘ì„±:**

```java
// src/test/java/vroong/laas/order/fixtures/FixtureConfig.java
@TestConfiguration
public class FixtureConfig {
    
    @Bean
    public FixtureMonkey fixtureMonkey() {
        return FixtureMonkey.builder()
            .objectIntrospector(ConstructorPropertiesArbitraryIntrospector.INSTANCE)
            .defaultNotNull(true)
            .build();
    }
}
```

---

### 2. ê¸°ë³¸ ì‚¬ìš©ë²•

#### ë‹¨ì¼ ê°ì²´ ìƒì„±
```java
// ëœë¤ ê°ì²´
Order order = fixtureMonkey.giveMeOne(Order.class);

// ì—¬ëŸ¬ ê°ì²´
List<Order> orders = fixtureMonkey.giveMe(Order.class, 10);
```

#### ì»¤ìŠ¤í„°ë§ˆì´ì§•
```java
// Builder íŒ¨í„´
Order order = fixtureMonkey.giveMeBuilder(Order.class)
    .set("status", OrderStatus.CONFIRMED)
    .set("totalAmount", Money.of(10000))
    .set("items[0].quantity", 5)
    .sample();

// í•„ë“œ ì œì™¸
Order order = fixtureMonkey.giveMeBuilder(Order.class)
    .setNull("cancelReason")
    .sample();

// ë²”ìœ„ ì§€ì •
Order order = fixtureMonkey.giveMeBuilder(Order.class)
    .size("items", 3, 5)  // 3~5ê°œ
    .sample();
```

---

### 3. ì¬ì‚¬ìš© ê°€ëŠ¥í•œ Fixture í´ë˜ìŠ¤

**ìœ„ì¹˜:** `src/test/java/.../fixtures/`

**ë„¤ì´ë°:** `{Entity}Fixtures.java`

**ì˜ˆì‹œ:**
```java
// src/test/java/vroong/laas/order/fixtures/OrderFixtures.java
@Component
public class OrderFixtures {
    
    private final FixtureMonkey fixtureMonkey;
    
    public OrderFixtures(FixtureMonkey fixtureMonkey) {
        this.fixtureMonkey = fixtureMonkey;
    }
    
    // ê¸°ë³¸ ì£¼ë¬¸
    public ArbitraryBuilder<Order> order() {
        return fixtureMonkey.giveMeBuilder(Order.class)
            .set("status", OrderStatus.PENDING);
    }
    
    // í™•ì •ëœ ì£¼ë¬¸
    public ArbitraryBuilder<Order> confirmedOrder() {
        return order()
            .set("status", OrderStatus.CONFIRMED)
            .set("confirmedAt", LocalDateTime.now());
    }
    
    // ì·¨ì†Œëœ ì£¼ë¬¸
    public ArbitraryBuilder<Order> cancelledOrder() {
        return order()
            .set("status", OrderStatus.CANCELLED)
            .set("cancelReason", "ê³ ê° ìš”ì²­");
    }
    
    // íŠ¹ì • ê¸ˆì•¡ì˜ ì£¼ë¬¸
    public ArbitraryBuilder<Order> orderWithAmount(Money amount) {
        return order()
            .set("totalAmount", amount);
    }
}
```

**ì‚¬ìš©:**
```java
@SpringBootTest
class OrderServiceTest {
    
    @Autowired
    private OrderFixtures orderFixtures;
    
    @Test
    void test() {
        // í™•ì •ëœ ì£¼ë¬¸ ìƒì„±
        Order order = orderFixtures.confirmedOrder().sample();
        
        // ì¶”ê°€ ì»¤ìŠ¤í„°ë§ˆì´ì§•
        Order customOrder = orderFixtures.confirmedOrder()
            .set("totalAmount", Money.of(50000))
            .sample();
    }
}
```

---

### 4. ê³„ì¸µë³„ Fixture êµ¬ì„±

```
src/test/java/vroong/laas/order/fixtures/
â”œâ”€â”€ domain/
â”‚   â”œâ”€â”€ OrderFixtures.java          # Domain Entity
â”‚   â”œâ”€â”€ OrderItemFixtures.java
â”‚   â””â”€â”€ MoneyFixtures.java          # Value Object
â”œâ”€â”€ application/
â”‚   â”œâ”€â”€ CreateOrderCommandFixtures.java   # Command
â”‚   â””â”€â”€ CancelOrderCommandFixtures.java
â”œâ”€â”€ infrastructure/
â”‚   â””â”€â”€ OrderJpaEntityFixtures.java       # JPA Entity
â””â”€â”€ api/
    â”œâ”€â”€ CreateOrderRequestFixtures.java   # Request DTO
    â””â”€â”€ OrderResponseFixtures.java        # Response DTO
```

---

## ğŸ“ í…ŒìŠ¤íŠ¸ ì‘ì„± ê°€ì´ë“œ

### 1. Given-When-Then íŒ¨í„´

ëª¨ë“  í…ŒìŠ¤íŠ¸ëŠ” Given-When-Then êµ¬ì¡°ë¥¼ ë”°ë¦…ë‹ˆë‹¤.

```java
@Test
void test_example() {
    // given (ì¤€ë¹„)
    // - í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„±
    // - Mock ë™ì‘ ì •ì˜
    Order order = fixtureMonkey.giveMeOne(Order.class);
    given(orderStore.findById(1L)).willReturn(Optional.of(order));
    
    // when (ì‹¤í–‰)
    // - í…ŒìŠ¤íŠ¸í•  ë©”ì„œë“œ í˜¸ì¶œ
    Order result = orderService.getOrder(1L);
    
    // then (ê²€ì¦)
    // - ê²°ê³¼ ê²€ì¦
    // - ìƒíƒœ ë³€ê²½ ê²€ì¦
    // - Mock í˜¸ì¶œ ê²€ì¦
    assertThat(result).isEqualTo(order);
    verify(orderStore).findById(1L);
}
```

---

### 2. í…ŒìŠ¤íŠ¸ ë„¤ì´ë° ê·œì¹™

**í˜•ì‹:** `{í…ŒìŠ¤íŠ¸_ëŒ€ìƒ}_{ì¡°ê±´}_{ì˜ˆìƒ_ê²°ê³¼}`

```java
// âœ… ì¢‹ì€ ì˜ˆ
@Test
void cancel_order_with_pending_status_changes_to_cancelled() { }

@Test
void cancel_already_cancelled_order_throws_exception() { }

// âŒ ë‚˜ìœ ì˜ˆ
@Test
void test1() { }

@Test
void cancelTest() { }
```

---

### 3. @DisplayName í™œìš©

```java
@Test
@DisplayName("ëŒ€ê¸° ì¤‘ì¸ ì£¼ë¬¸ì„ ì·¨ì†Œí•˜ë©´ ìƒíƒœê°€ CANCELLEDë¡œ ë³€ê²½ëœë‹¤")
void cancel_order_with_pending_status_changes_to_cancelled() {
    // ...
}
```

---

### 4. ì˜ˆì™¸ ì¼€ì´ìŠ¤ í…ŒìŠ¤íŠ¸

**í•„ìˆ˜ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤:**
- âœ… ì •ìƒ ì¼€ì´ìŠ¤ (Happy Path)
- âœ… ì˜ˆì™¸ ì¼€ì´ìŠ¤ (Exception)
- âœ… ê²½ê³„ê°’ ì¼€ì´ìŠ¤ (Boundary)
- âœ… Null ì¼€ì´ìŠ¤

**ì˜ˆì‹œ:**
```java
@Test
@DisplayName("ì£¼ë¬¸ ì·¨ì†Œ - ì •ìƒ ì¼€ì´ìŠ¤")
void cancel_order_success() { }

@Test
@DisplayName("ì£¼ë¬¸ ì·¨ì†Œ - ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì£¼ë¬¸")
void cancel_order_not_found() {
    assertThatThrownBy(() -> orderService.cancel(999L))
        .isInstanceOf(OrderNotFoundException.class);
}

@Test
@DisplayName("ì£¼ë¬¸ ì·¨ì†Œ - ì´ë¯¸ ì·¨ì†Œëœ ì£¼ë¬¸")
void cancel_order_already_cancelled() {
    assertThatThrownBy(() -> order.cancel("reason"))
        .isInstanceOf(OrderAlreadyCancelledException.class);
}

@Test
@DisplayName("ì£¼ë¬¸ ì·¨ì†Œ - null reason")
void cancel_order_with_null_reason() {
    assertThatThrownBy(() -> order.cancel(null))
        .isInstanceOf(IllegalArgumentException.class);
}
```

---

### 5. AssertJ í™œìš©

```java
// ê¸°ë³¸ ê²€ì¦
assertThat(order.getStatus()).isEqualTo(OrderStatus.CANCELLED);

// ì»¬ë ‰ì…˜ ê²€ì¦
assertThat(orders)
    .hasSize(3)
    .extracting("status")
    .containsOnly(OrderStatus.PENDING);

// ì˜ˆì™¸ ê²€ì¦
assertThatThrownBy(() -> order.cancel("reason"))
    .isInstanceOf(OrderAlreadyCancelledException.class)
    .hasMessage("ì´ë¯¸ ì·¨ì†Œëœ ì£¼ë¬¸ì…ë‹ˆë‹¤");

// ê°ì²´ ê²€ì¦
assertThat(order)
    .extracting("id", "status", "totalAmount")
    .containsExactly(1L, OrderStatus.PENDING, Money.of(10000));
```

---

### 6. Mockito í™œìš©

```java
// Mock ë™ì‘ ì •ì˜
given(orderStore.findById(1L)).willReturn(Optional.of(order));

// void ë©”ì„œë“œ Mock
willDoNothing().given(eventPublisher).publish(any());

// ì˜ˆì™¸ ë˜ì§€ê¸°
given(orderStore.findById(999L))
    .willThrow(new OrderNotFoundException());

// í˜¸ì¶œ ê²€ì¦
verify(orderStore).save(order);
verify(eventPublisher).publish(any(OrderCancelledEvent.class));

// í˜¸ì¶œ íšŸìˆ˜ ê²€ì¦
verify(orderStore, times(1)).save(order);
verify(eventPublisher, never()).publish(any());

// ì¸ì ìº¡ì²˜
ArgumentCaptor<Order> captor = ArgumentCaptor.forClass(Order.class);
verify(orderStore).save(captor.capture());
assertThat(captor.getValue().getStatus()).isEqualTo(OrderStatus.CANCELLED);
```

---

## âœ… í…ŒìŠ¤íŠ¸ ì²´í¬ë¦¬ìŠ¤íŠ¸

ë§¤ ì‘ì—…ë§ˆë‹¤ ë‹¤ìŒì„ í™•ì¸í•˜ì„¸ìš”:

### Domain Layer
- [ ] Entity ìƒì„± í…ŒìŠ¤íŠ¸
- [ ] ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ í…ŒìŠ¤íŠ¸
- [ ] ì˜ˆì™¸ ì¼€ì´ìŠ¤ í…ŒìŠ¤íŠ¸
- [ ] Value Object ë¶ˆë³€ì„± í…ŒìŠ¤íŠ¸

### Application Layer
- [ ] UseCase ì •ìƒ íë¦„ í…ŒìŠ¤íŠ¸
- [ ] UseCase ì˜ˆì™¸ ì¼€ì´ìŠ¤ í…ŒìŠ¤íŠ¸
- [ ] Mock í˜¸ì¶œ ê²€ì¦
- [ ] Command/Query ìœ íš¨ì„± í…ŒìŠ¤íŠ¸

### Infrastructure Layer
- [ ] Repository ì €ì¥/ì¡°íšŒ í…ŒìŠ¤íŠ¸
- [ ] Query ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ (N+1 ì²´í¬)
- [ ] íŠ¸ëœì­ì…˜ ê²©ë¦¬ í…ŒìŠ¤íŠ¸

### Interface Layer
- [ ] API ì •ìƒ ì‘ë‹µ í…ŒìŠ¤íŠ¸
- [ ] API ì˜ˆì™¸ ì‘ë‹µ í…ŒìŠ¤íŠ¸
- [ ] ìœ íš¨ì„± ê²€ì¦ í…ŒìŠ¤íŠ¸
- [ ] ì¸ì¦/ì¸ê°€ í…ŒìŠ¤íŠ¸
- [ ] REST Docs ë¬¸ì„œ ìƒì„± í™•ì¸ (snippets íŒŒì¼)
- [ ] Constraints ì»¬ëŸ¼ ì¶”ê°€ í™•ì¸
- [ ] ì»¤ìŠ¤í…€ í…œí”Œë¦¿ ê²½ë¡œ í™•ì¸ (`org/springframework/restdocs/templates/asciidoctor/`)

---

## ğŸš« ê¸ˆì§€ ì‚¬í•­

### 1. í…ŒìŠ¤íŠ¸ ì—†ì´ ì½”ë“œ ì‘ì„± ê¸ˆì§€
```java
// âŒ ì´ë ‡ê²Œ í•˜ì§€ ë§ˆì„¸ìš”
// í”„ë¡œë•ì…˜ ì½”ë“œë§Œ ì‘ì„±í•˜ê³  "ë‚˜ì¤‘ì— í…ŒìŠ¤íŠ¸ ì¶”ê°€"
```

### 2. Thread.sleep() ì‚¬ìš© ê¸ˆì§€
```java
// âŒ ë‚˜ìœ ì˜ˆ
@Test
void async_test() throws Exception {
    asyncService.process();
    Thread.sleep(1000);  // ê¸ˆì§€!
    verify(repository).save(any());
}

// âœ… ì¢‹ì€ ì˜ˆ - Awaitility ì‚¬ìš©
@Test
void async_test() {
    asyncService.process();
    
    await().atMost(Duration.ofSeconds(5))
        .untilAsserted(() -> {
            verify(repository).save(any());
        });
}
```

### 3. í…ŒìŠ¤íŠ¸ ê°„ ì˜ì¡´ì„± ê¸ˆì§€
```java
// âŒ ë‚˜ìœ ì˜ˆ - í…ŒìŠ¤íŠ¸ ìˆœì„œì— ì˜ì¡´
private static Order sharedOrder;

@Test
@Order(1)
void create_order() {
    sharedOrder = orderService.create(...);  // ê¸ˆì§€!
}

@Test
@Order(2)
void cancel_order() {
    orderService.cancel(sharedOrder.getId());  // ê¸ˆì§€!
}

// âœ… ì¢‹ì€ ì˜ˆ - ê° í…ŒìŠ¤íŠ¸ê°€ ë…ë¦½ì 
@Test
void cancel_order() {
    Order order = fixtureMonkey.giveMeOne(Order.class);
    orderService.cancel(order.getId());
}
```

### 4. ê³¼ë„í•œ Mock ì‚¬ìš© ê¸ˆì§€
```java
// âŒ ë‚˜ìœ ì˜ˆ - ë„ˆë¬´ ë§ì€ Mock
@Mock private Service1 service1;
@Mock private Service2 service2;
@Mock private Service3 service3;
// ... 10ê°œ ì´ìƒì˜ Mock

// ğŸ’¡ íŒíŠ¸: Mockì´ ë„ˆë¬´ ë§ë‹¤ë©´ ì„¤ê³„ë¥¼ ë‹¤ì‹œ ê²€í† í•˜ì„¸ìš”
```

---

## ğŸ“š ì°¸ê³  ìë£Œ

- [JUnit 5 User Guide](https://junit.org/junit5/docs/current/user-guide/)
- [AssertJ Documentation](https://assertj.github.io/doc/)
- [Fixture Monkey Documentation](https://naver.github.io/fixture-monkey/)
- [Mockito Documentation](https://javadoc.io/doc/org.mockito/mockito-core/latest/org/mockito/Mockito.html)
- [Spring REST Docs](https://docs.spring.io/spring-restdocs/docs/current/reference/htmlsingle/)
- [Spring REST Docs - Custom Templates](https://docs.spring.io/spring-restdocs/docs/current/reference/htmlsingle/#documenting-your-api-customizing-including-snippets)

---

ì´ ê·œì¹™ì„ ë”°ë¼ ê²¬ê³ í•˜ê³  ìœ ì§€ë³´ìˆ˜ ê°€ëŠ¥í•œ í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ì‘ì„±í•˜ì„¸ìš”! ğŸš€

---
alwaysApply: true
---

# Job Layer ê·œì¹™

## ìœ„ì¹˜
`job/`

## ì €ì¥ì†Œ êµ¬ì¡°

```
job/
â”œâ”€â”€ src/main/java/vroong/laas/order/job/
â”‚   â”œâ”€â”€ JobApplication.java          # Main Application
â”‚   â”œâ”€â”€ common/
â”‚   â”‚   â”œâ”€â”€ aspect/
â”‚   â”‚   â”‚   â””â”€â”€ ScheduledJobLoggingAspect.java  # AOP (ë¡œê¹…, ì˜ˆì™¸ì²˜ë¦¬)
â”‚   â”‚   â””â”€â”€ config/
â”‚   â”‚       â”œâ”€â”€ SchedulingConfig.java        # Thread Pool ì„¤ì •
â”‚   â”‚       â”œâ”€â”€ SchedulingProperties.java    # Thread Pool ì„¤ì • Properties
â”‚   â”‚       â””â”€â”€ *Properties.java             # ê¸°íƒ€ ì„¤ì • í´ë˜ìŠ¤
â”‚   â”œâ”€â”€ scheduled/
â”‚   â”‚   â””â”€â”€ BaseScheduledJob.java    # ê¸°ë³¸ ì¸í„°í˜ì´ìŠ¤
â”‚   â””â”€â”€ outbox/                       # â­ ê¸°ëŠ¥ë³„ íŒ¨í‚¤ì§€
â”‚       â””â”€â”€ OutboxEventPublishJob.java     # Outbox Event Publish Job
â””â”€â”€ src/main/resources/
    â””â”€â”€ application.yml
```

## ì±…ì„
- Scheduled Job ì‹¤í–‰
- Outbox Polling (Outbox â†’ Kafka ì „ì†¡)
- ì£¼ê¸°ì ì¸ í†µê³„ ì§‘ê³„
- ë°ì´í„° ì •ë¦¬ ì‘ì—…

---

## í•„ìˆ˜ ê·œì¹™ â­

### 1. BaseScheduledJob êµ¬í˜„

**ëª¨ë“  Scheduled Jobì€ BaseScheduledJob ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•´ì•¼ í•©ë‹ˆë‹¤.**

#### âœ… ì˜¬ë°”ë¥¸ ì˜ˆ

```java
@Component
@RequiredArgsConstructor
@Slf4j
public class OutboxEventPublishJob implements BaseScheduledJob {
    
    private final OutboxEventService outboxEventService;
    private final OutboxEventPublishProperties properties;
    
    @Scheduled(fixedDelay = 10000)
    @Override
    public void execute() {
        // ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
        int count = outboxEventService.publishPendingEvents(properties.getBatchSize());
        
        if (count > 0) {
            log.info("Published {} events from outbox to Kafka", count);
        }
    }
}
```

**AOPê°€ ìë™ìœ¼ë¡œ ì œê³µí•˜ëŠ” ê¸°ëŠ¥:**
- âœ… ì‹¤í–‰ ì‹œì‘/ì¢…ë£Œ ë¡œê¹… (`[JobName] Job started/completed`)
- âœ… ì‹¤í–‰ ì‹œê°„ ìë™ ì¸¡ì •
- âœ… ì˜ˆì™¸ ìë™ ì²˜ë¦¬ (ë‹¤ìŒ ì‹¤í–‰ ë³´ì¥)
- âœ… ì¼ê´€ëœ ë¡œê¹… í¬ë§·

**ë¡œê·¸ ì¶œë ¥ ì˜ˆì‹œ:**
```
2025-01-12 10:00:00.123 DEBUG [OutboxEventPublishJob] Job started
2025-01-12 10:00:00.456 INFO  Published 3 events from outbox to Kafka
2025-01-12 10:00:00.789 INFO  [OutboxEventPublishJob] Job completed successfully in 666ms
```

---

### 2. 1ê°œ í´ë˜ìŠ¤ = 1ê°œ ì‘ì—…

**í•œ í´ë˜ìŠ¤ì—ëŠ” í•˜ë‚˜ì˜ @Scheduled ë©”ì„œë“œë§Œ ì¡´ì¬í•´ì•¼ í•©ë‹ˆë‹¤.**

#### âŒ ë‚˜ìœ ì˜ˆ - ì—¬ëŸ¬ ì‘ì—…ì„ í•œ í´ë˜ìŠ¤ì—

```java
@Component
public class OrderJob implements BaseScheduledJob {
    
    @Scheduled(fixedDelay = 10000)
    @Override
    public void execute() {
        pollOutbox();
    }
    
    @Scheduled(cron = "0 0 1 * * *")  // âŒ ê¸ˆì§€! ë‹¤ë¥¸ ì‘ì—…
    public void calculateStatistics() {
        // ...
    }
}
```

#### âœ… ì¢‹ì€ ì˜ˆ - ì‘ì—…ë³„ë¡œ í´ë˜ìŠ¤ ë¶„ë¦¬

```java
// OutboxEventPublishJob.java
@Component
public class OutboxEventPublishJob implements BaseScheduledJob {
    
    @Scheduled(fixedDelay = 10000)
    @Override
    public void execute() {
        // Outbox Polling ë¡œì§
    }
}

// OrderStatisticsJob.java
@Component
public class OrderStatisticsJob implements BaseScheduledJob {
    
    @Scheduled(cron = "0 0 1 * * *")
    @Override
    public void execute() {
        // í†µê³„ ì§‘ê³„ ë¡œì§
    }
}
```

**ì´ìœ :**
- âœ… ë‹¨ì¼ ì±…ì„ ì›ì¹™ (SRP)
- âœ… í…ŒìŠ¤íŠ¸ ìš©ì´
- âœ… ë…ë¦½ì ì¸ í™œì„±í™”/ë¹„í™œì„±í™” ê°€ëŠ¥
- âœ… ë…ë¦½ì ì¸ ì‹¤í–‰ ì£¼ê¸° ê´€ë¦¬

---

### 3. í´ë˜ìŠ¤ ì´ë¦„ì€ *Jobìœ¼ë¡œ ëë‚˜ì•¼ í•¨

**ëª¨ë“  Scheduled Job í´ë˜ìŠ¤ëŠ” "Job" ì ‘ë¯¸ì‚¬ë¡œ ëë‚˜ì•¼ í•©ë‹ˆë‹¤.**

#### âœ… ì˜¬ë°”ë¥¸ ì´ë¦„

```java
OutboxEventPublishJob
OrderStatisticsJob
DataCleanupJob
OrderNotificationJob
```

#### âŒ ì˜ëª»ëœ ì´ë¦„

```java
OutboxPoller          // Job ì ‘ë¯¸ì‚¬ ì—†ìŒ
OrderStatistics       // Job ì ‘ë¯¸ì‚¬ ì—†ìŒ
CleanupScheduler      // SchedulerëŠ” ì‚¬ìš© ì•ˆ í•¨
OrderTask             // TaskëŠ” ì‚¬ìš© ì•ˆ í•¨
```

**ì´ìœ :**
- âœ… ëª…í™•í•œ ì‹ë³„ (Jobì„ì„ ì¦‰ì‹œ ì•Œ ìˆ˜ ìˆìŒ)
- âœ… ì¼ê´€ëœ ë„¤ì´ë° ê·œì¹™
- âœ… AOP ë¡œê¹…ì—ì„œ í´ë˜ìŠ¤ëª… ì‚¬ìš©

---

## Scheduled ì• ë…¸í…Œì´ì…˜ ê·œì¹™

### Scheduling ì˜µì…˜

| ë°©ë²• | ìš©ë„ | ì˜ˆì‹œ |
|---|---|-----|
| `fixedDelay` | ì´ì „ ì‹¤í–‰ ì™„ë£Œ í›„ N ms ëŒ€ê¸° | Outbox Polling (10ì´ˆ) |
| `fixedRate` | N msë§ˆë‹¤ ì‹¤í–‰ (ì´ì „ ì‹¤í–‰ ë¬´ê´€) | Health Check (1ë¶„) |
| `cron` | Cron í‘œí˜„ì‹ | ì¼ì¼ í†µê³„ (ìƒˆë²½ 1ì‹œ) |

```java
// fixedDelay - ê¶Œì¥ (ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€)
@Scheduled(fixedDelayString = "${job.outbox.publish.fixed-delay:10000}")
@Override
public void execute() {
    // ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
}

// cron - ì •í•´ì§„ ì‹œê°„ì— ì‹¤í–‰
@Scheduled(cron = "0 0 1 * * *")  // ë§¤ì¼ ìƒˆë²½ 1ì‹œ
@Override
public void execute() {
    // ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
}

// fixedRate - ì£¼ì˜ (ì´ì „ ì‹¤í–‰ê³¼ ë¬´ê´€í•˜ê²Œ ì‹¤í–‰)
@Scheduled(fixedRate = 60000)  // 1ë¶„ë§ˆë‹¤
@Override
public void execute() {
    // ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
}
```

---

## Multi-Thread ì„¤ì • â­

### ê¸°ë³¸ ë™ì‘

**Spring @ScheduledëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ë‹¨ì¼ ìŠ¤ë ˆë“œë¡œ ë™ì‘í•©ë‹ˆë‹¤.**

```
OutboxEventPublishJob (10ì´ˆë§ˆë‹¤)
  â†“ ì‹¤í–‰ ì™„ë£Œ ëŒ€ê¸°
OrderStatisticsJob (1ì‹œê°„ë§ˆë‹¤)
  â†“ ì‹¤í–‰ ì™„ë£Œ ëŒ€ê¸°
DataCleanupJob (2ì‹œê°„ë§ˆë‹¤)
```

**ë¬¸ì œ:**
- âŒ Jobì´ ìˆœì°¨ì ìœ¼ë¡œ ì‹¤í–‰ë¨
- âŒ ê¸´ ì‹¤í–‰ ì‹œê°„ì˜ Jobì´ ë‹¤ë¥¸ Jobì„ ë¸”ë¡œí‚¹
- âŒ ë™ì‹œì— ì‹¤í–‰ë˜ì–´ì•¼ í•  Jobë“¤ì´ ëŒ€ê¸°

### Thread Pool ì„¤ì •

**SchedulingConfig.java**ë¡œ Thread Poolì„ ì„¤ì •í•©ë‹ˆë‹¤.

```java
// job/common/config/SchedulingConfig.java
@Configuration
@RequiredArgsConstructor
public class SchedulingConfig {

  private final SchedulingProperties properties;

  @Bean
  public ThreadPoolTaskScheduler taskScheduler() {
    ThreadPoolTaskScheduler scheduler = new ThreadPoolTaskScheduler();
    
    // Thread Pool Size: ë™ì‹œì— ì‹¤í–‰ ê°€ëŠ¥í•œ Job ìˆ˜
    scheduler.setPoolSize(properties.getPoolSize());
    
    // Thread ì´ë¦„ Prefix (ë¡œê¹…, ë””ë²„ê¹… ì‹œ ìœ ìš©)
    scheduler.setThreadNamePrefix(properties.getThreadNamePrefix());
    
    // Daemon Thread ì—¬ë¶€ (false: ì• í”Œë¦¬ì¼€ì´ì…˜ ì¢…ë£Œ ì‹œ ì‘ì—… ì™„ë£Œ ëŒ€ê¸°)
    scheduler.setDaemon(false);
    
    // Graceful Shutdown: ì¢…ë£Œ ì‹œ ì‹¤í–‰ ì¤‘ì¸ Job ì™„ë£Œ ëŒ€ê¸°
    scheduler.setWaitForTasksToCompleteOnShutdown(true);
    
    // Shutdown ëŒ€ê¸° ì‹œê°„ (ì´ˆ)
    scheduler.setAwaitTerminationSeconds(properties.getAwaitTerminationSeconds());
    
    scheduler.initialize();
    
    return scheduler;
  }
}
```

```java
// job/common/config/SchedulingProperties.java
@Component
@ConfigurationProperties(prefix = "job.scheduling")
@Getter
@Setter
public class SchedulingProperties {
    
    private int poolSize = 10;
    private String threadNamePrefix = "scheduled-job-";
    private int awaitTerminationSeconds = 60;
}
```

```yaml
# application.yml
job:
  scheduling:
    pool-size: 10
    thread-name-prefix: "scheduled-job-"
    await-termination-seconds: 60
```

### Thread Pool ì ìš© í›„

**ì—¬ëŸ¬ Jobì´ ë™ì‹œì— ì‹¤í–‰ë©ë‹ˆë‹¤.**

```
OutboxEventPublishJob (10ì´ˆë§ˆë‹¤) â”€â”€â”
OrderStatisticsJob (1ì‹œê°„ë§ˆë‹¤) â”œâ”€â†’ Thread Pool (ë™ì‹œ ì‹¤í–‰)
DataCleanupJob (2ì‹œê°„ë§ˆë‹¤) â”€â”€â”€â”€â”˜
```

**ì¥ì :**
- âœ… Jobì´ ë³‘ë ¬ë¡œ ì‹¤í–‰
- âœ… ê¸´ ì‹¤í–‰ ì‹œê°„ì˜ Jobì´ ë‹¤ë¥¸ Jobì„ ë¸”ë¡œí‚¹í•˜ì§€ ì•ŠìŒ
- âœ… ë” ë†’ì€ ì²˜ë¦¬ëŸ‰

### Pool Size ê²°ì •

**ê¶Œì¥:**
- **ì¼ë°˜ì ì¸ ê²½ìš°**: 10-20
- **Jobì´ ë§ì€ ê²½ìš°**: Job ê°œìˆ˜ Ã— 1.5
- **CPU ì§‘ì•½ì **: CPU ì½”ì–´ ìˆ˜
- **I/O ì§‘ì•½ì **: CPU ì½”ì–´ ìˆ˜ Ã— 2

**ì˜ˆì‹œ:**
```java
// Job ê°œìˆ˜: 5ê°œ, I/O ì§‘ì•½ì  (DB, Kafka)
scheduler.setPoolSize(10);  // 5 Ã— 2
```

### Graceful Shutdown

**setWaitForTasksToCompleteOnShutdown(true)**
- ì• í”Œë¦¬ì¼€ì´ì…˜ ì¢…ë£Œ ì‹œ ì‹¤í–‰ ì¤‘ì¸ Job ì™„ë£Œ ëŒ€ê¸°
- ë°ì´í„° ìœ ì‹¤ ë°©ì§€

**setAwaitTerminationSeconds(60)**
- ìµœëŒ€ 60ì´ˆ ëŒ€ê¸°
- ì´ˆê³¼ ì‹œ ê°•ì œ ì¢…ë£Œ

### Thread ì´ë¦„ í™•ì¸

**ë¡œê·¸ì—ì„œ Thread ì´ë¦„ í™•ì¸ ê°€ëŠ¥:**
```
2025-01-12 10:00:00.123 INFO [scheduled-job-1] [OutboxEventPublishJob] Job started
2025-01-12 10:00:00.456 INFO [scheduled-job-2] [OrderStatisticsJob] Job started
2025-01-12 10:00:00.789 INFO [scheduled-job-3] [DataCleanupJob] Job started
```

### ì£¼ì˜ì‚¬í•­

**1. Thread-Safe í•„ìš”**
```java
// âŒ ìœ„í—˜: ì—¬ëŸ¬ Threadì—ì„œ ê³µìœ ë˜ëŠ” mutable ìƒíƒœ
@Component
public class UnsafeJob implements BaseScheduledJob {
    private int counter = 0;  // âŒ Thread-Safe í•˜ì§€ ì•ŠìŒ
    
    @Scheduled(fixedDelay = 1000)
    @Override
    public void execute() {
        counter++;  // Race condition ë°œìƒ ê°€ëŠ¥
    }
}

// âœ… ì•ˆì „: Stateless ë˜ëŠ” Thread-Safe
@Component
public class SafeJob implements BaseScheduledJob {
    private final AtomicInteger counter = new AtomicInteger(0);  // âœ… Thread-Safe
    
    @Scheduled(fixedDelay = 1000)
    @Override
    public void execute() {
        counter.incrementAndGet();
    }
}
```

**2. ë™ì‹œ ì‹¤í–‰ ë°©ì§€ê°€ í•„ìš”í•œ ê²½ìš°**

ê°™ì€ Jobì´ ì¤‘ë³µ ì‹¤í–‰ë˜ë©´ ì•ˆ ë˜ëŠ” ê²½ìš°:

```java
@Component
public class CriticalJob implements BaseScheduledJob {
    
    private final AtomicBoolean running = new AtomicBoolean(false);
    
    @Scheduled(fixedDelay = 1000)
    @Override
    public void execute() {
        // ì´ë¯¸ ì‹¤í–‰ ì¤‘ì´ë©´ ìŠ¤í‚µ
        if (!running.compareAndSet(false, true)) {
            log.warn("Job is already running, skipping this execution");
            return;
        }
        
        try {
            // ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
        } finally {
            running.set(false);
        }
    }
}
```

**3. ë¶„ì‚° í™˜ê²½ì—ì„œ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€**

ì—¬ëŸ¬ ì„œë²„ì—ì„œ ë™ì¼í•œ Jobì´ ì‹¤í–‰ë˜ëŠ” ê²½ìš°:
- ShedLock ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš© ê¶Œì¥
- Redis, DB ë“±ìœ¼ë¡œ ë¶„ì‚° ë½ êµ¬í˜„

---

## ì„¤ì • ê´€ë¦¬

### Properties í´ë˜ìŠ¤ ì‚¬ìš©

**application.yml ì„¤ì •ì€ @ConfigurationPropertiesë¡œ ë§¤í•‘í•©ë‹ˆë‹¤.**

```java
// job/common/config/OutboxEventPublishProperties.java
@Component
@ConfigurationProperties(prefix = "job.outbox.publish")
@Getter
@Setter
public class OutboxEventPublishProperties {
    
    private boolean enabled = true;
    private long fixedDelay = 10000;
    private int batchSize = 100;
}
```

```yaml
# application.yml
job:
  outbox:
    polling:
      enabled: true
      fixed-delay: 10000
      batch-size: 100
```

### @ConditionalOnPropertyë¡œ í™œì„±í™” ì œì–´

```java
@Component
@ConditionalOnProperty(
    prefix = "job.outbox.publish",
    name = "enabled",
    havingValue = "true",
    matchIfMissing = false
)
public class OutboxEventPublishJob implements BaseScheduledJob {
    // ...
}
```

**ì¥ì :**
- âœ… í™˜ê²½ë³„ Job í™œì„±í™”/ë¹„í™œì„±í™” ê°€ëŠ¥
- âœ… í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œ Job ì œì™¸ ê°€ëŠ¥
- âœ… `matchIfMissing = false`ë¡œ ëª…ì‹œì  ì„¤ì • ê°•ì œ (ì•ˆì „)

---

## ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ í˜¸ì¶œ ê·œì¹™

### Domain Service í˜¸ì¶œ (í•„ìˆ˜)

**Jobì€ Domain Serviceë¥¼ í†µí•´ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ í˜¸ì¶œí•´ì•¼ í•©ë‹ˆë‹¤.**

#### âœ… ì¢‹ì€ ì˜ˆ - Domain Service í˜¸ì¶œ

```java
@Component
@RequiredArgsConstructor
public class OrderStatisticsJob implements BaseScheduledJob {
    
    private final OrderReader orderReader;  // Domain Service
    
    @Scheduled(cron = "0 0 1 * * *")
    @Override
    public void execute() {
        LocalDate yesterday = LocalDate.now().minusDays(1);
        
        // Domain Service í˜¸ì¶œ
        var statistics = orderReader.calculateStatistics(yesterday);
        
        log.info("Daily statistics calculated: {}", statistics);
    }
}

// Outbox Pollingë„ ë™ì¼í•œ íŒ¨í„´
@Component
@RequiredArgsConstructor
public class OutboxEventPublishJob implements BaseScheduledJob {
    
    private final OutboxEventPublisher outboxEventPublisher;  // Domain Service
    
    @Scheduled(fixedDelay = 10000)
    @Override
    public void execute() {
        // Domain Service í˜¸ì¶œ
        int count = outboxEventPublisher.publishPendingEvents(100);
        
        if (count > 0) {
            log.info("Published {} events", count);
        }
    }
}
```

#### âŒ ë‚˜ìœ ì˜ˆ - Infrastructure ì§ì ‘ í˜¸ì¶œ

```java
// âŒ ë‚˜ìœ ì˜ˆ 1: Repository ì§ì ‘ í˜¸ì¶œ
@Component
@RequiredArgsConstructor
public class OrderStatisticsJob implements BaseScheduledJob {
    
    private final OrderRepository orderRepository;  // âŒ ê¸ˆì§€!
    
    @Scheduled(cron = "0 0 1 * * *")
    @Override
    public void execute() {
        // Repository ì§ì ‘ í˜¸ì¶œ ê¸ˆì§€!
        List<Order> orders = orderRepository.findAll();
        
        // ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì§ì ‘ êµ¬í˜„ ê¸ˆì§€!
        long count = orders.stream()
            .filter(o -> o.getStatus() == OrderStatus.COMPLETED)
            .count();
    }
}

// âŒ ë‚˜ìœ ì˜ˆ 2: Infrastructure í´ë˜ìŠ¤ ì§ì ‘ ì˜ì¡´
@Component
@RequiredArgsConstructor
public class OutboxEventPublishJob implements BaseScheduledJob {
    
    private final OutboxEventService outboxEventService;  // âŒ ê¸ˆì§€! (Infrastructure)
    
    @Scheduled(fixedDelay = 10000)
    @Override
    public void execute() {
        // Infrastructure ì§ì ‘ í˜¸ì¶œ ê¸ˆì§€!
        outboxEventService.publishPendingEvents(100);
    }
}
```

**ê·œì¹™:**
- âœ… Domain Serviceë§Œ í˜¸ì¶œ
- âŒ Repository ì§ì ‘ í˜¸ì¶œ ê¸ˆì§€
- âŒ Infrastructure í´ë˜ìŠ¤ ì§ì ‘ ì˜ì¡´ ê¸ˆì§€
- âŒ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì§ì ‘ êµ¬í˜„ ê¸ˆì§€
- âŒ íŠ¸ëœì­ì…˜ ê´€ë¦¬ ê¸ˆì§€ (Domain Serviceì—ì„œ)

---

## ì˜ˆì™¸ ì²˜ë¦¬

### AOPê°€ ìë™ìœ¼ë¡œ ì²˜ë¦¬

**ScheduledJobLoggingAspectê°€ ìë™ìœ¼ë¡œ ì˜ˆì™¸ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤.**

```java
@Component
public class OutboxEventPublishJob implements BaseScheduledJob {
    
    @Scheduled(fixedDelay = 10000)
    @Override
    public void execute() {
        // ì˜ˆì™¸ ë°œìƒ ì‹œ AOPê°€ ìë™ìœ¼ë¡œ:
        // 1. ì—ëŸ¬ ë¡œê·¸ ê¸°ë¡
        // 2. ì˜ˆì™¸ ì‚¼í‚´ (ë‹¤ìŒ ì‹¤í–‰ ë³´ì¥)
        outboxEventService.publishPendingEvents(batchSize);
    }
}
```

**ìë™ ì²˜ë¦¬:**
```
2025-01-12 10:00:00.123 DEBUG [OutboxEventPublishJob] Job started
2025-01-12 10:00:00.456 ERROR [OutboxEventPublishJob] Job failed after 333ms: Connection timeout
  ... stack trace ...
```

### íŠ¹ìˆ˜í•œ ì˜ˆì™¸ ì²˜ë¦¬ê°€ í•„ìš”í•œ ê²½ìš°

```java
@Component
public class CustomJob implements BaseScheduledJob {
    
    @Scheduled(fixedDelay = 10000)
    @Override
    public void execute() {
        try {
            // ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
        } catch (SpecificException e) {
            // íŠ¹ìˆ˜ ì²˜ë¦¬
            log.warn("Specific error handled", e);
            // ì˜ˆì™¸ë¥¼ ë‹¤ì‹œ ë˜ì§€ì§€ ì•Šìœ¼ë©´ ì„±ê³µìœ¼ë¡œ ê°„ì£¼
        }
    }
}
```

---

## í…ŒìŠ¤íŠ¸ ê·œì¹™

### Job ë‹¨ìœ„ í…ŒìŠ¤íŠ¸

```java
@ExtendWith(MockitoExtension.class)
class OutboxEventPublishJobTest {
    
    @InjectMocks
    private OutboxEventPublishJob job;
    
    @Mock
    private OutboxEventService outboxEventService;
    
    @Mock
    private OutboxEventPublishProperties properties;
    
    @Test
    void execute_publishesEvents_whenPendingEventsExist() {
        // given
        given(properties.getBatchSize()).willReturn(100);
        given(outboxEventService.publishPendingEvents(100)).willReturn(3);
        
        // when
        job.execute();
        
        // then
        verify(outboxEventService).publishPendingEvents(100);
    }
}
```

### í†µí•© í…ŒìŠ¤íŠ¸ì—ì„œ Job ë¹„í™œì„±í™”

```yaml
# src/test/resources/application.yml
job:
  outbox:
    polling:
      enabled: false  # í…ŒìŠ¤íŠ¸ì—ì„œ Job ë¹„í™œì„±í™”
```

---

## ì‹¤ì „ ì˜ˆì‹œ: OutboxEventPublishJob

```java
package vroong.laas.order.job.outbox;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Component;
import vroong.laas.order.core.domain.outbox.OutboxEventPublisher;
import vroong.laas.order.job.common.config.OutboxEventPublishProperties;

/**
 * Outbox Polling Job
 *
 * <p>Outbox í…Œì´ë¸”ì—ì„œ ë¯¸ì „ì†¡ ì´ë²¤íŠ¸ë¥¼ Kafkaë¡œ ì „ì†¡í•©ë‹ˆë‹¤.
 *
 * <p>ì‹¤í–‰ ì£¼ê¸°: 10ì´ˆ (job.outbox.publish.fixed-delay)
 *
 * <p>AOPê°€ ìë™ìœ¼ë¡œ ë¡œê¹…, ì‹¤í–‰ ì‹œê°„ ì¸¡ì •, ì˜ˆì™¸ ì²˜ë¦¬ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.
 *
 * <p>ì•„í‚¤í…ì²˜:
 * <pre>
 * OutboxEventPublishJob (Job Layer)
 *   â†’ OutboxEventPublisher (Domain Service)
 *     â†’ OutboxEventClient (Port)
 *       â†’ KafkaOutboxEventClient (Infrastructure Adapter)
 * </pre>
 */
@Component
@RequiredArgsConstructor
@Slf4j
@ConditionalOnProperty(
    prefix = "job.outbox.publish",
    name = "enabled",
    havingValue = "true",
    matchIfMissing = false
)
public class OutboxEventPublishJob implements BaseScheduledJob {
    
    private final OutboxEventPublisher outboxEventPublisher;  // Domain Service
    private final OutboxEventPublishProperties properties;
    
    /**
     * Outbox Polling ì‹¤í–‰
     *
     * <p>ScheduledJobLoggingAspectê°€ ìë™ìœ¼ë¡œ ë¡œê¹… ë° ì˜ˆì™¸ ì²˜ë¦¬ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.
     */
    @Scheduled(fixedDelayString = "${job.outbox.publish.fixed-delay:10000}")
    @Override
    public void execute() {
        int publishedCount = outboxEventPublisher.publishPendingEvents(
            properties.getBatchSize()
        );
        
        if (publishedCount > 0) {
            log.info("Published {} events from outbox to Kafka", publishedCount);
        }
    }
}
```

---

## ì²´í¬ë¦¬ìŠ¤íŠ¸

ë§¤ Job ì‘ì„± ì‹œ í™•ì¸:

- [ ] BaseScheduledJob ì¸í„°í˜ì´ìŠ¤ êµ¬í˜„?
- [ ] 1ê°œ í´ë˜ìŠ¤ì— 1ê°œ @Scheduled ë©”ì„œë“œë§Œ?
- [ ] í´ë˜ìŠ¤ ì´ë¦„ì´ *Jobìœ¼ë¡œ ëë‚˜ëŠ”ê°€?
- [ ] execute() ë©”ì„œë“œì— @Scheduled ì• ë…¸í…Œì´ì…˜?
- [ ] Domain Serviceë§Œ í˜¸ì¶œ?
- [ ] Repository ì§ì ‘ í˜¸ì¶œ ì•ˆ í•¨?
- [ ] @ConditionalOnPropertyë¡œ í™œì„±í™” ì œì–´?
- [ ] Properties í´ë˜ìŠ¤ë¡œ ì„¤ì • ê´€ë¦¬?

---

## ê¸ˆì§€ ì‚¬í•­

### âŒ ì ˆëŒ€ í•˜ì§€ ë§ ê²ƒ

1. **ì—¬ëŸ¬ @Scheduled ë©”ì„œë“œë¥¼ í•œ í´ë˜ìŠ¤ì—**
   ```java
   // âŒ ê¸ˆì§€!
   @Component
   public class MultiJob implements BaseScheduledJob {
       @Scheduled(fixedDelay = 10000)
       @Override
       public void execute() { }
       
       @Scheduled(cron = "0 0 * * * *")
       public void anotherJob() { }
   }
   ```

2. **Repository ì§ì ‘ í˜¸ì¶œ**
   ```java
   // âŒ ê¸ˆì§€!
   private final OrderRepository orderRepository;
   ```

3. **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì§ì ‘ êµ¬í˜„**
   ```java
   // âŒ ê¸ˆì§€! Domain Serviceì—ì„œ êµ¬í˜„
   @Override
   public void execute() {
       Order order = orderRepository.findById(1L).orElseThrow();
       order.calculateTotalAmount();  // ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
   }
   ```

4. **íŠ¸ëœì­ì…˜ ì§ì ‘ ê´€ë¦¬**
   ```java
   // âŒ ê¸ˆì§€! Domain Serviceì—ì„œ ê´€ë¦¬
   @Override
   @Transactional
   public void execute() { }
   ```

5. **Job ì ‘ë¯¸ì‚¬ ì—†ëŠ” ì´ë¦„**
   ```java
   // âŒ ê¸ˆì§€!
   public class OutboxPoller implements BaseScheduledJob { }
   public class OrderStatistics implements BaseScheduledJob { }
   ```

---

## ì¤‘ìš” ì›ì¹™

1. **BaseScheduledJob ì¸í„°í˜ì´ìŠ¤ êµ¬í˜„** (í•„ìˆ˜)
2. **1ê°œ í´ë˜ìŠ¤ = 1ê°œ ì‘ì—…** (í•„ìˆ˜)
3. **í´ë˜ìŠ¤ ì´ë¦„ì€ *Job** (í•„ìˆ˜)
4. **ê¸°ëŠ¥ë³„ íŒ¨í‚¤ì§€ êµ¬ì„±** (outbox/, statistics/, cleanup/ ë“±)
5. **AOPê°€ ìë™ ë¡œê¹…/ì˜ˆì™¸ì²˜ë¦¬** (ScheduledJobLoggingAspect)
6. **Domain Serviceë§Œ í˜¸ì¶œ** (ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ê¸ˆì§€)
7. **@ConditionalOnPropertyë¡œ í™œì„±í™” ì œì–´**
8. **Properties í´ë˜ìŠ¤ë¡œ ì„¤ì • ê´€ë¦¬**
