# ë¶€ë¦‰ ì˜¤ë” ì„œë¹„ìŠ¤ - ë„ë©”ì¸ ì •ì±…

## ë¶€ë¦‰ ì˜¤ë” ë„ë©”ì¸

ë¶€ë¦‰ ì˜¤ë” ì„œë¹„ìŠ¤ëŠ” ê³ ê°ì˜ ë°°ì†¡ ì£¼ë¬¸ì„ ì ‘ìˆ˜í•˜ê³  ê´€ë¦¬í•˜ëŠ” ì„œë¹„ìŠ¤ì´ë‹¤.
ë¶€ë¦‰ì€ ë¹ ë¥´ê³  ì•ˆì „í•œ ë°°ì†¡ì„ ëª©í‘œë¡œ í•˜ë©°, ë‹¤ì–‘í•œ ìƒí’ˆì˜ ë°°ì†¡ì„ ì§€ì›í•œë‹¤.
ì£¼ë¬¸ì€ ì¶œë°œì§€ì—ì„œ ìƒí’ˆì„ í”½ì—…í•˜ì—¬ ë„ì°©ì§€ë¡œ ë°°ì†¡í•˜ëŠ” ì¼ë ¨ì˜ ê³¼ì •ì„ ë‚˜íƒ€ë‚¸ë‹¤.

### ì£¼ë¬¸ ìƒì„±

ì£¼ë¬¸ì´ ìƒì„±ë˜ë©´ ì‹œìŠ¤í…œì€ ìë™ìœ¼ë¡œ ê³ ìœ í•œ ì£¼ë¬¸ë²ˆí˜¸ë¥¼ ë¶€ì—¬í•œë‹¤.
ì£¼ë¬¸ë²ˆí˜¸ëŠ” "ORD-"ë¡œ ì‹œì‘í•˜ë©°, ìƒì„± ì‹œì ì˜ íƒ€ì„ìŠ¤íƒ¬í”„ì™€ ë‚œìˆ˜ë¡œ êµ¬ì„±ë˜ì–´ ì¤‘ë³µì„ ë°©ì§€í•œë‹¤.

ì£¼ë¬¸ì—ëŠ” ë°˜ë“œì‹œ ì¶œë°œì§€ì™€ ë„ì°©ì§€ ì •ë³´ê°€ í¬í•¨ë˜ì–´ì•¼ í•œë‹¤.
ê³ ê°ì´ ì…ë ¥í•œ ì£¼ì†ŒëŠ” ë¶€ì •í™•í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ì‹œìŠ¤í…œì€ ìœ„/ê²½ë„ ì¢Œí‘œë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì£¼ì†Œë¥¼ ì •ì œí•œë‹¤.
ì£¼ì†Œ ì •ì œëŠ” ì—¬ëŸ¬ ì—­ì§€ì˜¤ì½”ë”© ì„œë¹„ìŠ¤ë¥¼ í™œìš©í•˜ë©°, í•œ ì„œë¹„ìŠ¤ì— ì¥ì• ê°€ ë°œìƒí•˜ë©´ ìë™ìœ¼ë¡œ ë‹¤ë¥¸ ì„œë¹„ìŠ¤ë¥¼ ì‹œë„í•œë‹¤.
ëª¨ë“  ì„œë¹„ìŠ¤ê°€ ì‹¤íŒ¨í•˜ë©´ ì£¼ë¬¸ ìƒì„±ì´ ì¤‘ë‹¨ëœë‹¤.

ì£¼ë¬¸ì—ëŠ” ì£¼ë¬¸ ì•„ì´í…œì´ í¬í•¨ë  ìˆ˜ ìˆë‹¤.
ì£¼ë¬¸ ì•„ì´í…œì€ ìƒí’ˆëª…, ìˆ˜ëŸ‰, ê°€ê²©, ì¹´í…Œê³ ë¦¬ ì •ë³´ë¥¼ ê°€ì§„ë‹¤.
ë‹¤ë§Œ ì£¼ë¬¸ ì•„ì´í…œì´ ì—†ëŠ” ì£¼ë¬¸ë„ ê°€ëŠ¥í•˜ë‹¤.

ì£¼ë¬¸ì€ ë°°ì†¡ ì •ì±…ì„ ê°€ì§„ë‹¤.
ë°°ì†¡ ì •ì±…ì—ëŠ” ì£¼ë¥˜ ë°°ì†¡ ì—¬ë¶€, ë¹„ëŒ€ë©´ ë°°ì†¡ ì—¬ë¶€, ì˜ˆì•½ ë°°ì†¡ ì •ë³´ ë“±ì´ í¬í•¨ëœë‹¤.

ì£¼ë¬¸ì´ ìƒì„±ë˜ë©´ ì‹œìŠ¤í…œì€ ì´ë²¤íŠ¸ë¥¼ ë°œí–‰í•˜ì—¬ ë°°ì†¡ ì„œë¹„ìŠ¤ì™€ ë°°ì°¨ ì„œë¹„ìŠ¤ì— ì•Œë¦°ë‹¤.
ì´ë²¤íŠ¸ ë°œí–‰ì€ ì£¼ë¬¸ ì €ì¥ê³¼ ë™ì¼í•œ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ì²˜ë¦¬ë˜ì–´ ë°ì´í„° ì¼ê´€ì„±ì„ ë³´ì¥í•œë‹¤.
ì‹¤ì œ ì´ë²¤íŠ¸ ì „ì†¡ì€ ë³„ë„ Workerê°€ ë¹„ë™ê¸°ë¡œ ì²˜ë¦¬í•˜ë©°, ì „ì†¡ ì‹¤íŒ¨ ì‹œ ìë™ìœ¼ë¡œ ì¬ì‹œë„í•œë‹¤.

### ì£¼ë¬¸ ìƒíƒœ

ì£¼ë¬¸ì€ ìƒì„±(CREATED), ë°°ì†¡ì™„ë£Œ(DELIVERED), ì·¨ì†Œ(CANCELLED)ì˜ 3ê°€ì§€ ìƒíƒœë¥¼ ê°€ì§„ë‹¤.
ìƒì„±ëœ ì£¼ë¬¸ì€ ë°°ì†¡ì™„ë£Œ ë˜ëŠ” ì·¨ì†Œ ìƒíƒœë¡œ ì „ì´ë  ìˆ˜ ìˆë‹¤.
ë°°ì†¡ì™„ë£Œëœ ì£¼ë¬¸ì€ ì·¨ì†Œí•  ìˆ˜ ì—†ê³ , ì·¨ì†Œëœ ì£¼ë¬¸ì€ ë°°ì†¡ì™„ë£Œ ì²˜ë¦¬í•  ìˆ˜ ì—†ë‹¤.


---

## ğŸ“ ë„ë©”ì¸ ê·œì¹™

### 1. ì£¼ë¬¸ë²ˆí˜¸ (OrderNumber)

**í¬ë§· ê·œì¹™:**
- ë°˜ë“œì‹œ `"ORD-"`ë¡œ ì‹œì‘í•´ì•¼ í•¨
- ì˜ˆ: `"ORD-20251005123045001"`

**ê²€ì¦:**
```java
OrderNumber orderNumber = OrderNumber.of("ORD-20251002-001"); // âœ… ì„±ê³µ
OrderNumber orderNumber = OrderNumber.of("ORDER-001");         // âŒ ì˜ˆì™¸
OrderNumber orderNumber = OrderNumber.of("ord-001");           // âŒ ì˜ˆì™¸ (ì†Œë¬¸ì ë¶ˆê°€)
```

**ìƒì„± ê·œì¹™:**

ì£¼ë¬¸ë²ˆí˜¸ëŠ” **ì‹œìŠ¤í…œì´ ìë™ ìƒì„±**í•˜ë©°, ì‚¬ìš©ìê°€ ì§ì ‘ ì…ë ¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.

**ìƒì„± í˜•ì‹:**
```
ORD-YYYYMMDDHHMMSS + 3ìë¦¬ ë‚œìˆ˜
```

- `ORD-`: ê³ ì • ì ‘ë‘ì‚¬
- `YYYYMMDDHHMMSS`: ì£¼ë¬¸ ìƒì„± ì‹œì ì˜ íƒ€ì„ìŠ¤íƒ¬í”„
  - `YYYY`: ì—°ë„ (ì˜ˆ: 2025)
  - `MM`: ì›” (01-12)
  - `DD`: ì¼ (01-31)
  - `HH`: ì‹œ (00-23)
  - `MM`: ë¶„ (00-59)
  - `SS`: ì´ˆ (00-59)
- `3ìë¦¬ ë‚œìˆ˜`: 000-999 ì‚¬ì´ì˜ ëœë¤ ìˆ«ì (ë™ì¼ ì´ˆ ë‚´ ì¶©ëŒ ë°©ì§€)

**ì˜ˆì‹œ:**
```
ORD-20251005123045001
ORD-20251005123045742
ORD-20251005143022156
```

**ìƒì„± ë‹´ë‹¹:**
- `OrderNumberGenerator` (Domain Service)
- ì£¼ë¬¸ ìƒì„± ì‹œ `Order.create()` ë‚´ë¶€ì—ì„œ ìë™ í˜¸ì¶œ

**ì‚¬ìš© ì˜ˆ:**
```java
// OrderNumberGeneratorê°€ ìë™ ìƒì„±
OrderNumberGenerator generator = new OrderNumberGenerator();
OrderNumber orderNumber = generator.generate();
// â†’ "ORD-20251005123045001"
```

---

### 2. ì£¼ë¬¸ ìƒíƒœ (OrderStatus)

ì£¼ë¬¸ì€ ë‹¤ìŒ 3ê°€ì§€ ìƒíƒœë¥¼ ê°€ì§‘ë‹ˆë‹¤:

| ìƒíƒœ | ì„¤ëª… | ì „ì´ ê°€ëŠ¥ ìƒíƒœ |
|------|------|----------------|
| **CREATED** | ìƒì„± | DELIVERED, CANCELLED |
| **DELIVERED** | ë°°ì†¡ì™„ë£Œ | (ìµœì¢… ìƒíƒœ) |
| **CANCELLED** | ì·¨ì†Œ | (ìµœì¢… ìƒíƒœ) |

**ìƒíƒœ ì „ì´ ê·œì¹™:**

```java
// CREATED â†’ DELIVERED
Order order = Order.create(...);
order.markAsDelivered();  // âœ… ì„±ê³µ

// CREATED â†’ CANCELLED
Order order = Order.create(...);
order.cancel();  // âœ… ì„±ê³µ

// DELIVERED â†’ CANCELLED
Order deliveredOrder = ...;
deliveredOrder.cancel();  // âŒ ì˜ˆì™¸: "ë°°ì†¡ ì™„ë£Œëœ ì£¼ë¬¸ì€ ì·¨ì†Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤"

// CANCELLED â†’ DELIVERED
Order cancelledOrder = ...;
cancelledOrder.markAsDelivered();  // âŒ ì˜ˆì™¸: "ì·¨ì†Œëœ ì£¼ë¬¸ì€ ë°°ì†¡ ì™„ë£Œ ì²˜ë¦¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
```

---

### 3. ì£¼ë¬¸ ìƒì„±

**íŒ©í† ë¦¬ ë©”ì„œë“œ:**
```java
OrderNumberGenerator orderNumberGenerator = new OrderNumberGenerator();

Order order = Order.create(
    orderNumberGenerator,    // orderNumberGenerator (í•„ìˆ˜) - ì£¼ë¬¸ë²ˆí˜¸ ìë™ ìƒì„±
    List.of(orderItems),     // items (ì„ íƒ, null ê°€ëŠ¥)
    origin,                  // origin (í•„ìˆ˜)
    destination,             // destination (í•„ìˆ˜)
    deliveryPolicy          // deliveryPolicy (í•„ìˆ˜)
);
```

**í•„ìˆ˜ ê°’ ê²€ì¦:**
- `orderNumberGenerator`: null ë¶ˆê°€ (ì£¼ë¬¸ë²ˆí˜¸ ìë™ ìƒì„±ì„ ìœ„í•´)
- `origin`: null ë¶ˆê°€
- `destination`: null ë¶ˆê°€
- `deliveryPolicy`: null ë¶ˆê°€
- `items`: null ê°€ëŠ¥ (ë¹ˆ ë¦¬ìŠ¤íŠ¸ë¡œ ì´ˆê¸°í™”)

**ì£¼ë¬¸ë²ˆí˜¸ ìë™ ìƒì„±:**
- ì£¼ë¬¸ ìƒì„± ì‹œ `OrderNumberGenerator`ê°€ ìë™ìœ¼ë¡œ ì£¼ë¬¸ë²ˆí˜¸ ìƒì„±
- ì‚¬ìš©ìëŠ” ì£¼ë¬¸ë²ˆí˜¸ë¥¼ ì§ì ‘ ì§€ì •í•  ìˆ˜ ì—†ìŒ
- í˜•ì‹: `ORD-YYYYMMDDHHMMSS + 3ìë¦¬ ë‚œìˆ˜`

---

### 4. ì£¼ì†Œ ì •ì œ (Address Refinement)

**ê°œìš”:**

ì£¼ë¬¸ ìƒì„± ì‹œ, ì‚¬ìš©ìê°€ ì…ë ¥í•œ ì£¼ì†Œê°€ ë¶€ì •í™•í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ìœ„/ê²½ë„ ì¢Œí‘œë¥¼ ê¸°ë°˜ìœ¼ë¡œ **ì—­ì§€ì˜¤ì½”ë”©**í•˜ì—¬ ì •í™•í•œ ì£¼ì†Œë¡œ ì •ì œí•©ë‹ˆë‹¤.

**ì²˜ë¦¬ ì‹œì :**
- ì£¼ë¬¸ ìƒì„± ì‹œ (`OrderFacade.createOrder()`)
- Origin (ì¶œë°œì§€)ì™€ Destination (ë„ì°©ì§€) ëª¨ë‘ ì •ì œ

**ì—­ì§€ì˜¤ì½”ë”© ê³¼ì •:**
```java
// OrderFacadeì—ì„œ ì£¼ì†Œ ì •ì œ
public Order createOrder(CreateOrderCommand command) {
    // 1. Origin ì£¼ì†Œ ì •ì œ (ì—­ì§€ì˜¤ì½”ë”©)
    Origin refinedOrigin = refineOriginAddress(command.origin());
    
    // 2. Destination ì£¼ì†Œ ì •ì œ (ì—­ì§€ì˜¤ì½”ë”©)
    Destination refinedDestination = refineDestinationAddress(command.destination());
    
    // 3. ì •ì œëœ ì£¼ì†Œë¡œ Order ìƒì„±
    return orderCreator.create(items, refinedOrigin, refinedDestination, deliveryPolicy);
}
```

**Fallback Chain:**

ì—­ì§€ì˜¤ì½”ë”© ì„œë¹„ìŠ¤ëŠ” ì¥ì• ì— ëŒ€ë¹„í•˜ì—¬ **3ë‹¨ê³„ Fallback Chain**ì„ êµ¬ì„±í•©ë‹ˆë‹¤:

1. **1ìˆœìœ„: Neogeo** (ë‚´ë¶€ ì„œë¹„ìŠ¤)
2. **2ìˆœìœ„: Naver** (ì™¸ë¶€ ì„œë¹„ìŠ¤)
3. **3ìˆœìœ„: Kakao** (ì™¸ë¶€ ì„œë¹„ìŠ¤)

ê° ì„œë¹„ìŠ¤ê°€ ì‹¤íŒ¨í•˜ë©´ ìë™ìœ¼ë¡œ ë‹¤ìŒ ì„œë¹„ìŠ¤ë¡œ Fallbackí•©ë‹ˆë‹¤.

**Fallback ì¡°ê±´:**
- HTTP 4xx, 5xx ì—ëŸ¬
- Timeout (ê¸°ë³¸ 3ì´ˆ)
- ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬

**ì„¤ì • ë°©ë²•:**

```yaml
# application.yml
address:
  refinement:
    # Fallback ìˆœì„œ (í™˜ê²½ë³„ë¡œ ë³€ê²½ ê°€ëŠ¥)
    fallback-order:
      - neogeo
      - naver
      - kakao
    
    neogeo:
      url: ${NEOGEO_URL:http://neogeo-service}
      timeout-ms: 3000
    
    naver:
      url: https://naveropenapi.apigw.ntruss.com
      client-id: ${NAVER_CLIENT_ID}
      client-secret: ${NAVER_CLIENT_SECRET}
      timeout-ms: 3000
    
    kakao:
      url: https://dapi.kakao.com
      api-key: ${KAKAO_API_KEY}
      timeout-ms: 3000
```

**ì˜ˆì™¸ ì²˜ë¦¬:**

ëª¨ë“  ì—­ì§€ì˜¤ì½”ë”© ì„œë¹„ìŠ¤ê°€ ì‹¤íŒ¨í•˜ë©´ `AddressRefineFailedException`ì´ ë°œìƒí•˜ë©°, ì£¼ë¬¸ ìƒì„±ì´ ì‹¤íŒ¨í•©ë‹ˆë‹¤.

```java
// ëª¨ë“  Provider ì‹¤íŒ¨ ì‹œ
throw new AddressRefineFailedException("ëª¨ë“  ì—­ì§€ì˜¤ì½”ë”© ì„œë¹„ìŠ¤ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤");
```

**ì •ì œ ê²°ê³¼:**

ì •ì œëœ ì£¼ì†ŒëŠ” **ì›ë³¸ ì£¼ì†Œë¥¼ ë®ì–´ì“°ê¸°**í•˜ë©°, ë³„ë„ë¡œ DBì— ì €ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë¡œê·¸ì—ë§Œ ê¸°ë¡ë©ë‹ˆë‹¤.

```
[ì£¼ì†Œì •ì œ] ì‹œì‘: latLng=LatLng(37.5012, 127.0396), original=[ë„ë¡œëª…:ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 123]
[ì£¼ì†Œì •ì œ] Provider ì‹œë„: provider=NEOGEO, latLng=LatLng(37.5012, 127.0396)
[ì£¼ì†Œì •ì œ] ì‹¤íŒ¨: provider=NEOGEO, error=Neogeo API ë¯¸êµ¬í˜„ (Stub)
[ì£¼ì†Œì •ì œ] Provider ì‹œë„: provider=NAVER, latLng=LatLng(37.5012, 127.0396)
[ì£¼ì†Œì •ì œ] ì„±ê³µ: provider=NAVER, original=[ë„ë¡œëª…:ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 123] â†’ refined=[ë„ë¡œëª…:ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 123]
```

---

### 5. ë°°ì†¡ ì •ì±… (DeliveryPolicy)

ë°°ì†¡ê³¼ ê´€ë ¨ëœ ë‹¤ì–‘í•œ ì •ì±…ì„ ì •ì˜í•©ë‹ˆë‹¤.

**êµ¬ì„± ìš”ì†Œ:**
```java
DeliveryPolicy policy = new DeliveryPolicy(
    true,                           // alcoholDelivery (ì£¼ë¥˜ ë°°ì†¡)
    false,                          // contactlessDelivery (ë¹„ëŒ€ë©´ ë°°ì†¡)
    true,                           // reservedDelivery (ì˜ˆì•½ ë°°ì†¡)
    Instant.parse("2025-10-02T15:00:00Z"),  // reservedDeliveryStartTime
    Instant.parse("2025-10-02T14:30:00Z")   // pickupRequestTime
);
```

---

### 6. ìœ„ì¹˜ ì •ë³´

#### Origin (ì¶œë°œì§€)
```java
Origin origin = new Origin(
    new Contact("í™ê¸¸ë™", "010-1234-5678"),
    new Address("ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 123", "ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 123", "10ì¸µ"),
    new LatLng(new BigDecimal("37.5012"), new BigDecimal("127.0396"))
);
```

#### Destination (ë„ì°©ì§€)
```java
Destination destination = new Destination(
    new Contact("ê¹€ì² ìˆ˜", "010-9876-5432"),
    new Address("ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ ì—­ì‚¼ë™ 456", "ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ ì—­ì‚¼ë™ 456", "5ì¸µ"),
    new LatLng(new BigDecimal("37.5008"), new BigDecimal("127.0382")),
    new EntranceInfo("1234", "ë¹ ë¥¸ ë°°ì†¡ ë¶€íƒë“œë ¤ìš”")
);
```

---

### 7. ì£¼ë¬¸ ì•„ì´í…œ (OrderItem)

ê°œë³„ ì£¼ë¬¸ ìƒí’ˆì˜ ì •ë³´ë¥¼ ë‹´ìŠµë‹ˆë‹¤.

```java
OrderItem item = new OrderItem(
    "ë§¥ì£¼ 24ìº”",                          // itemName
    2,                                   // quantity
    new Money(new BigDecimal("30000")),  // price
    "ì£¼ë¥˜",                               // category
    new Weight(new BigDecimal("10.5")),  // weight (optional)
    new Volume(new BigDecimal("0.5"))    // volume (optional)
);

// ì´ ê¸ˆì•¡: 60000ì› (30000 Ã— 2)
```

---

### 8. ì´ë²¤íŠ¸ ë°œí–‰

ì£¼ë¬¸ì´ ìƒì„±ë˜ë©´ `OrderCreatedEvent`ê°€ ìë™ìœ¼ë¡œ ë°œí–‰ë©ë‹ˆë‹¤.

**ë°œí–‰ íë¦„:**
```java
// OrderCreator (Domain Service)
public Order create(...) {
    // 1. Order ì €ì¥
    Order order = orderRepository.store(...);
    
    // 2. Outbox ì €ì¥ (ê°™ì€ íŠ¸ëœì­ì…˜)
    outboxEventAppender.append(OutboxEventType.ORDER_CREATED, order);
    
    return order;
}

// 3. Kafka ì´ë²¤íŠ¸ ë°œí–‰ (ë¹„ë™ê¸°, Outbox Worker)
// Topic: order.order.created
```

**íŠ¹ì§•:**
- Order ì €ì¥ê³¼ Outbox ì €ì¥ì€ ë™ì¼í•œ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ì²˜ë¦¬
- ì‹¤ì œ Kafka ì „ì†¡ì€ ë³„ë„ Workerê°€ ë¹„ë™ê¸°ë¡œ ì²˜ë¦¬
- ì „ì†¡ ì‹¤íŒ¨ ì‹œ ìë™ìœ¼ë¡œ ì¬ì‹œë„

---

## ğŸ“Œ Value Object ë¶ˆë³€ ì›ì¹™

Value ObjectëŠ” ìƒì„± í›„ ê°’ì„ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤:
- `OrderNumber`
- `Money`
- `Weight`
- `Volume`
- `Address`
- `Contact`
- `LatLng`
- `EntranceInfo`
- `OrderItem`
- `Origin`
- `Destination`
- `DeliveryPolicy`

**ê·œì¹™:**
- í•œ ë²ˆ ìƒì„±ëœ Value ObjectëŠ” ìˆ˜ì • ë¶ˆê°€
- ìƒˆë¡œìš´ ê°’ì´ í•„ìš”í•˜ë©´ ìƒˆë¡œìš´ ê°ì²´ë¥¼ ìƒì„±
- ì˜ˆ: ê¸ˆì•¡ 10,000ì› + 10,000ì› = ìƒˆë¡œìš´ 20,000ì› ê°ì²´
