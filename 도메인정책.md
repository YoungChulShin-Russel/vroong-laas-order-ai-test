# 부릉 오더 서비스 - 도메인 정책

## 부릉 오더 도메인

부릉 오더 서비스는 고객의 배송 주문을 접수하고 관리하는 서비스이다.
부릉은 빠르고 안전한 배송을 목표로 하며, 다양한 상품의 배송을 지원한다.
주문은 출발지에서 상품을 픽업하여 도착지로 배송하는 일련의 과정을 나타낸다.

### 주문 생성

주문이 생성되면 시스템은 자동으로 고유한 주문번호를 부여한다.
주문번호는 "ORD-"로 시작하며, 생성 시점의 타임스탬프와 난수로 구성되어 중복을 방지한다.

주문에는 반드시 출발지와 도착지 정보가 포함되어야 한다.
고객이 입력한 주소는 부정확할 수 있으므로, 시스템은 위/경도 좌표를 기반으로 주소를 정제한다.
주소 정제는 여러 역지오코딩 서비스를 활용하며, 한 서비스에 장애가 발생하면 자동으로 다른 서비스를 시도한다.
모든 서비스가 실패하면 주문 생성이 중단된다.

주문에는 주문 아이템이 포함될 수 있다.
주문 아이템은 상품명, 수량, 가격, 카테고리 정보를 가진다.
다만 주문 아이템이 없는 주문도 가능하다.

주문은 배송 정책을 가진다.
배송 정책에는 주류 배송 여부, 비대면 배송 여부, 예약 배송 정보 등이 포함된다.

주문이 생성되면 시스템은 이벤트를 발행하여 배송 서비스와 배차 서비스에 알린다.
이벤트 발행은 주문 저장과 동일한 트랜잭션으로 처리되어 데이터 일관성을 보장한다.
실제 이벤트 전송은 별도 Worker가 비동기로 처리하며, 전송 실패 시 자동으로 재시도한다.

### 주문 상태

주문은 생성(CREATED), 배송완료(DELIVERED), 취소(CANCELLED)의 3가지 상태를 가진다.
생성된 주문은 배송완료 또는 취소 상태로 전이될 수 있다.
배송완료된 주문은 취소할 수 없고, 취소된 주문은 배송완료 처리할 수 없다.


---

## 📐 도메인 규칙

### 1. 주문번호 (OrderNumber)

**포맷 규칙:**
- 반드시 `"ORD-"`로 시작해야 함
- 예: `"ORD-20251005123045001"`

**검증:**
```java
OrderNumber orderNumber = OrderNumber.of("ORD-20251002-001"); // ✅ 성공
OrderNumber orderNumber = OrderNumber.of("ORDER-001");         // ❌ 예외
OrderNumber orderNumber = OrderNumber.of("ord-001");           // ❌ 예외 (소문자 불가)
```

**생성 규칙:**

주문번호는 **시스템이 자동 생성**하며, 사용자가 직접 입력할 수 없습니다.

**생성 형식:**
```
ORD-YYYYMMDDHHMMSS + 3자리 난수
```

- `ORD-`: 고정 접두사
- `YYYYMMDDHHMMSS`: 주문 생성 시점의 타임스탬프
  - `YYYY`: 연도 (예: 2025)
  - `MM`: 월 (01-12)
  - `DD`: 일 (01-31)
  - `HH`: 시 (00-23)
  - `MM`: 분 (00-59)
  - `SS`: 초 (00-59)
- `3자리 난수`: 000-999 사이의 랜덤 숫자 (동일 초 내 충돌 방지)

**예시:**
```
ORD-20251005123045001
ORD-20251005123045742
ORD-20251005143022156
```

**생성 담당:**
- `OrderNumberGenerator` (Domain Service)
- 주문 생성 시 `Order.create()` 내부에서 자동 호출

**사용 예:**
```java
// OrderNumberGenerator가 자동 생성
OrderNumberGenerator generator = new OrderNumberGenerator();
OrderNumber orderNumber = generator.generate();
// → "ORD-20251005123045001"
```

---

### 2. 주문 상태 (OrderStatus)

주문은 다음 3가지 상태를 가집니다:

| 상태 | 설명 | 전이 가능 상태 |
|------|------|----------------|
| **CREATED** | 생성 | DELIVERED, CANCELLED |
| **DELIVERED** | 배송완료 | (최종 상태) |
| **CANCELLED** | 취소 | (최종 상태) |

**상태 전이 규칙:**

```java
// CREATED → DELIVERED
Order order = Order.create(...);
order.markAsDelivered();  // ✅ 성공

// CREATED → CANCELLED
Order order = Order.create(...);
order.cancel();  // ✅ 성공

// DELIVERED → CANCELLED
Order deliveredOrder = ...;
deliveredOrder.cancel();  // ❌ 예외: "배송 완료된 주문은 취소할 수 없습니다"

// CANCELLED → DELIVERED
Order cancelledOrder = ...;
cancelledOrder.markAsDelivered();  // ❌ 예외: "취소된 주문은 배송 완료 처리할 수 없습니다"
```

---

### 3. 주문 생성

**팩토리 메서드:**
```java
OrderNumberGenerator orderNumberGenerator = new OrderNumberGenerator();

Order order = Order.create(
    orderNumberGenerator,    // orderNumberGenerator (필수) - 주문번호 자동 생성
    List.of(orderItems),     // items (선택, null 가능)
    origin,                  // origin (필수)
    destination,             // destination (필수)
    deliveryPolicy          // deliveryPolicy (필수)
);
```

**필수 값 검증:**
- `orderNumberGenerator`: null 불가 (주문번호 자동 생성을 위해)
- `origin`: null 불가
- `destination`: null 불가
- `deliveryPolicy`: null 불가
- `items`: null 가능 (빈 리스트로 초기화)

**주문번호 자동 생성:**
- 주문 생성 시 `OrderNumberGenerator`가 자동으로 주문번호 생성
- 사용자는 주문번호를 직접 지정할 수 없음
- 형식: `ORD-YYYYMMDDHHMMSS + 3자리 난수`

---

### 4. 주소 정제 (Address Refinement)

**개요:**

주문 생성 시, 사용자가 입력한 주소가 부정확할 수 있으므로 위/경도 좌표를 기반으로 **역지오코딩**하여 정확한 주소로 정제합니다.

**처리 시점:**
- 주문 생성 시 (`OrderFacade.createOrder()`)
- Origin (출발지)와 Destination (도착지) 모두 정제

**역지오코딩 과정:**
```java
// OrderFacade에서 주소 정제
public Order createOrder(CreateOrderCommand command) {
    // 1. Origin 주소 정제 (역지오코딩)
    Origin refinedOrigin = refineOriginAddress(command.origin());
    
    // 2. Destination 주소 정제 (역지오코딩)
    Destination refinedDestination = refineDestinationAddress(command.destination());
    
    // 3. 정제된 주소로 Order 생성
    return orderCreator.create(items, refinedOrigin, refinedDestination, deliveryPolicy);
}
```

**Fallback Chain:**

역지오코딩 서비스는 장애에 대비하여 **3단계 Fallback Chain**을 구성합니다:

1. **1순위: Neogeo** (내부 서비스)
2. **2순위: Naver** (외부 서비스)
3. **3순위: Kakao** (외부 서비스)

각 서비스가 실패하면 자동으로 다음 서비스로 Fallback합니다.

**Fallback 조건:**
- HTTP 4xx, 5xx 에러
- Timeout (기본 3초)
- 네트워크 에러

**설정 방법:**

```yaml
# application.yml
address:
  refinement:
    # Fallback 순서 (환경별로 변경 가능)
    fallback-order:
      - neogeo
      - naver
      - kakao
    
    neogeo:
      url: ${NEOGEO_URL:http://neogeo-service}
      timeout-ms: 3000
    
    naver:
      url: https://naveropenapi.apigw.ntruss.com
      client-id: ${NAVER_CLIENT_ID}
      client-secret: ${NAVER_CLIENT_SECRET}
      timeout-ms: 3000
    
    kakao:
      url: https://dapi.kakao.com
      api-key: ${KAKAO_API_KEY}
      timeout-ms: 3000
```

**예외 처리:**

모든 역지오코딩 서비스가 실패하면 `AddressRefineFailedException`이 발생하며, 주문 생성이 실패합니다.

```java
// 모든 Provider 실패 시
throw new AddressRefineFailedException("모든 역지오코딩 서비스가 실패했습니다");
```

**정제 결과:**

정제된 주소는 **원본 주소를 덮어쓰기**하며, 별도로 DB에 저장하지 않습니다. 로그에만 기록됩니다.

```
[주소정제] 시작: latLng=LatLng(37.5012, 127.0396), original=[도로명:서울시 강남구 테헤란로 123]
[주소정제] Provider 시도: provider=NEOGEO, latLng=LatLng(37.5012, 127.0396)
[주소정제] 실패: provider=NEOGEO, error=Neogeo API 미구현 (Stub)
[주소정제] Provider 시도: provider=NAVER, latLng=LatLng(37.5012, 127.0396)
[주소정제] 성공: provider=NAVER, original=[도로명:서울시 강남구 테헤란로 123] → refined=[도로명:서울특별시 강남구 테헤란로 123]
```

---

### 5. 배송 정책 (DeliveryPolicy)

배송과 관련된 다양한 정책을 정의합니다.

**구성 요소:**
```java
DeliveryPolicy policy = new DeliveryPolicy(
    true,                           // alcoholDelivery (주류 배송)
    false,                          // contactlessDelivery (비대면 배송)
    true,                           // reservedDelivery (예약 배송)
    Instant.parse("2025-10-02T15:00:00Z"),  // reservedDeliveryStartTime
    Instant.parse("2025-10-02T14:30:00Z")   // pickupRequestTime
);
```

---

### 6. 위치 정보

#### Origin (출발지)
```java
Origin origin = new Origin(
    new Contact("홍길동", "010-1234-5678"),
    new Address("서울시 강남구 테헤란로 123", "서울시 강남구 테헤란로 123", "10층"),
    new LatLng(new BigDecimal("37.5012"), new BigDecimal("127.0396"))
);
```

#### Destination (도착지)
```java
Destination destination = new Destination(
    new Contact("김철수", "010-9876-5432"),
    new Address("서울시 강남구 역삼동 456", "서울시 강남구 역삼동 456", "5층"),
    new LatLng(new BigDecimal("37.5008"), new BigDecimal("127.0382")),
    new EntranceInfo("1234", "빠른 배송 부탁드려요")
);
```

---

### 7. 주문 아이템 (OrderItem)

개별 주문 상품의 정보를 담습니다.

```java
OrderItem item = new OrderItem(
    "맥주 24캔",                          // itemName
    2,                                   // quantity
    new Money(new BigDecimal("30000")),  // price
    "주류",                               // category
    new Weight(new BigDecimal("10.5")),  // weight (optional)
    new Volume(new BigDecimal("0.5"))    // volume (optional)
);

// 총 금액: 60000원 (30000 × 2)
```

---

### 8. 이벤트 발행

주문이 생성되면 `OrderCreatedEvent`가 자동으로 발행됩니다.

**발행 흐름:**
```java
// OrderCreator (Domain Service)
public Order create(...) {
    // 1. Order 저장
    Order order = orderRepository.store(...);
    
    // 2. Outbox 저장 (같은 트랜잭션)
    outboxEventAppender.append(OutboxEventType.ORDER_CREATED, order);
    
    return order;
}

// 3. Kafka 이벤트 발행 (비동기, Outbox Worker)
// Topic: order.order.created
```

**특징:**
- Order 저장과 Outbox 저장은 동일한 트랜잭션으로 처리
- 실제 Kafka 전송은 별도 Worker가 비동기로 처리
- 전송 실패 시 자동으로 재시도

---

## 📌 Value Object 불변 원칙

Value Object는 생성 후 값을 변경할 수 없습니다:
- `OrderNumber`
- `Money`
- `Weight`
- `Volume`
- `Address`
- `Contact`
- `LatLng`
- `EntranceInfo`
- `OrderItem`
- `Origin`
- `Destination`
- `DeliveryPolicy`

**규칙:**
- 한 번 생성된 Value Object는 수정 불가
- 새로운 값이 필요하면 새로운 객체를 생성
- 예: 금액 10,000원 + 10,000원 = 새로운 20,000원 객체
