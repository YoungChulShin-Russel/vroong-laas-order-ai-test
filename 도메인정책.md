# 부릉 오더 서비스 - 도메인 정책

## 📋 개요

부릉 오더 서비스는 주문을 받아 배송 및 배차 서비스가 활용할 수 있도록 이벤트를 발행하는 서비스입니다.

---

## 🎯 핵심 도메인 모델

### Order (주문)

주문의 생명주기를 관리하는 Aggregate Root입니다.

#### 필수 속성
- **주문번호 (OrderNumber)**: 주문을 고유하게 식별
- **출발지 (Origin)**: 상품 픽업 위치
- **도착지 (Destination)**: 배송 목적지
- **배송 정책 (DeliveryPolicy)**: 배송 관련 설정 (주류 배송, 비대면 배송 등)

#### 선택 속성
- **주문 아이템 (OrderItem)**: 주문 상품 목록 (없을 수 있음)

---

## 📐 도메인 규칙

### 1. 주문번호 (OrderNumber)

**포맷 규칙:**
- 반드시 `"ORD-"`로 시작해야 함
- 예: `"ORD-20251002-001"`

**검증:**
```java
OrderNumber orderNumber = OrderNumber.of("ORD-20251002-001"); // ✅ 성공
OrderNumber orderNumber = OrderNumber.of("ORDER-001");         // ❌ 예외
OrderNumber orderNumber = OrderNumber.of("ord-001");           // ❌ 예외 (소문자 불가)
```

---

### 2. 주문 상태 (OrderStatus)

주문은 다음 3가지 상태를 가집니다:

| 상태 | 설명 | 전이 가능 상태 |
|------|------|----------------|
| **CREATED** | 생성 | DELIVERED, CANCELLED |
| **DELIVERED** | 배송완료 | (최종 상태) |
| **CANCELLED** | 취소 | (최종 상태) |

**상태 전이 규칙:**

```java
// CREATED → DELIVERED
Order order = Order.create(...);
order.markAsDelivered();  // ✅ 성공

// CREATED → CANCELLED
Order order = Order.create(...);
order.cancel();  // ✅ 성공

// DELIVERED → CANCELLED
Order deliveredOrder = ...;
deliveredOrder.cancel();  // ❌ 예외: "배송 완료된 주문은 취소할 수 없습니다"

// CANCELLED → DELIVERED
Order cancelledOrder = ...;
cancelledOrder.markAsDelivered();  // ❌ 예외: "취소된 주문은 배송 완료 처리할 수 없습니다"
```

---

### 3. 주문 생성

**팩토리 메서드:**
```java
Order order = Order.create(
    "ORD-20251002-001",      // orderNumber (필수)
    List.of(orderItems),     // items (선택, null 가능)
    origin,                  // origin (필수)
    destination,             // destination (필수)
    deliveryPolicy          // deliveryPolicy (필수)
);
```

**필수 값 검증:**
- `orderNumber`: null 불가, "ORD-"로 시작
- `origin`: null 불가
- `destination`: null 불가
- `deliveryPolicy`: null 불가
- `items`: null 가능 (빈 리스트로 초기화)

---

### 4. 배송 정책 (DeliveryPolicy)

배송과 관련된 다양한 정책을 정의합니다.

**구성 요소:**
```java
DeliveryPolicy policy = new DeliveryPolicy(
    true,                           // alcoholDelivery (주류 배송)
    false,                          // contactlessDelivery (비대면 배송)
    true,                           // reservedDelivery (예약 배송)
    Instant.parse("2025-10-02T15:00:00Z"),  // reservedDeliveryStartTime
    Instant.parse("2025-10-02T14:30:00Z")   // pickupRequestTime
);
```

---

### 5. 위치 정보

#### Origin (출발지)
```java
Origin origin = new Origin(
    new Address("06234", "서울시 강남구 테헤란로 123", "10층"),
    new LatLng(new BigDecimal("37.5012"), new BigDecimal("127.0396")),
    new Contact("홍길동", "010-1234-5678")
);
```

#### Destination (도착지)
```java
Destination destination = new Destination(
    new Address("06234", "서울시 강남구 역삼동 456", "5층"),
    new LatLng(new BigDecimal("37.5008"), new BigDecimal("127.0382")),
    new Contact("김철수", "010-9876-5432"),
    new EntranceInfo("1234", "경비실 통과", "빠른 배송 부탁드려요")
);
```

---

### 6. 주문 아이템 (OrderItem)

개별 주문 상품의 정보를 담습니다.

```java
OrderItem item = new OrderItem(
    "맥주 24캔",                          // name
    2,                                   // quantity
    new Money(new BigDecimal("30000")),  // unitPrice
    "주류"                                // category
);

// 총 금액 계산
Money totalPrice = item.getTotalPrice();  // 60000원 (30000 × 2)
```

---

## 🔄 이벤트 기반 처리

### 배송 완료
- 배송 서비스로부터 배송 완료 이벤트를 수신
- `Order.markAsDelivered()` 호출
- 상태를 `DELIVERED`로 변경

### 주문 취소
- 고객 또는 시스템의 취소 요청
- `Order.cancel()` 호출
- 상태를 `CANCELLED`로 변경

---

## 💰 금액 계산

### 주문 총액
```java
Order order = ...;
Money totalAmount = order.calculateTotalAmount();
```

- 모든 OrderItem의 총액을 합산
- OrderItem이 없으면 `Money.zero()` 반환

---

## 📌 Value Object 불변 원칙

Value Object는 생성 후 값을 변경할 수 없습니다:
- `OrderNumber`
- `Money`
- `Address`
- `Contact`
- `LatLng`
- `EntranceInfo`
- `OrderItem`
- `Origin`
- `Destination`
- `DeliveryPolicy`

**규칙:**
- 한 번 생성된 Value Object는 수정 불가
- 새로운 값이 필요하면 새로운 객체를 생성
- 예: 금액 10,000원 + 10,000원 = 새로운 20,000원 객체

---

## 🚫 비즈니스 규칙 위반 사례

### 1. 잘못된 상태 전이
```
❌ 배송 완료된 주문을 취소
❌ 취소된 주문을 배송 완료 처리
❌ 주문번호 변경 시도
```

### 2. 필수 값 누락
```
❌ 출발지 없는 주문
❌ 도착지 없는 주문
❌ 배송 정책 없는 주문
❌ "ORD-"로 시작하지 않는 주문번호
```

### 3. Value Object 수정 시도
```
❌ 주문번호 변경
❌ 금액 직접 수정
❌ 주소 정보 변경
❌ 연락처 정보 변경
```

**올바른 방법:** 새로운 주문을 생성하거나, 허용된 비즈니스 메서드 사용
